@model IList<PedidosSSCC.ViewModels.LogEntryViewModel>

@using System
@using System.Globalization

@model List<string>

@{
    var fechasDisponibles = ViewBag.Fechas as List<string> ?? new List<string>();
    string fechaSeleccionada = ViewBag.FechaSeleccionada as string;
    string errorLectura = ViewBag.ErrorLecturaLogs as string;
    bool sinLogs = ViewBag.SinLogs is bool flag && flag;
    bool hayErrores = Model != null && Model.Count > 0;
}

<div class="container text-center mt-5">
    <h2>
        <i class="bi bi-emoji-frown text-danger"></i> Registro de Errores
    </h2>
    <p class="text-muted">Parece que algunos bugs han decidido hacer de las suyas</p>

    @if (!string.IsNullOrEmpty(errorLectura))
    {
        <div class="alert alert-danger" role="alert">
            @errorLectura
        </div>
    }
    else if (sinLogs)
    {
        <div class="alert alert-info" role="alert">
            No hay errores registrados.
        </div>
    }
    else if (!hayErrores)
    {
        <div class="alert alert-warning" role="alert">
            No se pudieron cargar los registros de error.
        </div>
    }
    else
    {
        <div class="container mt-4">
            <form method="get" class="form-inline mb-3">
                <label for="fecha" class="me-2">Filtrar por fecha:</label>
                <select name="fecha" id="fecha" class="form-select w-auto d-inline-block me-2" onchange="this.form.submit()">
                    <option value="">Todas</option>
                    @foreach (var fecha in fechasDisponibles)
                    {
                        var fechaFormateada = fecha;
                        if (DateTime.TryParseExact(fecha, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var fechaConvertida))
                        {
                            fechaFormateada = fechaConvertida.ToString("dd/MM/yyyy");
                        }

                        <option value="@fecha" @(fecha == fechaSeleccionada ? "selected" : "")>
                            @fechaFormateada
                        </option>
                    }
                </select>
            </form>
        </div>

        <div class="row justify-content-center">
            <table class="table table-bordered">
                <thead class="table-danger">
                    <tr>
                        <th><i class="bi"></i>Tipo</th>
                        <th><i class="bi bi-calendar-event"></i> Fecha</th>
                        <th><i class="bi bi-bug"></i> Mensaje de Error</th>
                        <th><i class="bi bi-globe"></i> URL</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var log in Model)
                    @foreach (var error in Model)
                    {
                        bool mostrarUrl = !string.IsNullOrWhiteSpace(log.Url) && log.Url != "-";
                        Uri urlResultado;
                        bool urlValida = mostrarUrl && Uri.TryCreate(log.Url, UriKind.Absolute, out urlResultado);

                        <tr>
                            <td><i class="bi @log.IconClass"></i> @log.Level</td>
                            <td>@log.DisplayTimestamp</td>
                            <td>
                                <span class="mensaje-truncado" title="@log.FullMessage">@log.Message</span>
                            </td>
                            <td>
                                @if (urlValida)
                                {
                                    <a href="@log.Url" target="_blank" rel="noopener">@log.Url</a>
                                }
                                else
                                {
                                    @(mostrarUrl ? log.Url : "-")
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
    .mensaje-truncado {
        max-width: 500px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        vertical-align: top;
    }
</style>
<script>
    $(document).ready(function () {
        $(".breadcrumb-container").hide();
        $('#contenidoPagina').fadeIn(); // Mostrar contenido tras verificaci√≥n
        ocultarDivCargando();
    });
</script>
