function verTarifas(n){const t=JSON.parse(n.getAttribute("data-licencia"));$("#idLicenciaTarifas").val(t.LIC_Id);ObtenerTarifas(t.LIC_Id);limpiarFormularioTarifa();$("#formTarifas").hide();$("#modalTarifas").modal("show");$("#btnNuevaTarifa").show()}function verExcepciones(n){let t=JSON.parse(n.getAttribute("data-licencia"));limpiarFormularioExcepcion();InicializarSelectLicenciasReemplazo();ObtenerExcepciones(t.LIC_Id);$("#idLicenciaExcepciones").val(t.LIC_Id);$("#modalExcepciones").modal("show")}function limpiarFormularioTarifa(){$("#fechaInicio, #fechaFin").val("").prop("disabled",!1);$("#precioUnitarioSW, #precioUnitarioAntivirus, #precioUnitarioBackup").val("");$("#formTarifas").hide();$("#btnGuardarTarifa").hide()}function limpiarFormularioExcepcion(){$("#idEmpresaOriginal").val("");$("#licenciasReemplazo").val(null).trigger("change");$("#licenciasReemplazo").prop("disabled",!0);limpiarCampos(["#empresa","#correcion"])}function ObtenerTarifas(n){let t=inicializarDataTable("#tableTarifas",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerTarifas,type:"GET",dataSrc:function(n){return n},data:{licenciaId:n},dataType:"json"},rowId:function(n){return`fila-${n.LIT_LIC_Id}-${n.LIT_FechaInicio?.substring(0,10)}`},columns:[{data:"LIT_FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"LIT_FechaFin",title:"Fecha Fin",render:formatDateToDDMMYYYY},{data:"LIT_PrecioUnitarioSW",title:"Importe SW",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{data:"LIT_PrecioUnitarioAntivirus",title:"Importe AV",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{data:"LIT_PrecioUnitarioBackup",title:"Importe BK",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){return`
                        <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
                            data-tarifa="${JSON.stringify(i).replace(/"/g,"&quot;")}" onclick="eliminarTarifa(this)">
                            <i class="bi bi-trash" title="Eliminar"></i>
                        </button>`}}]},[],"export_tarifas");$(window).resize(function(){t.columns.adjust().draw()})}function ObtenerExcepciones(n){let t=inicializarDataTable("#tableExcepciones",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerExcepciones,type:"GET",dataSrc:"",data:{licenciaId:n},dataType:"json"},rowId:function(n){return`fila-${n.LIE_LIC_Id}-${n.LIE_EMP_Id}`},columns:[{data:"EmpresaNombre",title:"Empresa"},{data:"LIE_CorreccionFacturacion",title:"Corrección Facturación"},{data:"LicenciasReemplazoNombres",title:"Licencias Reemplazo",render:function(n){return n?Array.isArray(n)?n.join(", "):n:""}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){return`
                            <button type="button" class="btn btn-icon btn-editar btn-outline-secondary"
                                data-excepcion="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                onclick="editarExcepcion(this)">
                                <i class="bi bi-pencil-square" title="Editar"></i>
                            </button>
                            <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
                                data-excepcion="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                onclick="eliminarExcepcion(this)">
                                <i class="bi bi-trash" title="Eliminar"></i>
                            </button>`}}]},[],"export_excepciones");$(window).resize(function(){t.columns.adjust().draw()})}function editarLicencia(n){let t=JSON.parse(n.getAttribute("data-licencia"));$("#idLicencia").val(t.LIC_Id);$("#nombre").val(t.LIC_Nombre);$("#grupo").val(t.LIC_MaximoGrupo);$("#padre").val(t.LIC_LIC_Id_Padre);$("#tareaSW").val(t.LIC_TAR_Id_SW||"");$("#tareaAntivirus").val(t.LIC_TAR_Id_Antivirus||"");$("#tareaBackup").val(t.LIC_TAR_Id_Backup||"");$("#nombreMS").val(t.LIC_NombreMS||"");$("#gestionado").prop("checked",t.LIC_Gestionado===!0);$("#modalEditarLabel").text("Editar Licencia");$("#modalEditar").modal("show");InicializarSelectTiposEnte();cargarComboTiposEnte(t.LIC_Id);InicializarSelectLicenciasIncompatibles();cargarComboLicenciasIncompatibles(t.LIC_Id);const i=t.LIC_LIC_Id_Padre!=null;$("#licenciasIncompatibles").prop("disabled",i);$("#tiposEnte").prop("disabled",i)}function editarTarifa(n){let t=JSON.parse(n.getAttribute("data-tarifa"));$("#fechaInicio").val(formatDateInputForDateField(t.LIT_FechaInicio)).prop("disabled",!0);$("#fechaFin").val(formatDateInputForDateField(t.LIT_FechaFin)).prop("disabled",!1);$("#precioUnitarioSW").val(t.LIT_PrecioUnitarioSW!=null?t.LIT_PrecioUnitarioSW.toString().replace(".",","):"");$("#precioUnitarioAntivirus").val(t.LIT_PrecioUnitarioAntivirus!=null?t.LIT_PrecioUnitarioAntivirus.toString().replace(".",","):"");$("#precioUnitarioBackup").val(t.LIT_PrecioUnitarioBackup!=null?t.LIT_PrecioUnitarioBackup.toString().replace(".",","):"");$("#btnNuevaTarifa").hide();$("#btnCancelarTarifa").show();$("#btnGuardarTarifa").show();$("#formTarifas").slideDown()}function editarExcepcion(n){let t=JSON.parse(n.getAttribute("data-excepcion"));$("#licenciasReemplazo").prop("disabled",!1);InicializarSelectLicenciasReemplazo();cargarComboLicenciasReemplazo(t.LIE_LIC_Id,t.LIE_EMP_Id);$("#idLicenciaExcepciones").val(t.LIE_LIC_Id);$("#idEmpresaOriginal").val(t.LIE_EMP_Id);$("#empresa").val(t.LIE_EMP_Id);$("#correcion").val(t.LIE_CorreccionFacturacion.toString().replace(".",","))}function editarLineaEsfuerzo(n){const t=JSON.parse(n.getAttribute("data-esfuerzo"));$("#idConceptoEditar").val(t.LEE_Id);$("#empresaEsfuerzo").val(t.LEE_EMP_Id);$("#anyoEsfuerzo").val(t.LEE_Anyo);$("#mesEsfuerzo").val(t.LEE_Mes);$("#unidadesEsfuerzo").val(t.LEE_Unidades);$("#importeUnitarioEsfuerzo").val(t.LEE_ImporteUnitario)}function editarPedidoEsfuerzo(n){const t=JSON.parse(n.getAttribute("data-pedido"));$("#fleId").val(t.FLE_Id);$("#pedidoEsfuerzo").val(t.FLE_FAC_Id)}async function guardarLicencia(){let t=obtenerTiposEnteSeleccionados(),i=obtenerLicenciasIncompatiblesSeleccionados(),r={LIC_Id:$("#idLicencia").val(),LIC_Nombre:$("#nombre").val(),LIC_NombreMS:$("#nombreMS").val(),LIC_MaximoGrupo:$("#grupo").val(),LIC_LIC_Id_Padre:$("#padre").val(),LIC_TAR_Id_SW:$("#tareaSW").val(),LIC_TAR_Id_Antivirus:$("#tareaAntivirus").val(),LIC_TAR_Id_Backup:$("#tareaBackup").val(),TiposEnte:t,LicenciasIncompatibles:i,LIC_Gestionado:$("#gestionado").is(":checked")};try{const n=await $.ajax({url:AppConfig.urls.guardarLicencia,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(r),dataType:"json"});n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalEditar").modal("hide"),$("#table").DataTable().ajax.reload(null,!1)):registrarErrorjQuery(n.status,n.message)}catch(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}}function eliminarLicencia(n){let t=JSON.parse(n.getAttribute("data-licencia")),i={LIC_Id:t.LIC_Id,LIC_Nombre:t.LIC_Nombre,LIC_MaximoGrupo:t.LIC_MaximoGrupo,LIC_LIC_Id_Padre:t.LIC_LIC_Id_Padre};mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar la licencia '${i.LIC_Nombre}'?`,onConfirmar:function(){$.ajax({url:AppConfig.urls.eliminarLicencia,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(i),dataType:"json"}).done(function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);let n=$("#table").DataTable();n.ajax.reload(null,!1)}else registrarErrorjQuery(n.status,n.message)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})}})}function eliminarTarifa(n){setTimeout(()=>{let t=JSON.parse(n.getAttribute("data-tarifa"));const i=formatDateInputForDateField(t.LIT_FechaInicio);mostrarAlertaConfirmacion({titulo:`¿Eliminar tarifa con fecha de inicio ${formatDateToDDMMYYYY(i)}?`,backdrop:!1,onConfirmar:function(){$.ajax({url:AppConfig.urls.EliminarTarifa,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idLicencia:t.LIT_LIC_Id,fechaInicio:toISODate(t.LIT_FechaInicio)}),dataType:"json"}).done(function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);let n=$("#tableTarifas").DataTable();n.ajax.reload(null,!1)}else registrarErrorjQuery(n.status,n.message)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})}})},300)}function eliminarExcepcion(n){setTimeout(()=>{let t=JSON.parse(n.getAttribute("data-excepcion"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar la excepción de '${t.EmpresaNombre}'?`,backdrop:!1,onConfirmar:function(){$.ajax({url:AppConfig.urls.EliminarExcepcion,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idLicencia:t.LIE_LIC_Id,idEmpresa:t.LIE_EMP_Id}),dataType:"json"}).done(function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);let n=$("#tableExcepciones").DataTable();n.ajax.reload(null,!1)}else registrarErrorjQuery(n.status,n.message)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})}})},300)}function InicializarSelectTiposEnte(){if(!$.fn.select2){console.error("Select2 no está disponible");return}let n=$("#tiposEnte");if(n.length===0){console.error("El select #tiposEnte no está en el DOM");return}n.select2({placeholder:"",allowClear:!0,multiple:!0,dropdownParent:$("#modalEditar"),width:"100%"})}function InicializarSelectLicenciasIncompatibles(){if(!$.fn.select2){console.error("Select2 no está disponible");return}let n=$("#licenciasIncompatibles");if(n.length===0){console.error("El select #licenciasIncompatibles no está en el DOM");return}n.select2({placeholder:"",allowClear:!0,multiple:!0,dropdownParent:$("#modalEditar"),width:"100%"})}async function cargarComboTiposEnte(n){try{const i=await fetch(`${AppConfig.urls.ObtenerComboTiposEnte}?idLicencia=${n}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),r=await i.json(),t=$("#tiposEnte");t.empty();r.forEach(n=>{const i=new Option(n.text,n.id,n.selected,n.selected);t.append(i)});t.trigger("change")}catch(t){registrarErrorjQuery("fetch",t.message)}}async function cargarComboLicenciasIncompatibles(n){try{const i=await fetch(`${AppConfig.urls.ObtenerLicenciasIncompatiblesCombo}?idLicencia=${n}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),r=await i.json(),t=$("#licenciasIncompatibles");t.empty();r.forEach(n=>{const i=new Option(n.text,n.id,n.selected,n.selected);t.append(i)});t.trigger("change")}catch(t){registrarErrorjQuery("fetch",t.message)}}function obtenerTiposEnteSeleccionados(){return $("#tiposEnte").val()}function obtenerLicenciasIncompatiblesSeleccionados(){return $("#licenciasIncompatibles").val()}function InicializarSelectLicenciasReemplazo(){if(!$.fn.select2){console.error("Select2 no está disponible");return}let n=$("#licenciasReemplazo");if(n.length===0){console.error("El select #licenciasReemplazo no está en el DOM");return}n.select2({placeholder:"Seleccione licencias...",allowClear:!0,multiple:!0,dropdownParent:$("#modalExcepciones"),width:"100%"})}async function cargarComboLicenciasReemplazo(n,t){try{const u=await fetch(`${AppConfig.urls.ObtenerComboLicenciasReemplazo}?idLicencia=${n}&idEmpresa=${t}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),r=await u.json(),i=$("#licenciasReemplazo");i.empty();r.forEach(n=>{const t=new Option(n.text,n.id,!1,!1);i.append(t)});const f=r.filter(n=>n.selected).map(n=>n.id);i.val(f).trigger("change")}catch(i){registrarErrorjQuery("fetch",i.message)}}function obtenerLicenciasReemplazoSeleccionadas(){return $("#licenciasReemplazo").val()}function verEntesLicencias(n){const t=JSON.parse(n.getAttribute("data-licencia"));$("#idLicenciaEntes").val(t.LIC_Id);limpiarFormularioEntes();$("#formEntesLicencias").hide();$("#btnGuardarEnteLicencia").hide();$("#btnCancelarEnte").hide();$("#btnNuevoEnte").show();cargarComboEntes();ObtenerEntesLicencias(t.LIC_Id);$("#modalEntesLicencias").modal("show")}async function cargarComboEntes(){try{const n=await $.ajax({url:AppConfig.urls.ObtenerEntidadesCombo,type:"GET",dataType:"json"}),t=$("#selectEnte").empty().append('<option value="">Seleccione…<\/option>');n.forEach(n=>t.append(`<option value="${n.ENT_Id}">${n.ENT_Nombre}</option>`))}catch(n){console.error(n)}}function ObtenerEntesLicencias(n){$.fn.dataTable.isDataTable("#tableEntesLicencias")&&$("#tableEntesLicencias").DataTable().destroy();const t=$("#tableEntesLicencias").DataTable({ajax:{url:AppConfig.urls.ObtenerEntesLicencias,type:"GET",data:{idLicencia:n},dataSrc:""},columns:[{data:"NombreEntidad",title:"Entidad"},{data:"EmpresaNombre",title:"Empresa"},{data:"FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"FechaFin",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',orderable:!1,render:(n,t,i)=>`
                                  <button class="btn btn-icon btn-eliminar btn-outline-secondary"
                                          data-ente="${JSON.stringify(i)}"
                                          onclick="eliminarEnteLicencia(this)">
                                    <i class="bi bi-trash" title="Eliminar"></i>
                                  </button>`}],paging:!1,searching:!0,info:!1,ordering:!1,dom:"Bt",buttons:[{extend:"excelHtml5",text:"Exportar a Excel",titleAttr:"Exportar a Excel",className:"btn btn-sm btn-success",title:`EntesLicencia_${(new Date).toISOString().slice(0,10)}`,exportOptions:{columns:[0,1,2]}}]});t.buttons().container().appendTo("#toolbarEntesButtons");$(window).off("resize.dtEntes").on("resize.dtEntes",()=>t.columns.adjust().draw())}function limpiarFormularioEntes(){$("#selectEnte").val("");$("#fechaInicioEnte").val("")}function eliminarEnteLicencia(n){const t=JSON.parse(n.getAttribute("data-ente"));mostrarAlertaConfirmacion({titulo:`¿Eliminar asociación con ${t.NombreEntidad}?`,onConfirmar:async()=>{try{const n=await $.ajax({url:AppConfig.urls.EliminarEnteLicencia,method:"POST",contentType:"application/json",data:JSON.stringify({idEnte:t.EntidadId,idEnteLicencia:t.LicenciaId,fechaInicio:t.FechaInicio}),dataType:"json"});n.success?(mostrarToast("Eliminado",TipoToast.Success),$("#tableEntesLicencias").DataTable().ajax.reload(null,!1)):mostrarToast(n.message||"Error al eliminar",TipoToast.Error)}catch(n){console.error(n)}}})}function limpiarFormularioEntes(){$("#selectEnte").val("");$("#fechaInicioEnte").val("");$("#fechaFinEnte").val("")}const cancelarTarifa=async()=>{$("#btnNuevaTarifa").show(),$("#btnCancelarTarifa").hide(),$("#btnGuardarTarifa").hide(),$("#formTarifas").hide()},guardarExcepcion=async()=>{let t=$("#idLicenciaExcepciones").val(),i=$("#idEmpresaOriginal").val(),r=$("#empresa").val(),u=$("#correcion").val(),f=obtenerLicenciasReemplazoSeleccionadas(),n=[];if(validarCampo("#empresa","Empresa",n),validarCampo("#correcion","Correción",n),n.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}let e={LIE_LIC_Id:t,LIE_EMP_Id_Original:i?i:null,LIE_EMP_Id:r,LIE_CorreccionFacturacion:u,LicenciasReemplazo:f};const o=await $.ajax({url:AppConfig.urls.GuardarExcepcion,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),dataType:"json"});if(o.success){limpiarFormularioExcepcion();mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);const n=`fila-${t}-${r}`;sessionStorage.setItem("ultimaFilaEditada",n);let i=$("#tableExcepciones").DataTable();i.ajax.reload(function(){resaltarFilaPorId(sessionStorage.getItem("ultimaFilaEditada"))},!1)}else limpiarFormularioExcepcion(),mostrarToast("Ya existe una excepción para esta empresa y licencia.",TipoToast.Warning)};