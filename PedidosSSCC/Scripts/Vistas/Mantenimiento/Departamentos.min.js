function editarDepartamento(n){resetCamposModal();let t=JSON.parse(n.getAttribute("data-departamento"));$("#idDepartamento").val(t.DEP_Id);$("#codigo").val(t.DEP_Codigo).prop("disabled",!1);$("#nombre").val(t.DEP_Nombre).prop("disabled",!1);$("#responsable").val(t.DEP_PER_Id_Responsable).prop("disabled",!1);$("#codigoD365").val(t.DEP_CodigoD365).prop("disabled",!1);$("#modalEditarLabel").text("Editar Departamento");$("#modalEditar").modal("show")}function resetCamposModal(){$("#codigo, #nombre, #responsable, #codigoD365").val("").prop("disabled",!1).removeClass("is-invalid")}function eliminarDepartamento(n){let t=JSON.parse(n.getAttribute("data-departamento"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el departamento '${t.DEP_Codigo}-${t.DEP_Nombre}'?`,onConfirmar:function(){$.ajax({url:AppConfig.urls.eliminarDepartamento,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idDepartamento:t.DEP_Id}),dataType:"json"}).done(function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);let n=$("#table").DataTable();n.ajax.reload(null,!1)}else registrarErrorjQuery(n.status,n.message)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})}})}const guardarDepartamentoAsync=async()=>{let t=$("#idDepartamento").val(),i=$("#codigo").val(),f=$("#nombre").val(),e=$("#responsable").val(),o=$("#codigoD365").val(),n=[];if(validarCampo("#codigo","Código",n),validarCampo("#nombre","Nombre",n),validarCampo("#responsable","Responsable",n),validarCampo("#codigoD365","Código D365",n),n.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}let s=$("#table").DataTable(),r=!1;if(s.rows().every(function(){let n=this.data();if(n.DEP_Id!=t&&n.DEP_Codigo.toLowerCase()===i.toLowerCase())return r=!0,!1}),r){$("#codigo").addClass("is-invalid");mostrarToast("El código ya existe en el sistema.",TipoToast.Error);return}$("#codigo").removeClass("is-invalid");let h={DEP_Id:t,DEP_Codigo:i,DEP_Nombre:f,DEP_PER_Id_Responsable:e,DEP_CodigoD365:o};try{const n=await $.ajax({url:AppConfig.urls.guardarDepartamento,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(h),dataType:"json"});if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);$("#modalEditar").modal("hide");let n=$("#table").DataTable();n.ajax.reload(null,!1)}else registrarErrorjQuery(n.status,n.message)}catch(u){const n=obtenerMensajeErrorAjax(u);registrarErrorjQuery(u.status||500,n)}};$(document).ready(function(){function i(){return new Promise((n,t)=>{$.ajax({url:AppConfig.urls.obtenerPersonas,type:"GET",dataType:"json",success:function(t){let i=$("#responsable");i.empty();$.each(t,function(n,t){i.append('<option value="'+t.PER_Id+'">'+t.ApellidosNombre+"<\/option>")});n()},error:function(n){const i=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,i);t()}})})}function r(){let t=localStorage.getItem(n),i=!1;if(t){t=JSON.parse(t);$("#formBuscar").val(t.general);$("#filterCodigo").val(t.codigo||"");$("#filterNombre").val(t.nombre||"");$("#filterResponsable").val(t.responsable||"");$("#filterCodigoD365").val(t.codigoD365||"");let{...otrosFiltros}=t;i=Object.values(otrosFiltros).some(n=>n!==""&&n!==null&&n!==undefined)}u();setTimeout(function(){let n=$("#table").DataTable();t?.general&&n.search(t.general,!1,!1).draw()},200);i&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}function t(){let t=$("#formBuscar").val(),i=$("#filterCodigo").val(),r=$("#filterNombre").val(),u=$("#filterResponsable").val(),f=$("#filterCodigoD365").val(),e={general:t,codigo:i,nombre:r,responsable:u,codigoD365:f};localStorage.setItem(n,JSON.stringify(e))}function u(){let n=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.obtenerDepartamentos,type:"GET",dataSrc:""},columns:[{data:"DEP_Codigo",title:"Código"},{data:"DEP_Nombre",title:"Nombre"},{data:"NombreResponsable",title:"Responsable"},{data:"DEP_CodigoD365",title:"Código D365"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){return`
                                    <button type="button" class="btn btn-icon btn-editar btn-outline-secondary"
                                        data-departamento="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                        onclick="editarDepartamento(this)">
                                        <i class="bi bi-pencil-square" title="Editar"></i>
                                    </button>
                                    <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
                                            data-departamento="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                            onclick="eliminarDepartamento(this)">
                                        <i class="bi bi-trash" title="Eliminar"></i>
                                    </button>`}}]},[],"export_departamentos");$(window).resize(function(){n.columns.adjust().draw()});$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();n.responsive.rebuild();n.responsive.recalc();n.columns.adjust();n.draw(!1);t()})}let n="datatable_filters_tablaDepartamentos";VerificarSesionActiva(OpcionMenu.Departamentos).then(()=>{Promise.all([i()]).then(()=>{r()}).catch(n=>{console.error("Error al cargar los datos:",n)})});$("#btnNuevo").on("click",function(){$("#idDepartamento").val("-1");$("#codigo").val("").prop("disabled",!1);$("#nombre").val("").prop("disabled",!1);$("#responsable").val("").prop("disabled",!1);$("#codigoD365").val("").prop("disabled",!1);resetCamposModal();$("#modalEditarLabel").text("Agregar Departamento");$("#modalEditar").modal("show")});$("#btnBuscar").on("click",function(){let i=$("#filterCodigo").val(),r=$("#filterNombre").val(),u=$("#filterResponsable").val(),f=$("#filterCodigoD365").val(),n=$("#table").DataTable();n.columns(0).search(i).draw();n.columns(1).search(r).draw();n.columns(2).search(u).draw();n.columns(3).search(f).draw();t()})});