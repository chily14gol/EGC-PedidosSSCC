function editarUsuario(n,t,i,r,u){$("#usuarioOriginal").val(decodeURIComponent(n));$("#usuario").val(decodeURIComponent(n)).prop("disabled",!0);$("#nombrePersona").val(t).prop("disabled",!0);$("#email").val(i).prop("disabled",!0);$("#perfiles").val(r);$("#verTodo").prop("checked",u);$("#usuario").removeClass("is-invalid");$("#nombrePersona").removeClass("is-invalid");$("#email").removeClass("is-invalid");$("#perfiles").removeClass("is-invalid");$("#modalEditarLabel").text("Editar Usuario");$("#modalEditar").modal("show")}function eliminarUsuario(n){mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el usuario '${n}'?`,onConfirmar:function(){$.ajax({url:AppConfig.urls.eliminarUsuario,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idUsuario:decodeURIComponent(n)}),dataType:"json",success:function(n){if(n.success){mostrarToast("Usuario eliminado correctamente.",TipoToast.Success);let n=$("#table").DataTable();n.ajax.reload(null,!1)}else mostrarToast.error("No se puede eliminar el usuario. Tiene relaciones",TipoToast.Warning)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}})}async function guardarUsuario(){const n=decodeURIComponent($("#usuario").val().trim()),t=$("#nombrePersona").val(),i=$("#email").val().trim(),r=$("#perfiles").val(),e=$("#verTodo").is(":checked"),o=$("#usuarioOriginal").val().trim(),s=[{el:$("#usuario"),val:n},{el:$("#nombrePersona"),val:t},{el:$("#email"),val:i},{el:$("#perfiles"),val:r}];let u=!1;if(s.forEach(({el:n,val:t})=>{t?n.removeClass("is-invalid"):(n.addClass("is-invalid"),u=!0)}),u){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}if(!o){const t=$("#table").DataTable(),i=t.rows().data().toArray().some(t=>t.USU_Id.toLowerCase()===n.toLowerCase());if(i){$("#usuario").addClass("is-invalid");mostrarToast("El usuario ya existe en el sistema.",TipoToast.Error);return}}const h={usuario:{USU_Id:n,USU_PER_Id:t,USU_SPE_Id:r,USU_VerTodo:e},email:i};try{const n=await $.ajax({url:AppConfig.urls.guardarUsuario,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(h),dataType:"json"});n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalEditar").modal("hide"),$("#table").DataTable().ajax.reload(null,!1)):mostrarToast(n.message||"Error al guardar usuario.",TipoToast.Error)}catch(f){const n=obtenerMensajeErrorAjax(f);registrarErrorjQuery(f.status,n)}}$(document).ready(function(){function i(){return new Promise((n,t)=>{$.ajax({url:AppConfig.urls.obtenerPersonas,type:"GET",dataType:"json",success:function(t){let i=$("#nombrePersona");i.empty();i.append('<option value="">Seleccione una persona<\/option>');$.each(t,function(n,t){i.append(`<option value="${t.PER_Id}">${t.ApellidosNombre}</option>`)});n()},error:function(n){const i=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,i);t()}})})}function r(){$.ajax({"async":!1,type:"GET",contentType:"application/json; charset=utf-8",url:AppConfig.urls.obtenerPerfiles,dataType:"json",success:function(n){let t=$("#perfiles");t.empty();t.append('<option value="">Seleccione un perfil<\/option>');$.each(n,function(n,i){t.append('<option value="'+i.SPE_Id+'">'+i.SPE_Nombre+"<\/option>")})},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}function u(){let t=localStorage.getItem(n),i=!1;if(t){t=JSON.parse(t);$("#formBuscar").val(t.general);$("#filterUsuario").val(t.usuario||"");$("#filterPersona").val(t.persona||"");$("#filterPerfil").val(t.perfil||"");let{...otrosFiltros}=t;i=Object.values(otrosFiltros).some(n=>n!==""&&n!==null&&n!==undefined)}f();setTimeout(function(){let n=$("#table").DataTable();t?.general&&n.search(t.general,!1,!1).draw()},200);i&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}function t(){let t=$("#formBuscar").val(),i=$("#filterUsuario").val(),r=$("#filterPersona").val(),u=$("#filterPerfil").val(),f={general:t,usuario:i,persona:r,perfil:u};localStorage.setItem(n,JSON.stringify(f))}function f(){let n=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.obtenerUsuarios,type:"GET",dataSrc:""},columns:[{data:"USU_Id",title:"Usuario"},{data:"NombrePersona",title:"Persona"},{data:"Perfil",title:"Perfil"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){return`
                                                        <button type="button" class="btn btn-icon btn-editar btn-outline-secondary" onclick="editarUsuario('${i.USU_Id.replace(/\\/g,"\\\\")}', '${i.USU_PER_Id}', '${i.Email}', '${i.IdPerfil}', ${i.VerTodo})">
                                                            <i class="bi bi-pencil-square" title="Editar"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary" onclick="eliminarUsuario('${i.USU_Id.replace(/\\/g,"\\\\")}')">
                                                            <i class="bi bi-trash" title="Eliminar"></i>
                                                        </button>`}}]},[],"export_usuarios");$(window).resize(function(){n.columns.adjust().draw()});$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();n.responsive.rebuild();n.responsive.recalc();n.columns.adjust();n.draw(!1);t()})}let n=Filtros.Usuarios;VerificarSesionActiva(OpcionMenu.Usuarios).then(()=>{Promise.all([i(),r()]).then(()=>{u()}).catch(n=>{console.error("Error al cargar los datos:",n)})});$("#btnNuevo").on("click",function(){$("#usuarioOriginal").val("");$("#usuario").val("").prop("disabled",!1);$("#nombrePersona").val("").prop("disabled",!1);$("#email").val("").prop("disabled",!0);$("#perfiles").val("").prop("disabled",!1);$("#verTodo").prop("checked",!1);$("#usuario").removeClass("is-invalid");$("#nombrePersona").removeClass("is-invalid");$("#email").removeClass("is-invalid");$("#perfiles").removeClass("is-invalid");$("#modalEditarLabel").text("Agregar Usuario");$("#modalEditar").modal("show")});$("#nombrePersona").on("change",function(){let n=$(this).val();n&&$.ajax({url:AppConfig.urls.obtenerEmailPersona,type:"GET",data:{idPersona:n},success:function(n){$("#email").val(n)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})});$("#btnBuscar").on("click",function(){let i=$("#filterUsuario").val(),r=$("#filterPersona").val(),u=$("#filterPerfil").val(),n=$("#table").DataTable();n.columns(0).search(i).draw();n.columns(1).search(r).draw();n.columns(2).search(u).draw();t()})});