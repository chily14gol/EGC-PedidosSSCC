function abrirModalContrato(n){const t=JSON.parse(n.getAttribute("data-contrato"));cargarCombosTarifas(()=>{$("#idContrato").val(t.CCA_Id);const n=moment(t.CCA_FechaInicio).format("YYYY-MM-DD"),i=moment(t.CCA_FechaFin).format("YYYY-MM-DD");$("#fechaInicio").val(n);$("#fechaFin").val(i);$("#costeHoraF").val(t.CCA_CosteHoraF);$("#costeHoraD").val(t.CCA_CosteHoraD);$("#costeHoraG").val(t.CCA_CosteHoraG);$("#costeHoraS").val(t.CCA_CosteHoraS);$("#precioGuardia").val(t.CCA_PrecioGuardia);$("#tarifaF").val(t.CCA_TAR_Id_F);$("#tarifaD").val(t.CCA_TAR_Id_D);$("#tarifaG").val(t.CCA_TAR_Id_G);$("#tarifaS").val(t.CCA_TAR_Id_S);$("#modalEditar").modal("show")})}async function abrirModalExcluidas(n){const r=JSON.parse(n.getAttribute("data-contrato")),t=r.CCA_Id;$("#exCcaId").val(t);$("#modalExcluidasLabel").text(`Empresas excluidas de guardia`);try{mostrarDivCargando();const i=await $.ajax({url:AppConfig.urls.ObtenerEmpresasCombo,type:"GET",dataType:"json"}),n=await $.ajax({url:AppConfig.urls.ObtenerExcluidasGuardia,type:"GET",data:{ccaId:t},dataType:"json"}),r=new Set(n.map(n=>n.EMP_Id)),u=$("#selEmpresaExcluida").empty().append('<option value="">Seleccione empresa<\/option>');i.forEach(n=>{r.has(n.EMP_Id)||u.append(`<option value="${n.EMP_Id}">${n.EMP_Nombre}</option>`)});renderTablaExcluidas(n);$("#modalExcluidas").modal("show")}catch(i){const n=obtenerMensajeErrorAjax(i);registrarErrorjQuery(i.status,n)}finally{ocultarDivCargando()}}function renderTablaExcluidas(n){const t=$("#tableExcluidas tbody").empty();if(!n||!n.length){t.append(`<tr><td colspan="2" class="text-muted">No hay empresas excluidas para este contrato.</td></tr>`);return}n.forEach(n=>{const i=`
      <tr>
        <td>${n.EMP_Nombre}</td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger"
                  onclick="eliminarExcluida(${n.CEE_CCA_Id}, ${n.EMP_Id})">
            <i class="bi bi-x-circle"></i> Quitar
          </button>
        </td>
      </tr>`;t.append(i)})}function cargarCombosTarifas(n){const t=[Tipo.CANTIDAD_FIJA];$.ajax({url:AppConfig.urls.ObtenerTareasCombo,type:"GET",dataType:"json",data:{listaTiposTarea:t},traditional:!0,success:function(t){["#tarifaF","#tarifaD","#tarifaG","#tarifaS"].forEach(n=>{const i=$(n).empty().append('<option value="">Seleccione Tarea<\/option>');t.forEach(n=>{i.append(`<option value="${n.TAR_Id}">${n.TAR_Nombre}</option>`)})});n&&n()},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}async function eliminarContratoAjax(n){try{const t=await $.ajax({url:AppConfig.urls.EliminarContratoCAU,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idContrato:n}),dataType:"json"});t.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableContratosCAU").DataTable().ajax.reload(null,!1)):mostrarToast("No se puede eliminar el contrato.",TipoToast.Warning)}catch(t){registrarErrorjQuery(t.status||"",t.message||t)}}function eliminarContrato(n){const t=JSON.parse(n.getAttribute("data-contrato"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el contrato con ID '${t.CCA_Id}'?`,onConfirmar:()=>eliminarContratoAjax(t.CCA_Id)})}async function eliminarExcluida(n,t){try{mostrarDivCargando();const i=await $.ajax({url:AppConfig.urls.EliminarExcluidaGuardia,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({ccaId:parseInt(n),empId:parseInt(t)}),dataType:"json"});if(!i.success){mostrarToast(i.message||"No se pudo quitar la exclusión.",TipoToast.Warning);return}const r=await $.ajax({url:AppConfig.urls.ObtenerExcluidasGuardia,type:"GET",data:{ccaId:n},dataType:"json"});renderTablaExcluidas(r);const u=await $.ajax({url:AppConfig.urls.ObtenerEmpresasCombo,type:"GET",dataType:"json"}),f=new Set(r.map(n=>n.EMP_Id)),e=$("#selEmpresaExcluida").empty().append('<option value="">Seleccione empresa<\/option>');u.forEach(n=>{f.has(n.EMP_Id)||e.append(`<option value="${n.EMP_Id}">${n.EMP_Nombre}</option>`)});mostrarToast("Exclusión eliminada.",TipoToast.Success)}catch(i){const n=obtenerMensajeErrorAjax(i);registrarErrorjQuery(i.status,n)}finally{ocultarDivCargando()}}$(document).ready(function(){function t(){const t=localStorage.getItem(n);if(t){const n=JSON.parse(t);$("#formBuscar").val(n.general)}r()}function i(){const t={general:$("#formBuscar").val()};localStorage.setItem(n,JSON.stringify(t))}function r(){const n=inicializarDataTable("#tableContratosCAU",{ajax:{url:AppConfig.urls.ObtenerContratosCAU,type:"GET",dataSrc:""},columns:[{data:"CCA_FechaInicio",title:"Fecha Inicio",type:"date",render:function(n){if(!n)return"";let t=moment(n);return(t.isValid()||(t=moment(n,"DD/MM/YYYY HH:mm:ss")),!t.isValid())?n:`<span data-order="${t.unix()}">${t.format("DD/MM/YYYY")}</span>`}},{data:"CCA_FechaFin",title:"Fecha Fin",type:"date",render:function(n){if(!n)return"";let t=moment(n);return(t.isValid()||(t=moment(n,"DD/MM/YYYY HH:mm:ss")),!t.isValid())?n:`<span data-order="${t.unix()}">${t.format("DD/MM/YYYY")}</span>`}},{data:"CCA_CosteHoraF",title:"Coste Hora F",className:"dt-type-numeric-with-decimal",render:formatMoney},{data:"CCA_CosteHoraD",title:"Coste Hora D",className:"dt-type-numeric-with-decimal",render:formatMoney},{data:"CCA_CosteHoraG",title:"Coste Hora G",className:"dt-type-numeric-with-decimal",render:formatMoney},{data:"CCA_CosteHoraS",title:"Coste Hora S",className:"dt-type-numeric-with-decimal",render:formatMoney},{data:"CCA_PrecioGuardia",title:"Precio Guardia",className:"dt-type-numeric-with-decimal",render:formatMoney},{className:"td-btn",data:null,orderable:!1,width:"160px",render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`<div class="btn-group" role="group">
                            <button type="button" class="btn btn-icon btn-outline-secondary me-2 btn-editar"
                                    data-contrato="${r}"
                                    onclick="abrirModalContrato(this)">
                              <i class="bi bi-pencil-square" title="Editar"></i>
                            </button>
                            <button type="button" class="btn btn-icon btn-outline-secondary me-2"
                                    data-contrato="${r}"
                                    onclick="abrirModalExcluidas(this)">
                              <i class="bi bi-building-dash" title="Excluir empresas de guardia"></i>
                            </button>
                            <button type="button" class="btn btn-icon btn-outline-secondary me-2 btn-eliminar"
                                    data-contrato="${r}"
                                    onclick="eliminarContrato(this)">
                              <i class="bi bi-trash" title="Eliminar"></i>
                            </button></div>`}}]},[],"export_contratos");$(window).resize(()=>n.columns.adjust().draw());$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();i()})}let n="datatable_filters_tableContratosCAU";VerificarSesionActiva(OpcionMenu.ContratosCAU).then(()=>{t()});$("#btnNuevo").on("click",function(){$("#idContrato").val("");$("#fechaInicio").val("");$("#fechaFin").val("");$("#costeHoraF").val("");$("#costeHoraD").val("");$("#costeHoraG").val("");$("#costeHoraS").val("");$("#precioGuardia").val("");cargarCombosTarifas(()=>{$("#modalEditar").modal("show")})});$("#btnGuardarContrato").on("click",function(n){n.preventDefault();const t=[{sel:"#fechaInicio",name:"Fecha Inicio"},{sel:"#fechaFin",name:"Fecha Fin"},{sel:"#costeHoraF",name:"Coste Hora Fuera de alcance"},{sel:"#costeHoraD",name:"Coste Hora Dentro de alcance"},{sel:"#costeHoraG",name:"Coste Hora Guardia "},{sel:"#costeHoraS",name:"Coste Hora Software "},{sel:"#precioGuardia",name:"Precio Guardia"},{sel:"#tarifaF",name:"Tarifa Fuera de alcance"},{sel:"#tarifaD",name:"Tarifa Dentro de alcance"},{sel:"#tarifaG",name:"Tarifa Guardia "},{sel:"#tarifaS",name:"Tarifa Software "}];t.forEach(n=>$(n.sel).removeClass("is-invalid"));const i=t.filter(n=>!$(n.sel).val()||$(n.sel).val().toString().trim()==="").map(n=>($(n.sel).addClass("is-invalid"),n.name));if(i.length){mostrarToast(`Los siguientes campos son obligatorios: ${i.join(", ")}`,TipoToast.Warning);return}const r={CCA_Id:$("#idContrato").val(),CCA_FechaInicio:$("#fechaInicio").val(),CCA_FechaFin:$("#fechaFin").val(),CCA_CosteHoraF:$("#costeHoraF").val().replace(".",","),CCA_CosteHoraD:$("#costeHoraD").val().replace(".",","),CCA_CosteHoraG:$("#costeHoraG").val().replace(".",","),CCA_CosteHoraS:$("#costeHoraS").val().replace(".",","),CCA_PrecioGuardia:$("#precioGuardia").val().replace(".",","),CCA_TAR_Id_F:$("#tarifaF").val(),CCA_TAR_Id_D:$("#tarifaD").val(),CCA_TAR_Id_G:$("#tarifaG").val(),CCA_TAR_Id_S:$("#tarifaS").val()};$.ajax({url:AppConfig.urls.GuardarContratoCAU,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(r),dataType:"json"}).done(function(n){n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalEditar").modal("hide"),$("#tableContratosCAU").DataTable().ajax.reload(null,!1)):mostrarToast("Error al guardar el contrato.",TipoToast.Error)}).fail(function(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))})});$("#btnAgregarExcluida").on("click",async function(){const t=$("#exCcaId").val(),n=$("#selEmpresaExcluida").val();if(!n){mostrarToast("Seleccione una empresa.",TipoToast.Warning);return}try{mostrarDivCargando();const i=await $.ajax({url:AppConfig.urls.AgregarExcluidaGuardia,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({ccaId:parseInt(t),empId:parseInt(n)}),dataType:"json"});if(!i.success){mostrarToast(i.message||"No se pudo añadir la exclusión.",TipoToast.Warning);return}const r=await $.ajax({url:AppConfig.urls.ObtenerExcluidasGuardia,type:"GET",data:{ccaId:t},dataType:"json"});renderTablaExcluidas(r);$(`#selEmpresaExcluida option[value="${n}"]`).remove();$("#selEmpresaExcluida").val("");mostrarToast("Empresa excluida de guardia añadida.",TipoToast.Success)}catch(i){const n=obtenerMensajeErrorAjax(i);registrarErrorjQuery(i.status,n)}finally{ocultarDivCargando()}})});