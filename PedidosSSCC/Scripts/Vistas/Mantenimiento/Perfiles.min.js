async function abrirModalPerfil(n,t){$("#modalEditar").data("idPerfil",n);$("#nombrePerfil").val(t);await CargarArbolPermisos(n,!1);$("#modalEditar").modal("show")}function prepararDataTree(n,t,i=false){const r=new Set;return n.forEach(n=>{const t=n.SPO_SOP_Id.includes(".")?n.SPO_SOP_Id.substring(0,n.SPO_SOP_Id.lastIndexOf(".")):null;t&&r.add(t)}),n.map(n=>{const u=n.SPO_SOP_Id.trim(),o=u.split(".").length-1,s="&nbsp;".repeat(o*4),f=n.SPO_SPE_Id!==0,e=r.has(u),h=i?!1:t?f&&!e:f&&n.SPO_Escritura===!0&&!e;return{id:u,parent:u.includes(".")?u.substring(0,u.lastIndexOf(".")):"#",text:s+n.SOI_Nombre,data:{SPO_SOP_Id:u},state:{selected:h,opened:!0}}})}async function CargarArbolPermisos(n,t){mostrarDivCargando();try{const i=await $.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:AppConfig.urls.ObtenerPermisos,data:{idPerfil:n},dataType:"json"});let r=prepararDataTree(structuredClone(i),!0,t),u=prepararDataTree(structuredClone(i),!1,t);$("#tree-container-acceso").jstree("destroy").empty().jstree({core:{data:r},plugins:["checkbox"],checkbox:{keep_selected_style:!1,three_state:!0,cascade:"up"}});$("#tree-container-edicion").jstree("destroy").empty().jstree({core:{data:u},plugins:["checkbox"],checkbox:{keep_selected_style:!1,three_state:!0,cascade:"up"}});ocultarDivCargando()}catch(i){ocultarDivCargando();registrarErrorjQuery(i.statusText,i.message)}}function eliminarPerfil(n){const i=document.querySelector('#antiForgeryContainer input[name="__RequestVerificationToken"]')?.value;let t=JSON.parse(n.getAttribute("data-perfil"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el perfil '${t.SPE_Nombre}'?`,onConfirmar:function(){$.ajax({url:AppConfig.urls.EliminarPerfil,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idPerfil:t.SPE_Id}),dataType:"json"}).done(function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);let n=$("#table").DataTable();n.ajax.reload(null,!1)}else mostrarToast("No se puede eliminar por que hay usuarios con el perfil.",TipoToast.Warning)}).fail(function(n,t,i){registrarErrorjQuery(t,i)})}})}$(document).ready(function(){function t(){let n=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.ObtenerPerfiles,type:"GET",dataSrc:""},columns:[{data:"SPE_Nombre",title:"Nombre"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){return`
                                    <button type="button" class="btn btn-icon btn-editar btn-outline-secondary" onclick="abrirModalPerfil(${i.SPE_Id}, '${i.SPE_Nombre}')">
                                        <i class="bi bi-pencil-square" title="Editar"></i>
                                    </button>
                                    <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
                                        data-perfil="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                        onclick="eliminarPerfil(this)">
                                        <i class="bi bi-trash" title="Eliminar"></i>
                                    </button>`}}]},[],"export_perfiles");$(window).resize(function(){n.columns.adjust().draw()});$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();n.responsive.rebuild();n.responsive.recalc();n.columns.adjust();n.draw(!1);guardarFiltros()})}function n(n){function u(n){const u=n.data?.SPO_SOP_Id||n.id;t[u]||(t[u]={Id:u,Permiso:!0});let r=n.parent;while(r&&r!=="#"){const n=i.get_node(r),u=n.data?.SPO_SOP_Id||n.id;t[u]||(t[u]={Id:u,Permiso:!0});r=n.parent}}const i=$(n).jstree(!0),r=i.get_checked(!0),t={};return r.forEach(n=>{u(n)}),Object.values(t)}VerificarSesionActiva(OpcionMenu.Perfiles).then(()=>{t()});$("#btnNuevo").on("click",async function(n){n.preventDefault();$("#modalEditar").data("idPerfil",-1);$("#nombrePerfil").val("");await CargarArbolPermisos(1,!0);$("#modalEditar").modal("show")});$("#btnGuardarPerfil").on("click",function(t){t.preventDefault();let i=$("#nombrePerfil").val().trim(),r=[];if(i?$("#nombrePerfil").removeClass("is-invalid"):($("#nombrePerfil").addClass("is-invalid"),r.push("Nombre")),r.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}let u=n("#tree-container-acceso"),f=n("#tree-container-edicion"),e={IdPerfil:$("#modalEditar").data("idPerfil"),NombrePerfil:i,PermisosAcceso:u,PermisosEdicion:f};$.ajax({url:AppConfig.urls.GuardarPerfil,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),dataType:"json"}).done(function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);$("#modalEditar").modal("hide");let n=$("#table").DataTable();n.ajax.reload(null,!1)}else mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Error)}).fail(function(n,t,i){registrarErrorjQuery(t,i)})});document.getElementById("nombrePerfil").addEventListener("paste",function(n){n.preventDefault()});document.getElementById("nombrePerfil").addEventListener("keydown",function(n){n.ctrlKey&&n.key==="v"&&n.preventDefault();n.metaKey&&n.key==="v"&&n.preventDefault()})});