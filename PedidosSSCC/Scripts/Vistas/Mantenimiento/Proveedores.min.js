function abrirModalProveedor(n){const t=JSON.parse(n.getAttribute("data-proveedor"));$("#proveedorId").val(t.PRV_Id);$("#proveedorCIF").val(t.PRV_CIF);$("#proveedorNombre").val(t.PRV_Nombre);$("#proveedorActivo").prop("checked",t.PRV_Activo);$("#proveedorCIF, #proveedorNombre").removeClass("is-invalid");$("#proveedorTarea").val(t.PRV_TAR_Id_Soporte||"");$("#proveedorPlantilla").val(t.PRV_PlantillaExcel||"");$("#modalProveedor").modal("show")}function abrirModalContrato(n){const i=JSON.parse(n.getAttribute("data-proveedor")),t=i.PRV_Id;limpiarModalContrato();$("#contratoProveedorId").val(t);$("#modalContratos").off("shown.bs.modal").on("shown.bs.modal",function(){cargarContratosProveedor(t)});$("#modalContratos").modal("show")}function limpiarModalContrato(){$("#contratoId").val("");$("#contratoFechaInicio").val("");$("#contratoFechaFin").val("");$("#contratoPrecioHora").val("");$("#contratoHoras").val("");$("#tableReparto tbody").empty()}function mostrarZonaAlta(){$("#zonaAltaContrato").slideDown();$("#btnNuevoContrato").hide()}function ocultarZonaAlta(){$("#zonaAltaContrato").slideUp();$("#btnNuevoContrato").show();limpiarModalContrato()}function editarContrato(n){const t=JSON.parse(n.getAttribute("data-contrato"));$("#contratoId").val(t.PVC_Id);$("#contratoProveedorId").val(t.PVC_PRV_Id);$("#contratoFechaInicio").val(parseDotNetDateToDDMMYYYY(t.PVC_FechaInicio));$("#contratoFechaFin").val(parseDotNetDateToDDMMYYYY(t.PVC_FechaFin));$("#contratoPrecioHora").val(t.PVC_PrecioHora);$("#contratoHoras").val(t.PVC_HorasContratadas);mostrarZonaAlta();cargarReparto(t.PVC_Id);$("#modalContratos").modal("show")}async function cargarReparto(n){const i=await $.getJSON(AppConfig.urls.ObtenerRepartoContrato,{contratoId:n}),t=$("#tableReparto tbody").empty();i.forEach(n=>{t.append(`
              <tr>
                <td>
                  <select class="form-select form-select-sm selectEmpresa">
                    ${opcionesEmpresas}
                  </select>
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control form-control-sm inputPorcentaje"
                         min="0" max="100" step="0.01" value="${n.PVR_Porcentaje}" />
                       <span class="input-group-text">%</span>
                    </div>
                </td>
                <td class="text-center">
                  <button type="button"
                          class="btn btn-sm btn-outline-danger btnEliminarReparto">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>`),t.find("tr:last .selectEmpresa").val(n.PVR_EMP_Id)})}function eliminarContrato(n){mostrarAlertaConfirmacion({titulo:`¿Eliminar contrato?`,onConfirmar:()=>{$.post(AppConfig.urls.EliminarContratoSoporte,{idContrato:n},n=>{n.success&&(ocultarZonaAlta(),$("#tableContratos").DataTable().ajax.reload(null,!1))},"json")}})}function cargarContratosProveedor(n){const t=$("#tableContratos").DataTable({destroy:!0,ajax:{url:AppConfig.urls.ObtenerContratoSoporte,type:"GET",dataSrc:function(t){return t.filter(t=>t.PVC_PRV_Id===n)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}},columns:[{data:"PVC_FechaInicio",render:formatDateToDDMMYYYY_Proveedores},{data:"PVC_FechaFin",render:formatDateToDDMMYYYY_Proveedores},{data:"PVC_PrecioHora",className:"text-end",render:formatMoney},{data:"PVC_HorasContratadas",className:"text-end"},{data:null,className:"td-btn",orderable:!1,render:function(n,t,i){return`<div class="btn-group" role="group">
                            <button type="button" class="btn btn-icon btn-editar me-2"
                                data-contrato="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                onclick="editarContrato(this)">
                                <i class="bi bi-pencil-square" title="Editar"></i>
                            </button>
                            <button type="button" class="btn btn-icon me-2" onclick="eliminarContrato(${i.PVC_Id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>`}}],paging:!1,searching:!1,info:!1,ordering:!1,dom:"t"})}async function eliminarProveedorAjax(n){try{const t=await $.ajax({url:AppConfig.urls.EliminarProveedor,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idProveedor:n}),dataType:"json"});t.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#table").DataTable().ajax.reload(null,!1)):mostrarToast("No se puede eliminar el proveedor.",TipoToast.Warning)}catch(t){registrarErrorjQuery(t.status||"",t.message||t)}}function eliminarProveedor(n){const t=JSON.parse(n.getAttribute("data-proveedor"));mostrarAlertaConfirmacion({titulo:`¿Eliminar el proveedor '${t.PRV_Nombre}'?`,onConfirmar:()=>eliminarProveedorAjax(t.PRV_Id)})}let opcionesEmpresas="";$(document).ready(function(){function n(){const n=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.ObtenerProveedores,type:"GET",dataSrc:""},columns:[{data:"PRV_Id",title:"Id"},{data:"PRV_CIF",title:"CIF"},{data:"PRV_Nombre",title:"Nombre"},{data:"PRV_Activo",title:"Activo",render:function(n){return n?"Sí":"No"}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',orderable:!1,render:function(n,t,i){return`
                            <div class="btn-group" role="group">
                              <button type="button"
                                      class="btn btn-icon btn-editar btn-outline-secondary me-2"
                                      data-proveedor="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                      onclick="abrirModalProveedor(this)">
                                <i class="bi bi-pencil-square" title="Editar"></i>
                              </button>
                              <button type="button"
                                      class="btn btn-icon btn-contratos btn-outline-secondary me-2"
                                      data-proveedor="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                      onclick="abrirModalContrato(this)">
                                <i class="bi bi-journal-text" title="Contratos"></i>
                              </button>
                              <button type="button"
                                      class="btn btn-icon btn-eliminar btn-outline-secondary me-2"
                                      data-proveedor="${JSON.stringify(i).replace(/"/g,"&quot;")}"
                                      onclick="eliminarProveedor(this)">
                                <i class="bi bi-trash" title="Eliminar"></i>
                              </button>
                            </div>`}}]},[],"export_proveedores");$(window).resize(()=>n.columns.adjust().draw());$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw()})}async function t(){try{const n=[Tipo.CANTIDAD_FIJA];$.ajax({url:AppConfig.urls.ObtenerComboTareas,type:"GET",dataType:"json",data:{listaTiposTarea:n},traditional:!0,success:function(n){["#proveedorTarea"].forEach(t=>{const i=$(t).empty().append('<option value="">Seleccione Tarea<\/option>');n.forEach(n=>{i.append(`<option value="${n.TAR_Id}">${n.TAR_Nombre}</option>`)})})},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}catch(n){registrarErrorjQuery("GET","Error al cargar tareas")}}async function i(){try{const n=await $.getJSON(AppConfig.urls.ObtenerEmpresasCombo);r(n)}catch(n){registrarErrorjQuery("GET","Error al cargar empresas")}}function r(n){opcionesEmpresas='<option value="">Seleccione empresa<\/option>';n.forEach(n=>{opcionesEmpresas+=`<option value="${n.EMP_Id}">${n.EMP_Nombre}</option>`})}VerificarSesionActiva(OpcionMenu.Proveedores).then(()=>{t(),i(),n()});$("#btnNuevo").on("click",function(){$("#proveedorId").val("");$("#proveedorCIF").val("");$("#proveedorNombre").val("");$("#proveedorActivo").prop("checked",!0);$("#proveedorCIF, #proveedorNombre").removeClass("is-invalid");$("#proveedorTarea").val("");$("#proveedorPlantilla").val("");$("#modalProveedor").modal("show")});$("#btnGuardarProveedor").on("click",function(){const t=$("#proveedorCIF").val().trim(),i=$("#proveedorNombre").val().trim(),r=$("#proveedorActivo").is(":checked");let n=[];if(t?$("#proveedorCIF").removeClass("is-invalid"):($("#proveedorCIF").addClass("is-invalid"),n.push("CIF")),i?$("#proveedorNombre").removeClass("is-invalid"):($("#proveedorNombre").addClass("is-invalid"),n.push("Nombre")),n.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}const u={PRV_Id:$("#proveedorId").val(),PRV_CIF:t,PRV_Nombre:i,PRV_Activo:r,PRV_TAR_Id_Soporte:$("#proveedorTarea").val(),PRV_PlantillaExcel:$("#proveedorPlantilla").val()};$.ajax({url:AppConfig.urls.GuardarProveedor,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(u),dataType:"json"}).done(function(n){n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalProveedor").modal("hide"),$("#table").DataTable().ajax.reload(null,!1)):mostrarToast("Error al guardar el proveedor.",TipoToast.Error)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})});$("#btnAgregarReparto").on("click",function(){const n=`
            <tr>
              <td>
                <select class="form-select form-select-sm selectEmpresa">
                  ${opcionesEmpresas}
                </select>
              </td>
              <td>
               <div class="input-group input-group-sm">
                <input type="number"
                       class="form-control form-control-sm inputPorcentaje"
                       min="0" max="100" step="0.01" />
                              <span class="input-group-text">%</span>
                    </div>
              </td>
              <td class="text-center">
                <button type="button"
                        class="btn btn-sm btn-outline-danger btnEliminarReparto">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>`;$("#tableReparto tbody").append(n)});$("#tableReparto").on("click",".btnEliminarReparto",function(){$(this).closest("tr").remove()});$("#btnGuardarContrato").on("click",function(){const i=$("#contratoFechaInicio").val(),n=$("#contratoFechaFin").val(),u=$("#contratoPrecioHora").val().trim();let r=[];if(i?$("#contratoFechaInicio").removeClass("is-invalid"):($("#contratoFechaInicio").addClass("is-invalid"),r.push("Fecha Inicio")),u?$("#contratoPrecioHora").removeClass("is-invalid"):($("#contratoPrecioHora").addClass("is-invalid"),r.push("Precio Hora")),r.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}if(n&&new Date(n)<new Date(i)){$("#contratoFechaFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#contratoFechaFin").removeClass("is-invalid");const t=[];if($("#tableReparto tbody tr").each(function(){const n=$(this).find(".selectEmpresa").val(),i=$(this).find(".inputPorcentaje").val();if(n){const r=parseFloat(i)||0;t.push({EMP_Id:parseInt(n,10),Porcentaje:r})}}),t.length>0){const n=t.reduce((n,t)=>n+t.Porcentaje,0);if(Math.abs(n-100)>.01){mostrarToast(`La suma de porcentajes debe ser 100% (ahora es ${n.toFixed(2)}%).`,TipoToast.Warning);return}}const f={PVC_Id:$("#contratoId").val(),PVC_PRV_Id:$("#contratoProveedorId").val(),PVC_FechaInicio:formatDateToDDMMYYYY(i),PVC_FechaFin:n?formatDateToDDMMYYYY(n):null,PVC_PrecioHora:parseFloat(u),PVC_HorasContratadas:parseInt($("#contratoHoras").val()||0)},e={objContrato:f,Reparto:t};$.ajax({url:AppConfig.urls.GuardarContratoSoporte,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),dataType:"json"}).done(function(n){n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),ocultarZonaAlta(),$("#tableContratos").DataTable().ajax.reload(null,!1),limpiarModalContrato()):mostrarToast(n.message,TipoToast.Warning)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})});$("#btnNuevoContrato").on("click",function(){mostrarZonaAlta();$("#modalContratosLabel").text("Nuevo Contrato")});$("#btnCancelarContrato").on("click",function(){ocultarZonaAlta()});$("#modalContratos").on("show.bs.modal",function(){ocultarZonaAlta()})});