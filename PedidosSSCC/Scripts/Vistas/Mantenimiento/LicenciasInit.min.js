function renderLicenciasSection(n,t){let i="";return t?.length&&(i+=`<div class="alert alert-warning">
      <ul>${t.map(n=>`<li>${n}</li>`).join("")}</ul>
    </div>`),i+(n.length?generarResumenConceptosLicenciasPrev(n):`<p>No hay licencias pendientes este mes.</p>`)}function generarResumenConceptosLicenciasPrev(n){let i=`
      <table style="width:100%;border-collapse:collapse;font-size:0.9em">
        <thead>
          <tr style="background:#f0f0f0">
            <th style="padding:6px 8px;border:1px solid #ddd;width:10%">Tarea</th>
            <th style="padding:6px 8px;border:1px solid #ddd;text-align:center;width:10%">Periodo</th>
            <th style="padding:6px 8px;border:1px solid #ddd;text-align:center;width:10%" title="Sin ajustes">Cantidad (real) &#9432;</th>
            <th style="padding:6px 8px;border:1px solid #ddd;width:43%">Licencias incluidas</th>
            <th style="padding:6px 8px;border:1px solid #ddd;text-align:right;width:15%">Importe</th>
          </tr>
        </thead>
        <tbody>
    `;const t={};return n.forEach(n=>{t[n.EmpresaNombre]||(t[n.EmpresaNombre]=[]),t[n.EmpresaNombre].push(n)}),Object.keys(t).forEach(n=>{i+=`
          <tr style="background:#e9ecef;font-weight:bold">
            <td colspan="5" style="padding:6px;border:1px solid #ddd">${n}</td>
          </tr>
        `,t[n].forEach(n=>{i+=`
              <tr>
                <td style="padding:6px 8px;border:1px solid #ddd">${n.TAR_Nombre}</td>
                <td style="padding:6px 8px;border:1px solid #ddd;text-align:center">${n.Mes}/${n.Anyo}</td>
                <td style="padding:6px 8px;border:1px solid #ddd;text-align:center">${n.Cantidad}</td>
                <td style="padding:6px 8px;border:1px solid #ddd">${n.LicenciasIncluidas}</td>
                <td style="padding:6px 8px;border:1px solid #ddd;text-align:right">${formatMoney(n.ImporteTotal)}</td>
              </tr>
            `})}),i+=`
        </tbody>
      </table>
    `}async function ejecutarGeneracionConceptos(){mostrarDivCargando();try{const n=await $.ajax({url:AppConfig.urls.GenerarTodosConceptos,type:"POST",dataType:"json"});if(ocultarDivCargando(),n.errors?.length){await Swal.fire({icon:"error",title:"Errores generando conceptos",html:`<ul style="text-align:left">
                 ${n.errors.map(n=>`<li>${n}</li>`).join("")}
               </ul>`,confirmButtonText:"Entendido"});return}if(!n.success){mostrarErrorPedidos();return}const t=`
      <div style="text-align:left">
        <h5>Conceptos de Licencias</h5>
        ${generarResumenConceptosLicenciasFin(n.licencias)}
      </div>
    `;await Swal.fire({title:"Proceso Completado",html:t,icon:"success"});const i=$("#table").DataTable();i.destroy();mostrarDivCargando();$("#table tbody").empty();await ObtenerLicencias();ocultarDivCargando()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}}function generarResumenConceptosLicenciasFin(n){if(!n||n.length===0)return"<ul><li><strong>No se ha generado ningún concepto de licencia<\/strong><\/li><\/ul>";let t="<ul style='text-align: left;'>";return n.forEach(n=>{t+=`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s) generados</li>`}),t+="<\/ul>"}function verMinimos(n){const t=JSON.parse(n.getAttribute("data-licencia"));$("#idLicenciaMinimos").val(t.LIC_Id);limpiarFormularioMinimo();cargarComboEmpresasMinimo();ObtenerMinimos(t.LIC_Id);$("#formMinimos").hide();$("#btnCancelarMinimo").hide();$("#btnGuardarMinimo").hide();$("#btnNuevoMinimo").show();$("#modalMinimos").modal("show")}async function cargarComboEmpresasMinimo(){try{const t=await $.ajax({url:AppConfig.urls.ObtenerComboEmpresas,type:"GET",dataType:"json"}),n=$("#empresaMinimo");n.empty().append('<option value="">Seleccione empresa<\/option>');$.each(t,function(t,i){n.append(`<option value="${i.EMP_Id}">${i.EMP_Nombre}</option>`)})}catch(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}}function ObtenerMinimos(n){let t=inicializarDataTable("#tableMinimos",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerMinimos,type:"GET",dataSrc:function(n){return n},data:{licenciaId:n},dataType:"json",error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}},rowId:function(n){return`fila-${n.LEM_LIC_Id}-${n.LEM_EMP_Id}`},columns:[{data:"EmpresaNombre",title:"Empresa"},{data:"LEM_MinimoFacturar",title:"Mínimo",className:"text-end"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`
                            <button type="button" class="btn btn-icon btn-editar btn-outline-secondary me-2"
                                data-minimo='${r}'
                                onclick="editarMinimo(this)"
                                title="Editar">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
                                data-minimo='${r}'
                                onclick="eliminarMinimo(this)"
                                title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>`}}]},[],"export_minimos");$(window).resize(function(){t.columns.adjust().draw()})}function limpiarFormularioMinimo(){$("#empresaMinimo").val("");$("#minimoFacturar").val("");$("#formMinimos").hide();$("#btnGuardarMinimo").hide();$("#btnCancelarMinimo").hide()}function editarMinimo(n){const t=JSON.parse(n.getAttribute("data-minimo"));$("#empresaMinimo").val(t.LEM_EMP_Id);$("#minimoFacturar").val(t.LEM_MinimoFacturar);$("#empresaMinimo").prop("disabled",!0);$("#btnNuevoMinimo").hide();$("#btnCancelarMinimo").show();$("#btnGuardarMinimo").show();$("#formMinimos").slideDown()}function cancelarMinimo(){limpiarFormularioMinimo();$("#empresaMinimo").prop("disabled",!1);$("#btnNuevoMinimo").show()}async function guardarMinimo(){["#empresaMinimo","#minimoFacturar"].forEach(n=>$(n).removeClass("is-invalid"));let n=[];if($("#empresaMinimo").val()||(n.push("Empresa"),$("#empresaMinimo").addClass("is-invalid")),$("#minimoFacturar").val().toString().trim()||(n.push("Mínimo a facturar"),$("#minimoFacturar").addClass("is-invalid")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+`${n.join(", ")}`,TipoToast.Warning);return}const i={LEM_LIC_Id:parseInt($("#idLicenciaMinimos").val()),LEM_EMP_Id:parseInt($("#empresaMinimo").val()),LEM_MinimoFacturar:parseInt($("#minimoFacturar").val())};try{const n=await $.ajax({url:AppConfig.urls.GuardarMinimo,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(i),dataType:"json"});n.success?(mostrarToast("Mínimo guardado correctamente",TipoToast.Success),limpiarFormularioMinimo(),$("#empresaMinimo").prop("disabled",!1),$("#btnNuevoMinimo").show(),$("#tableMinimos").DataTable().ajax.reload(null,!1)):registrarErrorjQuery(n.status,n.message)}catch(t){const n=obtenerMensajeErrorAjax(t);registrarErrorjQuery(t.status,n)}}function eliminarMinimo(n){setTimeout(()=>{const t=JSON.parse(n.getAttribute("data-minimo")),i=t.EmpresaNombre;mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el mínimo para '${i}'?`,backdrop:!1,onConfirmar:function(){$.ajax({url:AppConfig.urls.EliminarMinimo,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idLicencia:t.LEM_LIC_Id,idEmpresa:t.LEM_EMP_Id}),dataType:"json"}).done(function(n){if(n.success){mostrarToast("Mínimo eliminado correctamente",TipoToast.Success);let n=$("#tableMinimos").DataTable();n.ajax.reload(null,!1)}else registrarErrorjQuery(n.status,n.message)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})}})},300)}function ObtenerLicencias(){let n=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.obtenerLicencias,type:"GET",dataSrc:"",error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}},columns:[{data:"LIC_Nombre",title:"Nombre"},{data:"LIC_MaximoGrupo",title:"Máximo Grupo"},{data:"NombrePadre",title:"Licencia Padre"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){const u=i.TieneHijas===!0,f=u?'disabled title="Esta licencia tiene hijas" class="btn btn-icon btn-outline-secondary me-2 btn-disabled"':'class="btn btn-icon btn-outline-secondary me-2"',e=i.LIC_LIC_Id_Padre==null,o=e?'class="btn btn-icon btn-outline-secondary me-2"':'disabled title="Solo licencias padre pueden gestionar mínimos" class="btn btn-icon btn-outline-secondary me-2 btn-disabled"',s=e&&u?'disabled title="Solo licencias padre pueden gestionar los entes" class="btn btn-icon btn-outline-secondary me-2 btn-disabled"':'class="btn btn-icon btn-outline-secondary me-2"',r=JSON.stringify(i).replace(/"/g,"&quot;");return`<div class="btn-group" role="group">
                            <button type="button" class="btn btn-icon btn-editar btn-outline-secondary me-2"
                                data-licencia='${r}' onclick="editarLicencia(this)">
                                <i class="bi bi-pencil-square" title="Editar"></i>
                            </button>

                            <button type="button" ${o} data-licencia='${r}' onclick="verTarifas(this)">
                                <i class="bi bi-currency-dollar" title="Tarifas"></i>
                            </button>

                            <button type="button" ${f}
                                data-licencia='${r}' onclick="verExcepciones(this)">
                                <i class="bi bi-exclamation-triangle" title="Excepciones"></i>
                            </button>

                            <button type="button" ${o} 
                                data-licencia='${r}' onclick="verMinimos(this)" title="Mínimos">
                                <i class="bi bi-cash-stack" title="Mínimos"></i>
                            </button>

                            <button type="button" ${s}
                                    data-licencia='${r}'
                                    onclick="verEntesLicencias(this)">
                                <i class="bi bi-people-fill" title="Entidades"></i>
                            </button>

                            <button type="button" ${f.replace("btn-outline-secondary","btn-outline-secondary btn-eliminar")}
                                data-licencia='${r}' onclick="eliminarLicencia(this)">
                                <i class="bi bi-trash" title="Eliminar"></i>
                            </button>
                        </div>`}}]},[],"export_licencias");$(window).resize(function(){n.columns.adjust().draw()});$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();n.responsive.rebuild();n.responsive.recalc();n.columns.adjust();n.draw(!1)})}$(document).ready(function(){async function t(){try{await VerificarSesionActiva(OpcionMenu.Licencias);await Promise.all([i(),r(),u()]);e()}catch(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}}async function i(){function t(n,t,i){n.empty().append(`<option value="">${i}</option>`);t.forEach(t=>n.append(`<option value="${t.TAR_Id}">${t.TAR_Nombre}</option>`))}const i=[Tipo.CANTIDAD_FIJA],n=await $.ajax({url:AppConfig.urls.obtenerTareasCombo,method:"GET",dataType:"json",traditional:!0,data:{listaTiposTarea:i}});t($("#tareaSW"),n,"Seleccione SW");t($("#tareaAntivirus"),n,"Seleccione AV");t($("#tareaBackup"),n,"Seleccione BK")}async function r(){try{const t=await $.ajax({url:AppConfig.urls.obtenerLicenciasCombo,type:"GET",dataType:"json"}),n=$("#padre");n.empty().append('<option value="">Seleccione licencia<\/option>');$.each(t,function(t,i){n.append(`<option value="${i.LIC_Id}">${i.LIC_Nombre}</option>`)})}catch(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}}async function u(){try{const t=await $.ajax({url:AppConfig.urls.ObtenerComboEmpresas,type:"GET",dataType:"json"}),n=$("#empresa");n.empty().append('<option value="">Seleccione empresa<\/option>');$.each(t,function(t,i){n.append(`<option value="${i.EMP_Id}">${i.EMP_Nombre}</option>`)})}catch(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}}function f(){let t={general:$("#formBuscar").val(),nombre:$("#filterNombre").val(),grupo:$("#filterGrupo").val(),padre:$("#filterPadre").val()};localStorage.setItem(n,JSON.stringify(t))}function e(){let t=localStorage.getItem(n),i=!1;if(t){t=JSON.parse(t);$("#formBuscar").val(t.general);$("#filterNombre").val(t.nombre||"");$("#filterGrupo").val(t.grupo||"");$("#filterPadre").val(t.padre||"");let{...otrosFiltros}=t;i=Object.values(otrosFiltros).some(n=>n)}ObtenerLicencias();setTimeout(function(){let n=$("#table").DataTable();t?.general&&n.search(t.general,!1,!1).draw()},200);i&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}const n=Filtros.Licencias;t();InicializarSelectTiposEnte();cargarComboTiposEnte(0);InicializarSelectLicenciasIncompatibles();cargarComboLicenciasIncompatibles(0);$("#btnNuevo").on("click",function(){$("#idLicencia").val("-1");$("#nombre").val("");$("#grupo").val("");$("#padre").val("");$("#nombre").removeClass("is-invalid");$("#nombreMS").val("");$("#gestionado").prop("checked",!0);$("#modalEditarLabel").text("Agregar Licencia");$("#modalEditar").modal("show")});$("#btnBuscar").on("click",function(){let t=$("#filterNombre").val(),i=$("#filterGrupo").val(),r=$("#filterPadre").val(),n=$("#table").DataTable();n.columns(0).search(t).draw();n.columns(1).search(i).draw();n.columns(2).search(r).draw();f()});$("#modalTarifas, #modalExcepciones, #modalPedidosEsfuerzo").modal({backdrop:"static",keyboard:!1});$("#btnProcesarExcelLicencias").on("click",async function(){const t=$("#archivoLicencias")[0].files[0];if(!t){mostrarToast("Selecciona un archivo primero",TipoToast.Warning);return}$("#modalImportar").modal("hide");mostrarDivCargando();try{const i=new FormData;i.append("archivoExcel",t);const n=await fetch(AppConfig.urls.ProcesarLicenciasDesdeExcel,{method:"POST",body:i}),r=n.headers.get("Content-Type")||"";if(r.startsWith("application/json")){const t=await n.json();t.success?await Swal.fire("Proceso Completado","Las licencias se han procesado correctamente.","success"):t.excelErroneo?await Swal.fire("Error al importar Excel",t.mensajeExcelErroneo,"error"):await Swal.fire("Error",t.message||"Ha ocurrido un error","error")}else{const f=await n.blob(),e=n.headers.get("Content-Disposition")||"",i=e.match(/filename="?(.+)"?/),o=i?i[1]:"resultado.xlsx",r=URL.createObjectURL(f),t=document.createElement("a");t.href=r;t.download=o;document.body.appendChild(t);t.click();document.body.removeChild(t);URL.revokeObjectURL(r);const u=n.headers.get("X-Type");u==="bloqueante"?await Swal.fire("Se encontraron errores bloqueantes","Descarga el Excel para ver el detalle.","error"):u==="warning"&&await Swal.fire("Advertencias al importar","Descarga el Excel para revisar las advertencias.","warning")}}catch(n){console.error(n);const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status||0,t);mostrarToast("Error al conectar con el servidor",TipoToast.Error)}finally{ocultarDivCargando()}});$("#btnAbrirModalProcesar").on("click",function(){$("#modalImportar").modal("show")});$("#empresa").on("change",function(){const n=$(this).val(),t=$("#idLicenciaExcepciones").val();n&&t?($("#licenciasReemplazo").prop("disabled",!1),cargarComboLicenciasReemplazo(t,n)):($("#licenciasReemplazo").val(null).trigger("change"),$("#licenciasReemplazo").prop("disabled",!0))});$("#modalExcepciones").on("shown.bs.modal",function(){const n=$("#tableExcepciones").DataTable();n.columns.adjust().responsive.recalc()});$("#btnNuevaTarifa").on("click",function(){limpiarFormularioTarifa();$("#btnNuevaTarifa").hide();$("#btnCancelarTarifa").show();$("#btnGuardarTarifa").show();$("#formTarifas").slideDown()});$("#btnGuardarTarifa").click(async function(n){n.preventDefault();const r=$("#fechaInicio").val(),t=$("#fechaFin").val();["#fechaInicio","#precioUnitarioSW","#precioUnitarioAntivirus","#precioUnitarioBackup"].forEach(n=>$(n).removeClass("is-invalid"));let i=[];if([{sel:"#fechaInicio",name:"Fecha Inicio"},{sel:"#precioUnitarioSW",name:"Precio SW"},{sel:"#precioUnitarioAntivirus",name:"Precio Antivirus"},{sel:"#precioUnitarioBackup",name:"Precio Backup"}].forEach(n=>{$(n.sel).val().toString().trim()||(i.push(n.name),$(n.sel).addClass("is-invalid"))}),i.length){mostrarToast(`Los siguientes campos son obligatorios: ${i.join(", ")}`,TipoToast.Warning);return}if(t&&new Date(t)<new Date(r)){$("#tarifaFechaFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}const f={LIT_LIC_Id:$("#idLicenciaTarifas").val(),LIT_FechaInicio:r,LIT_FechaFin:t||null,LIT_PrecioUnitarioSW:parseFloat($("#precioUnitarioSW").val()),LIT_PrecioUnitarioAntivirus:parseFloat($("#precioUnitarioAntivirus").val()),LIT_PrecioUnitarioBackup:parseFloat($("#precioUnitarioBackup").val())};try{const n=await $.ajax({url:AppConfig.urls.GuardarTarifa,type:"POST",contentType:"application/json",data:JSON.stringify(f),dataType:"json"});n.success?(mostrarToast("Tarifa guardada correctamente",TipoToast.Success),$("#btnNuevaTarifa").show(),$("#btnCancelarTarifa").hide(),$("#btnGuardarTarifa").hide(),$("#formTarifas").hide(),$("#tableTarifas").DataTable().ajax.reload(null,!1)):mostrarToast(n.message||"Hay solapamiento de fechas",TipoToast.Warning)}catch(u){registrarErrorjQuery(u.status,u.responseText)}});$("#btnGuardarMinimo").on("click",async function(n){n.preventDefault();await guardarMinimo()});$("#btnCancelarMinimo").on("click",function(){cancelarMinimo()});$("#btnNuevoMinimo").on("click",function(){limpiarFormularioMinimo();$("#btnNuevoMinimo").hide();$("#btnCancelarMinimo").show();$("#btnGuardarMinimo").show();$("#formMinimos").slideDown()});$("#btnNuevoEnte").on("click",()=>{$("#formEntesLicencias").slideDown(),$("#btnGuardarEnteLicencia").show(),$("#btnCancelarEnte").show(),$("#btnNuevoEnte").hide()});$("#btnCancelarEnte").on("click",()=>{limpiarFormularioEntes(),$("#formEntesLicencias").slideUp(),$("#btnGuardarEnteLicencia").hide(),$("#btnCancelarEnte").hide(),$("#btnNuevoEnte").show()});$("#btnGuardarEnteLicencia").on("click",async()=>{const n={ENL_ENT_Id:parseInt($("#selectEnte").val(),10),ENL_LIC_Id:parseInt($("#idLicenciaEntes").val(),10),ENL_FechaInicio:$("#fechaInicioEnte").val(),ENL_FechaFin:$("#fechaFinEnte").val()||null};try{const t=await $.ajax({url:AppConfig.urls.GuardarEnteLicencia,method:"POST",contentType:"application/json",data:JSON.stringify(n),dataType:"json"});t.success?(mostrarToast("Asociación guardada",TipoToast.Success),limpiarFormularioEntes(),$("#tableEntesLicencias").DataTable().ajax.reload(null,!1),$("#formEntesLicencias").slideUp(),$("#btnGuardarEnteLicencia").hide(),$("#btnCancelarEnte").hide(),$("#btnNuevoEnte").show()):mostrarToast(t.message||"Error al guardar",TipoToast.Error)}catch(t){console.error(t)}});$("#btnPrevisulizarConceptos").click(async()=>{mostrarDivCargando();try{const t=await $.ajax({url:AppConfig.urls.PrevisualizarConceptos,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8"});if(ocultarDivCargando(),!t.success){mostrarErrorPedidos();return}const{licencias:n,licenciasErrors:i}=t;if(!n.length&&!i?.length){await Swal.fire({title:"Nada que Generar",html:`<p>No hay conceptos pendientes ni mensajes de error.</p>`,icon:"info",confirmButtonText:"Entendido",confirmButtonColor:"#3085d6",width:500});return}const u=`
                <div class="small text-start">
                  <h5>Licencias</h5>
                  ${renderLicenciasSection(n,i)}
                </div>`,r=n.length>0,{isConfirmed:f}=await Swal.fire({title:"¿Deseas generar los conceptos?",html:u,width:"70%",showCancelButton:!0,cancelButtonText:r?"No, cancelar":"Cerrar",showConfirmButton:r,confirmButtonText:"Sí, generar"});f&&await ejecutarGeneracionConceptos()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}})});