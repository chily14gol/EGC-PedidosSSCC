async function editarEmpresa(n){let t=JSON.parse(n.getAttribute("data-empresa"));$("#idEmpresa").val(t.EMP_Id);$("#nombre").val(t.EMP_Nombre).prop("disabled",!1);$("#nombreDA").val(t.EMP_NombreDA).prop("disabled",!1);$("#razonSocial").val(t.EMP_RazonSocial).prop("disabled",!1);$("#cif").val(t.EMP_CIF).prop("disabled",!1);$("#direccion").val(t.EMP_Direccion).prop("disabled",!1);$("#aprobador").val(t.EMP_PER_Id_AprobadorDefault).prop("disabled",!1);$("#lineaNegocio").val(t.EMP_LNE_Id).prop("disabled",!1);$("#codigoAPIKA").val(t.EMP_CodigoAPIKA).prop("disabled",!1);$("#codigoD365").val(t.EMP_CodigoD365).prop("disabled",!1);$("#formaPagoAPIKA").val(t.EMP_FPA_CodigoAPIKA).prop("disabled",!1);$("#formaPagoCodigoD365").val(t.EMP_FPA_D365).prop("disabled",!1);$("#tipoCliente").val(t.EMP_TipoCliente).prop("disabled",!1);$("#grupoD365").val(t.EMP_EGrupoD365).prop("disabled",!1);$("#empresaFacturar").val(t.EMP_EmpresaFacturar_Id);$("#excluidaGuardia").prop("checked",t.EMP_ExcluidaGuardia===!0);$("#facturaVDF").val(t.EMP_NumFacturaVDF).prop("disabled",!1);await CargarComboEmpresaAprobadores(t.EMP_Id);await CargarComboGruposGuardia();quitarMarcasError();$("#grupoGuardia").val(t.EMP_GRG_Id||"").prop("disabled",!1);$("#modalEditarLabel").text("Editar Empresa");$("#modalEditar").modal("show")}function guardarEmpresa(){let n={},t=[];if(["nombre","nombreDA","razonSocial","cif","aprobador","lineaNegocio","codigoAPIKA","codigoD365","formaPagoAPIKA","formaPagoCodigoD365","tipoCliente","grupoD365"].forEach(i=>{const r=$(`#${i}`).val();n[i]=r;r?$(`#${i}`).removeClass("is-invalid"):($(`#${i}`).addClass("is-invalid"),t.push(i))}),t.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}let i={EMP_Id:$("#idEmpresa").val(),EMP_Nombre:n.nombre,EMP_NombreDA:n.nombreDA,EMP_RazonSocial:n.razonSocial,EMP_Direccion:$("#direccion").val(),EMP_CIF:n.cif,EMP_PER_Id_AprobadorDefault:n.aprobador,EMP_LNE_Id:n.lineaNegocio,EMP_CodigoAPIKA:n.codigoAPIKA,EMP_CodigoD365:n.codigoD365,EMP_FPA_CodigoAPIKA:n.formaPagoAPIKA,EMP_FPA_D365:n.formaPagoCodigoD365,EMP_TipoCliente:n.tipoCliente,EMP_EGrupoD365:n.grupoD365,EMP_EmpresaFacturar_Id:$("#empresaFacturar").val(),EMP_ExcluidaGuardia:$("#excluidaGuardia").is(":checked"),EMP_GRG_Id:$("#grupoGuardia").val()||null,EMP_NumFacturaVDF:$("#facturaVDF").val()},r={empresa:i,idsAprobadores:$("#aprobadoresAdicionales").val()||[]};$.ajax({url:AppConfig.urls.GuardarEmpresa,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(r),dataType:"json"}).done(function(n){n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalEditar").modal("hide"),$("#table").DataTable().ajax.reload(null,!1)):registrarErrorjQuery("",null)}).fail(function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)})}async function CargarComboEmpresaAprobadores(n){try{const i=new URLSearchParams({idEmpresa:n}),r=await fetch(`${AppConfig.urls.ObtenerComboEmpresaAprobadores}?${i}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),u=await r.json(),t=$("#aprobadoresAdicionales");t.empty();u.forEach(n=>{const i=new Option(n.ApellidosNombre,n.EMA_PER_Id,!0,!0);t.append(i)});t.trigger("change")}catch(t){registrarErrorjQuery("fetch",t.message)}}async function CargarComboGruposGuardia(){try{const t=await $.ajax({url:AppConfig.urls.ObtenerComboGruposGuardia,type:"GET",dataType:"json"}),n=$("#grupoGuardia");n.empty().append('<option value="">Seleccione un grupo<\/option>');t.forEach(t=>{n.append(`<option value="${t.GRG_Id}">${t.GRG_Nombre}</option>`)})}catch(n){registrarErrorjQuery("fetch",n.message)}}function quitarMarcasError(){$("#nombre").removeClass("is-invalid");$("#razonSocial").removeClass("is-invalid");$("#cif").removeClass("is-invalid");$("#aprobador").removeClass("is-invalid");$("#lineaNegocio").removeClass("is-invalid");$("#codigoAPIKA").removeClass("is-invalid");$("#codigoD365").removeClass("is-invalid");$("#formaPagoAPIKA").removeClass("is-invalid");$("#formaPagoCodigoD365").removeClass("is-invalid");$("#tipoCliente").removeClass("is-invalid");$("#grupoD365").removeClass("is-invalid");$("#error-cif").addClass("d-none");$("#facturaVDF").removeClass("is-invalid")}async function abrirModalDepartamentos(n,t){currentEmpresaId=n;$("#dep-empresa-nombre").text(t);ocultarPanelEdicion();await cargarDepartamentos();$("#modalDepartamentos").modal("show")}function mostrarPanelEdicion(n,t){currentDeptoId=n||null;$("#txtDeptoNombre").val(t||"");$("#panelDeptoEdicion").slideDown();$("#panelDeptoNuevoBtn").hide()}function ocultarPanelEdicion(){currentDeptoId=null;$("#txtDeptoNombre").val("");$("#panelDeptoEdicion").slideUp();$("#panelDeptoNuevoBtn").show()}async function cargarDepartamentos(){const n=inicializarDataTable("#tblDepartamentos",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerDepartamentosEmpresa,type:"GET",data:function(){return{idEmpresa:currentEmpresaId}},dataSrc:""},columns:[{data:"EDE_Nombre",title:"Nombre"},{data:null,className:"td-btn text-end",orderable:!1,title:'<span class="sReader">Acción<\/span>',render:function(n,t,i){const r=i.EDE_Nombre.replace(/'/g,"\\'");return`
            <div class="btn-group" role="group">
              <button
                class="btn btn-sm btn-warning"
                title="Editar"
                onclick="mostrarPanelEdicion(${i.EDE_Id}, '${r}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button
                class="btn btn-sm btn-danger"
                title="Eliminar"
                onclick="eliminarDepartamento(${i.EDE_Id})">
                <i class="bi bi-trash"></i>
              </button>
            </div>`}}]},[],"export_departamentos");$(window).resize(()=>n.columns.adjust().draw())}function eliminarDepartamento(n){mostrarAlertaConfirmacion({titulo:"¿Eliminar departamento?",onConfirmar:async()=>{try{const t=await $.ajax({url:AppConfig.urls.EliminarDepartamentoEmpresa,method:"POST",contentType:"application/json",data:JSON.stringify({id:n})});t.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),cargarDepartamentos()):mostrarToast(t.message,TipoToast.Warning)}catch(t){console.error(t)}}})}const eliminarEmpresa=n=>{const t=JSON.parse(n.getAttribute("data-empresa"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar la empresa '${t.EMP_Nombre}'?`,onConfirmar:async()=>{try{const n=await fetch(AppConfig.urls.EliminarEmpresa,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({idEmpresa:t.EMP_Id})}),i=await n.json();if(i.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);const n=$("#table").DataTable();n.ajax.reload(null,!1)}else mostrarToast("No se puede eliminar la empresa. Tiene pedidos asociados",TipoToast.Warning)}catch(n){registrarErrorjQuery("Error",n.message||n)}}})};let currentDeptoId=null;$(document).ready(function(){async function i(){try{let t=await $.ajax({url:AppConfig.urls.ObtenerPersonas,type:"GET",dataType:"json"}),n=$("#aprobador");if(n.length===0){console.error("El select #aprobador no está en el DOM");return}return n.empty().append('<option value="">Seleccione una persona<\/option>'),t.forEach(t=>{n.append(`<option value="${t.PER_Id}">${t.ApellidosNombre}</option>`)}),t}catch(n){console.error("Error al cargar personas:",n);throw n;}}async function r(){try{const t=await $.ajax({url:AppConfig.urls.ObtenerComboLineasNegocio,type:"GET",dataType:"json"}),n=$("#lineaNegocio");return n.empty(),n.append('<option value="">Seleccione una línea de negocio<\/option>'),t.forEach(t=>{n.append(`<option value="${t.LNI_LNE_Id}">${t.LNI_Nombre}</option>`)}),t}catch(n){registrarErrorjQuery(n.status||"error",n.message||n);throw n;}}async function u(){try{const t=await $.ajax({url:AppConfig.urls.ObtenerComboEmpresas,type:"GET",dataType:"json"}),n=$("#empresaFacturar");return n.empty(),n.append('<option value="">Seleccione una empresa<\/option>'),t.forEach(t=>{n.append(`<option value="${t.EMP_Id}">${t.EMP_Nombre}</option>`)}),t}catch(n){registrarErrorjQuery(n.status||"error",n.message||n);throw n;}}async function f(){try{await i();await r();await u();o();e()}catch(n){console.error("Error al cargar combos:",n)}}function e(){if(!$.fn.select2){console.error("Select2 no está disponible");return}let n=$("#aprobadoresAdicionales");if(n.length===0){console.error("El select #aprobadoresAdicionales no está en el DOM");return}n.select2({placeholder:"Seleccione aprobadores...",allowClear:!0,tags:!0,dropdownParent:$("#modalEditar"),width:"100%",ajax:{url:AppConfig.urls.ObtenerPersonas,dataType:"json",delay:250,processResults:function(n){return{results:n.map(n=>({id:n.PER_Id,text:n.ApellidosNombre}))}},cache:!0}})}function o(){let t=localStorage.getItem(n),i=!1;if(t){t=JSON.parse(t);$("#formBuscar").val(t.general);$("#filterNombre").val(t.nombre||"");$("#filterNombreDA").val(t.nombreDA||"");$("#filterRazonSocial").val(t.razonSocial||"");$("#filterCIF").val(t.cif||"");$("#filterDireccion").val(t.direccion||"");$("#filterLineaNegocio").val(t.lineaNegocio||"");let{...otrosFiltros}=t;i=Object.values(otrosFiltros).some(n=>n!==""&&n!==null&&n!==undefined)}s();setTimeout(function(){let n=$("#table").DataTable();t?.general&&n.search(t.general,!1,!1).draw()},200);i&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}function t(){let t=$("#formBuscar").val(),i=$("#filterNombre").val(),r=$("#filterNombreDA").val(),u=$("#filterRazonSocial").val(),f=$("#filterCIF").val(),e=$("#filterDireccion").val(),o=$("#filterLineaNegocio").val(),s={general:t,nombre:i,nombreDA:r,razonSocial:u,cif:f,direccion:e,lineaNegocio:o};localStorage.setItem(n,JSON.stringify(s))}function s(){let n=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.ObtenerEmpresas,type:"GET",dataSrc:""},columns:[{data:"EMP_Nombre",title:"Nombre"},{data:"EMP_NombreDA",title:"Nombre Directorio Activo"},{data:"EMP_RazonSocial",title:"Razón Social"},{data:"EMP_CIF",title:"CIF"},{data:"EMP_Direccion",title:"Dirección"},{data:"LineaNegocioNombre",title:"Línea Negocio"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`<div class="btn-group" role="group">
                            <button class="btn btn-icon me-2 btn-editar"
                                    data-empresa="${r}"
                                    onclick="editarEmpresa(this)">
                                <i class="bi bi-pencil-square" title="Editar"></i>
                            </button>
                            <button class="btn btn-icon me-2 btn-dept"
                                    data-empresa="${r}"
                                    onclick="abrirModalDepartamentos(${i.EMP_Id}, '${htmlEscape(i.EMP_Nombre)}')"> 
                               <i class="bi bi-folder" title="Departamentos"></i>
                            </button>
                            <button class="btn btn-icon me-2 btn-eliminar"
                                data-empresa="${r}"
                                onclick="eliminarEmpresa(this)">
                                <i class="bi bi-trash" title="Eliminar"></i>
                            </button>
                            </div>`}}]},[],"export_empresas");$(window).resize(function(){n.columns.adjust().draw()});$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();n.responsive.rebuild();n.responsive.recalc();n.columns.adjust();n.draw(!1);t()})}let n=Filtros.Empresas;VerificarSesionActiva(OpcionMenu.Empresas).then(()=>{f()});$("#btnNuevo").on("click",function(){$("#idEmpresa").val("");$("#nombre").val("").prop("disabled",!1);$("#nombreDA").val("").prop("disabled",!1);$("#razonSocial").val("").prop("disabled",!1);$("#cif").val("").prop("disabled",!1);$("#direccion").val("").prop("disabled",!1);$("#aprobador").val("").prop("disabled",!1);$("#lineaNegocio").val("").prop("disabled",!1);$("#codigoAPIKA").val("").prop("disabled",!1);$("#codigoD365").val("").prop("disabled",!1);$("#formaPagoAPIKA").val("").prop("disabled",!1);$("#formaPagoCodigoD365").val("").prop("disabled",!1);$("#tipoCliente").val("").prop("disabled",!1);$("#grupoD365").val("").prop("disabled",!1);$("#empresaFacturar").val("").prop("disabled",!1);$("#aprobadoresAdicionales").val(null).prop("disabled",!1).trigger("change");$("#excluidaGuardia").prop("checked",!1);$("#grupoGuardia").val("").prop("disabled",!1);$("#facturaVDF").val("").prop("disabled",!1);quitarMarcasError();$("#modalEditarLabel").text("Agregar Empresa");$("#modalEditar").modal("show")});$("#btnBuscar").on("click",function(){let i=$("#filterNombre").val(),r=$("#filterNombreDA").val(),u=$("#filterRazonSocial").val(),f=$("#filterCIF").val(),e=$("#filterDireccion").val(),o=$("#filterLineaNegocio").val(),n=$("#table").DataTable();n.columns(0).search(i).draw();n.columns(1).search(r).draw();n.columns(2).search(u).draw();n.columns(3).search(f).draw();n.columns(4).search(e).draw();n.columns(5).search(o).draw();t()});$("#btnAddDepartamento").on("click",()=>{mostrarPanelEdicion(0,"")});$("#btnCancelarDepto").on("click",()=>{ocultarPanelEdicion()});$("#btnGuardarDepto").on("click",async()=>{const n=$("#txtDeptoNombre").val().trim();if(!n){alert("El nombre no puede quedar vacío.");return}const t={EDE_Id:currentDeptoId||0,EDE_EMP_Id:currentEmpresaId,EDE_Nombre:n};try{const n=await $.ajax({url:AppConfig.urls.GuardarDepartamentoEmpresa,method:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json"});n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),ocultarPanelEdicion(),cargarDepartamentos()):mostrarToast(n.message||"Error al guardar.",TipoToast.Warning)}catch(i){console.error(i)}})});