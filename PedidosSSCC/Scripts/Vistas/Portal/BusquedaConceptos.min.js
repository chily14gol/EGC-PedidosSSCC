function verConcepto(n){let t=JSON.parse(n.getAttribute("data-concepto")),i=AppConfig.urls.ConceptoDetalle,r=`${i}/${t.TLE_Id}?mode=view`;window.location.href=r}function editarConcepto(n){let t=JSON.parse(n.getAttribute("data-concepto")),i=AppConfig.urls.ConceptoDetalle,r=`${i}/${t.TLE_Id}?mode=edit`;window.location.href=r}function eliminarConcepto(n){let t=JSON.parse(n.getAttribute("data-concepto"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el concepto con ID: ${t.TareaNombre}-${t.EmpresaNombre}?`,onConfirmar:function(){$.ajax({url:AppConfig.urls.EliminarConcepto,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idConcepto:t.TLE_Id}),dataType:"json",success:function(t){if(t.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);let t=$("#tablaConceptos").DataTable();t.row($(n).closest("tr")).remove().draw(!1)}else mostrarToast("Error al eliminar el concepto.",TipoToast.Error)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}})}$(document).ready(async function(){async function u(){const u=document.querySelector("#datosConceptos")?.dataset.anio;let n=localStorage.getItem(i),r=!1;if(n){n=JSON.parse(n);$("#formBuscar").val(n.general);$("#ddlAño").val(n.anio||u);$("#filterTarea").val(n.tarea||"");$("#filterEmpresa").val(n.empresa||"");$("#filterMes").val(n.mes||"");$("#filterCantidad").val(n.cantidad||"");$("#filterDescripcion").val(n.descripcion||"");$("#filterEstado").val(n.estado||"");$("#filterImporte").val(n.importe||"");let{...otrosFiltros}=n;r=Object.values(otrosFiltros).some(n=>n!==""&&n!==null&&n!==undefined)}await t();setTimeout(function(){let t=$("#tablaConceptos").DataTable();n?.general&&t.search(n.general,!1,!1).draw()},200);r&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}function r(){let n=$("#formBuscar").val(),t=$("#ddlAño").val(),r=$("#filterTarea").val(),u=$("#filterEmpresa").val(),f=$("#filterMes").val(),e=$("#filterCantidad").val(),o=$("#filterDescripcion").val(),s=$("#filterEstado").val(),h=$("#filterImporte").val(),c={general:n,anio:t,tarea:r,empresa:u,mes:f,cantidad:e,descripcion:o,estado:s,importe:h};localStorage.setItem(i,JSON.stringify(c))}function f(n,t){const i=`data-concepto="${JSON.stringify(n).replace(/"/g,"&quot;")}"`;return!t||[EstadosSolicitud.PendienteAprobacion,EstadosSolicitud.Aprobado,EstadosSolicitud.Rechazado].includes(n.TLE_ESO_Id)?`
            <button type="button" class="btn btn-icon btn-detalle btn-outline-secondary"
                ${i}
                onclick="verConcepto(this)">
                <i class="bi bi-eye-fill" title="Ver"></i>
            </button>`:`
        <button type="button" class="btn btn-icon btn-editar btn-outline-secondary"
            ${i}
            onclick="editarConcepto(this)">
            <i class="bi bi-pencil-square" title="Editar"></i>
        </button>
        <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
            ${i}
            onclick="eliminarConcepto(this)">
            <i class="bi bi-trash" title="Eliminar"></i>
        </button>`}async function t(){let n=!1,u=JSON.parse(sessionStorage.getItem("permisos"))||[],t=u.find(n=>n.SPO_SOP_Id===OpcionMenu.Conceptos);t&&t.SPO_Escritura===!0&&(n=!0);const e=[],o=(new Date).toISOString().slice(0,10).replace(/-/g,"");try{const s=await fetch(AppConfig.urls.ObtenerConceptosFacturacion),u=await s.json();if(u.length>0&&anio===null){const{AnioExportar:n,MesExportar:t}=u[0];n&&$("#anio").val(n);t&&$("#mes").val(t)}const t=$("#tablaConceptos").DataTable({data:u,columns:[{data:"TLE_TAR_Id",title:"ID_Tarea",visible:!1},{data:"TareaNombre",title:"Tarea",responsivePriority:1},{data:"EmpresaNombre",title:"Empresa"},{data:"TLE_Anyo",title:"Año"},{data:"TLE_Mes",title:"Mes"},{data:"CantidadNombre",title:"Cantidad",className:"dt-type-numeric dt-type-numeric-with-decimal",render:n=>n.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})},{data:"TLE_Descripcion",title:"Descripción"},{data:"EstadoNombre",title:"Estado"},{data:"ImporteTotal",title:"Importe Total",className:"dt-type-numeric-with-decimal",render:formatMoney},{data:null,title:"Inversión",orderable:!1,className:"dt-center ico-status",render:(n,t,i,r)=>`
                                    <input type="checkbox" class="form-check-input"
                                        id="checkbox-${r.row}"
                                        data-index="${r.row}"
                                        data-id="${i.TLE_Id}" disabled
                                        ${i.TLE_Inversion?"checked":""} />`},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:(t,i,r)=>f(r,n)}],autoWidth:!1,destroy:!0,paging:!0,searching:!0,stateSave:!0,stateLoadParams:function(n,t){t.search.search=""},lengthMenu:[5,10,25,50,100],pageLength:50,layout:{topStart:"info",topEnd:{buttons:[{extend:"excelHtml5",text:"Excel",className:"btn btn-outline-secondary",title:"CONCEPTOS",filename:`conceptos_${o}`,exportOptions:{columns:":not(:first, :last-child)",modifier:{page:"all"},format:{body:(n,t,i,r)=>{const u=$("#tablaConceptos").DataTable(),f=u.row($(r).closest("tr")).data();return i===9?f?.TLE_Inversion?"SI":"NO":n}}}}]},bottomStart:"pageLength",bottomEnd:{paging:{buttons:10}}},pagingType:"simple_numbers",responsive:!0,language:{lengthMenu:"_MENU_ entradas por página",info:"Mostrando registros del _START_ al _END_ de un total de _TOTAL_",infoEmpty:"No hay registros disponibles",infoFiltered:"",loadingRecords:"Cargando...",zeroRecords:"No se encontraron registros",emptyTable:"No hay datos disponibles en la tabla",buttons:{copy:"Copiar",colvis:"Visibilidad"}},initComplete:function(){const n=this.api(),t=$(n.table().header());n.columns().every(t=>{const i=$("<th>");if(e.includes(t)){const u=$('<input type="text" class="form-control form-control-sm" placeholder="Filtrar..." />').appendTo(i).on("keyup change clear",function(){n.column(t).search()!==this.value&&n.column(t).search(this.value).draw()}),r=n.column(t).search();r&&u.val(r)}});$(".dt-search").hide();ocultarDivCargando()}});let h=localStorage.getItem(i);if(!h){const n=document.querySelector("#datosConceptos")?.dataset.anio;$("#ddlAño").val(n);t.column(3).search("^"+n+"$",!0,!1).draw()}$(window).resize(()=>t.columns.adjust().draw());$("#formBuscar").on("keyup input",function(){t.search(this.value,!1,!1).draw();t.responsive.rebuild();t.responsive.recalc();t.columns.adjust();t.draw(!1);r()})}catch(s){console.error("Error al obtener los conceptos de facturación:",s)}}function e(){return new Promise((n,t)=>{let i=$("#anio").val(),r=$("#mes").val(),u=$("#idTarea").val();if(!i||!r)return mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning),t(),!1;$.ajax({url:AppConfig.urls.ExportarConceptos,type:"POST",data:{anio:i,mes:r,idTarea:u},xhrFields:{responseType:"blob"},success:function(t,i,r){let f="",e=r.getResponseHeader("Content-Disposition");if(e&&e.indexOf("attachment")!==-1){let n=/filename="?([^;]+)"?/.exec(e);n.length>1&&(f=n[1])}f||(f="Exportacion_Conceptos.xlsx");let o=new Blob([t],{type:r.getResponseHeader("Content-Type")}),u=document.createElement("a");u.href=window.URL.createObjectURL(o);u.download=f;document.body.appendChild(u);u.click();document.body.removeChild(u);n()},error:function(n){const i=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,i);t()}})})}async function o(){return new Promise(n=>{$("#mensajeCargando").text("PROCESANDO..."),$("#divCargando").show(),setTimeout(n,200)})}function n(){$("#mensajeCargando").text("CARGANDO...");$("#divCargando").hide()}function s(n,t){let i="";return t?.length&&(i+=`<div class="alert alert-warning">
      <ul>${t.map(n=>`<li>${n}</li>`).join("")}</ul>
    </div>`),i+(n.length?l(n):`<p>No hay licencias pendientes este mes.</p>`)}function h(n,t){let i="";return t?.length&&(i+=`<div class="alert alert-warning">
      <ul>${t.map(n=>`<li>${n}</li>`).join("")}</ul>
    </div>`),i+a(n)}function c(n,t){let i="";return t?.length&&(i+=`<div class="alert alert-warning">
      <ul>${t.map(n=>`<li>${n}</li>`).join("")}</ul>
    </div>`),i+v(n)}function l(n){let t=`
      <table style="width:100%;border-collapse:collapse;font-size:0.9em">
        <thead>
          <tr style="background:#f0f0f0">
            <th style="padding:6px;border:1px solid #ddd">Tarea</th>
            <th style="padding:6px;border:1px solid #ddd">Empresa</th>
            <th style="padding:6px;border:1px solid #ddd;text-align:center">Periodo</th>
            <th style="padding:6px;border:1px solid #ddd">Licencias incluidas</th>
            <th style="padding:6px;border:1px solid #ddd;text-align:right">Importe</th>
          </tr>
        </thead>
        <tbody>
    `;return n.forEach(n=>{t+=`
          <tr>
            <td>${n.TAR_Nombre}</td>
            <td>${n.EmpresaNombre}</td>
            <td style="text-align:center">${n.Mes}/${n.Anyo}</td>
            <td>${n.LicenciasIncluidas}</td>
            <td style="text-align:right">${formatMoney(n.ImporteTotal)}</td>
          </tr>
        `}),t+=`
        </tbody>
      </table>
    `}function a(n){if(!n||!n.length)return"<p>No hay conceptos de soporte pendientes.<\/p>";let t="<div class='small text-start'>";return n.forEach(n=>{t+=`
      <div style="
        border:1px solid #e0e0e0;
        border-radius:8px;
        padding:10px;
        margin-bottom:12px;">
        <div class="fw-semibold mb-2" style="color:#001f3f;">
          Categoría: ${n.CategoriaNombre}
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:0.9em">
          <thead>
            <tr style="background:#f0f0f0">
              <th style="padding:6px;border:1px solid #ddd;text-align:left">Empresa</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:center">Periodo</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:right">Importe</th>
            </tr>
          </thead>
          <tbody>
    `,n.Filas.forEach(n=>{t+=`
        <tr>
          <td style="padding:6px;border:1px solid #eee">${n.EmpresaNombre}</td>
          <td style="padding:6px;border:1px solid #eee;text-align:center">${n.Mes}/${n.Anyo}</td>
          <td style="padding:6px;border:1px solid #eee;text-align:right">${formatMoney(n.ImporteTotal)}</td>
        </tr>
      `}),t+=`
          </tbody>
        </table>
      </div>
    `}),t+="<\/div>"}function v(n){if(!n||!n.length)return"<p>No hay asuntos pendientes este mes.<\/p>";let t=`
    <table style="width:100%;border-collapse:collapse;font-size:0.9em">
      <thead>
        <tr style="background:#f0f0f0">
          <th style="padding:6px;border:1px solid #ddd">Tipo</th>
          <th style="padding:6px;border:1px solid #ddd">Empresa</th>
          <th style="padding:6px;border:1px solid #ddd;text-align:center">Periodo</th>
          <th style="padding:6px;border:1px solid #ddd;text-align:right">Horas</th>
        </tr>
      </thead>
      <tbody>
  `;return n.forEach(n=>{t+=`
      <tr>
        <td>${n.TAR_Nombre}</td>
        <td>${n.EmpresaNombre}</td>
        <td style="text-align:center">${n.Mes}/${n.Anyo}</td>
        <td style="text-align:right">${n.ImporteTotal.toFixed(2)} h</td>
      </tr>
    `}),t+=`
      </tbody>
    </table>
  `}async function y(){mostrarDivCargando();try{const n=await $.ajax({url:AppConfig.urls.GenerarTodosConceptos,type:"POST",dataType:"json"});if(ocultarDivCargando(),n.errors?.length){await Swal.fire({icon:"error",title:"Errores generando conceptos",html:`<ul style="text-align:left">
                 ${n.errors.map(n=>`<li>${n}</li>`).join("")}
               </ul>`,confirmButtonText:"Entendido"});return}if(!n.success){mostrarErrorPedidos();return}const i=`
      <div style="text-align:left">
        <h5>Conceptos de Licencias</h5>
        ${p(n.licencias)}
        <hr/>
        <h5>Conceptos de Soporte</h5>
        ${w(n.soporte)}
        <hr/>
        <h5>Conceptos de Asuntos</h5>
        ${b(n.asuntos)}
      </div>
    `;await Swal.fire({title:"Proceso Completado",html:i,icon:"success"});const r=$("#tablaConceptos").DataTable();r.destroy();mostrarDivCargando();$("#tablaConceptos tbody").empty();await t();ocultarDivCargando()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}}function p(n){if(!n||n.length===0)return"<ul><li><strong>No se ha generado ningún concepto de licencia<\/strong><\/li><\/ul>";let t="<ul style='text-align: left;'>";return n.forEach(n=>{t+=`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s) generados</li>`}),t+="<\/ul>"}function w(n){if(!n||n.length===0)return"<ul><li><strong>No se ha generado ningún concepto de soporte<\/strong><\/li><\/ul>";let t="<ul style='text-align: left;'>";return n.forEach(n=>{t+=`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s) generados</li>`}),t+="<\/ul>"}function b(n){if(!n||!n.length)return"<ul><li><strong>No se ha generado ningún concepto de asuntos<\/strong><\/li><\/ul>";let t="<ul style='text-align:left;'>";return n.forEach(n=>{t+=`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s)</li>`}),t+="<\/ul>"}let i=Filtros.Conceptos;await VerificarSesionActiva(OpcionMenu.Conceptos);await u();$("#limpiarTarea").click(function(){$("#tarea").val("");$("#idTarea").val("")});$("#ddlAño").on("change",function(){let n=$(this).val(),t=$("#tablaConceptos").DataTable();n?t.column(3).search("^"+n+"$",!0,!1).draw():t.column(3).search("").draw();r()});$("#btnNuevo").on("click",function(){window.location.href=AppConfig.urls.ConceptoNuevo});$("#btnDescargarPlantilla").click(function(){window.location.href=AppConfig.urls.DescargarPlantillaConceptos});$("#btnImportarExcel").on("click",function(){$("#archivoExcel").val("");$("#archivoExcel").replaceWith($("#archivoExcel").clone());$("#modalImportar").modal("show")});$("#btnExportarConceptos").on("click",function(){$("#anio").val("");$("#mes").val("");$("#tarea").val("");$("#idTarea").val("");$("#modalEditar").modal("show")});$("#btnExportarConceptosAceptar").on("click",function(){Promise.all([e()]).then(()=>{let n=$("#tablaConceptos").DataTable();$("#modalEditar").modal("hide")}).catch(n=>{console.error("Error al cargar los datos:",n)})});$("#buscarTarea").on("click",function(){let n=$("#tablaTareasContainer");n.is(":hidden")&&(n.show(),$.fn.DataTable.isDataTable("#tablaTareas")?table.columns.adjust().draw():table=$("#tablaTareas").DataTable({ajax:{url:AppConfig.urls.ObtenerTareas,type:"GET",dataSrc:"",data:{anio:null},dataType:"json"},paging:!1,searching:!0,info:!1,ordering:!1,select:"single",scrollY:"200px",scrollCollapse:!0,language:{emptyTable:"No hay tareas disponibles",search:"Buscar:"},columns:[{data:"TAR_Nombre",title:"Tarea"},{data:"TAR_Seccion",title:"Sección"},{data:"TAR_Tipo",title:"Tipo"},{data:"TAR_ImporteUnitario",title:"Importe Unitario",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{data:"PR3_Nombre",title:"Producto (D365)"},{data:"IN3_Nombre",title:"Item number (D365)"},{data:null,title:"Visible",className:"dt-center ico-status",orderable:!1,render:function(n,t,i,r){return`
                                            <input type="checkbox" class="form-check-input"
                                                id="checkbox-${r.row}"
                                                data-index="${r.row}"
                                                data-id="${i.TAR_Id}" disabled
                                                ${i.TAR_Activo?"checked":""} />
                                        `}}],responsive:!0}))});$("#tablaTareas tbody").on("click","tr:not(.selected)",function(n){let i=$("#tablaTareas").DataTable(),t=i.row(this).data();$(n.target).closest("td").hasClass("dt-control")||t&&($("#tablaTareas tbody tr").removeClass("selected"),$("#idTarea").val(t.TAR_Id),$("#tarea").val(t.TAR_Nombre))});$("#btnSubirProcesar").click(async function(i){i.preventDefault();let r=new FormData,u=$("#archivoExcel")[0].files[0];if(!u){n();mostrarToast("Por favor, seleccione un archivo.",TipoToast.Warning);return}r.append("archivoExcel",u);$("#modalImportar").modal("hide");await o();$.ajax({url:AppConfig.urls.ImportarExcelConceptos,type:"POST",data:r,processData:!1,contentType:!1,success:function(i){if(i.success)n(),mostrarToast("Archivo importado correctamente.",TipoToast.Success),setTimeout(function(){mostrarDivCargando();$("#tablaConceptos").DataTable().destroy();t()},200);else if(i.errorFormato)n(),mostrarToast(i.message,TipoToast.Warning);else{n();i.erroresExcel===null&&registrarErrorjQuery("",i.message);let r=i.erroresExcel.map(n=>n.Errores).join("\n");if(Swal.fire({title:"Error al importar",text:"La importación se ha realizado con algunos errores. Consulte el fichero generado.",icon:"error",confirmButtonText:"Cerrar",confirmButtonColor:"#d33"}).then(n=>{n.isConfirmed&&setTimeout(function(){mostrarDivCargando();$("#tablaConceptos").DataTable().destroy();t()},200)}),i.fileUrl){let n=document.createElement("a");n.href=i.fileUrl;n.download="Errores_Importacion.xlsx";document.body.appendChild(n);n.click();document.body.removeChild(n)}}},error:function(t){n();const i=obtenerMensajeErrorAjax(t);registrarErrorjQuery(t.status,i)}})});$("#btnBuscar").on("click",function(){let i=$("#filterTarea").val(),u=$("#filterEmpresa").val(),t=$("#filterMes").val(),f=$("#filterCantidad").val(),e=$("#filterDescripcion").val(),o=$("#filterEstado").val(),s=$("#filterImporte").val(),n=$("#tablaConceptos").DataTable();n.columns(0).search("").draw();n.columns(1).search(i).draw();n.columns(2).search(u).draw();t?n.column(4).search("^"+t+"$",!0,!1).draw():n.column(4).search("").draw();n.columns(5).search(f).draw();n.columns(6).search(e).draw();n.columns(7).search(o).draw();n.columns(8).search(s).draw();r()});$("#btnGenerarConceptosLicencias").on("click",async()=>{mostrarDivCargando();try{const r=await $.ajax({url:AppConfig.urls.PrevisualizarConceptos,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8"});if(ocultarDivCargando(),!r.success){mostrarErrorPedidos();return}const{licencias:n,licenciasErrors:u,soporte:t,soporteErrors:f,asuntos:i,asuntosErrors:e}=r;if(!n.length&&!t.length&&!i.length&&!u?.length&&!f?.length&&!e?.length){await Swal.fire({title:"Nada que Generar",html:`<p>No hay conceptos pendientes ni mensajes de error.</p>`,icon:"info",confirmButtonText:"Entendido",confirmButtonColor:"#3085d6",width:500});return}const l=`
                <div class="small text-start">
                  <h5>Licencias</h5>
                  ${s(n,u)}
                  <hr/>
                  <h5>Soporte CAU</h5>
                  ${h(t,f)}
                  <hr/>
                  <h5>Asuntos Proveedores</h5>
                  ${c(i,e)}
                </div>`,o=n.length>0||t.length>0||i.length>0,{isConfirmed:a}=await Swal.fire({title:"¿Deseas generar los conceptos?",html:l,width:"70%",showCancelButton:!0,cancelButtonText:o?"No, cancelar":"Cerrar",showConfirmButton:o,confirmButtonText:"Sí, generar"});a&&await y()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}})});