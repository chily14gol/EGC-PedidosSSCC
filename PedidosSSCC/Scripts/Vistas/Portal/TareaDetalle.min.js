function CargarComboAprobadores(n,t){$.ajax({url:AppConfig.urls.ObtenerAprobadoresEmpresas,type:"GET",dataType:"json",data:{idEmpresa:n},success:function(n){let i=$("#aprobador");i.empty();$.each(n,function(n,t){i.append('<option value="'+t.EMA_PER_Id+'">'+t.NombrePersona+"<\/option>")});t!=null&&$("#aprobador").val(t)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}function editarVerTareaEmpresa(n,t,i,r){$.ajax({url:AppConfig.urls.ObtenerTareaEmpresa,type:"GET",data:{idTarea:n,idEmpresa:t,anio:i},dataType:"json",success:function(n){$("#empresa").val(n.TEM_EMP_Id);CargarComboAprobadores(n.TEM_EMP_Id,n.TEM_PER_Id_Aprobador);$("#anio").val(n.TEM_Anyo);$("#tipo").val()===Tipo.CANTIDAD_FIJA?$("#presupuestoUnidades").val((n.TEM_Presupuesto??"").toString().replace(".",",")):$("#presupuestoUnidades").val((n.TEM_Elementos??"").toString().replace(".",","));$("#empresa").prop("disabled",!0);r=="ver"?($("#modalEditarLabel").text("Ver empresa"),$("#aprobador").prop("disabled",!0),$("#presupuestoUnidades").prop("disabled",!0),$("#btnGuardarEmpresa").hide(),$("#modoEdicion").val("ver")):($("#modalEditarLabel").text("Editar empresa"),$("#aprobador").prop("disabled",!1),$("#presupuestoUnidades").prop("disabled",!1),$("#btnGuardarEmpresa").show(),$("#modoEdicion").val("editar"));$("#modalEditar").modal("show")},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}function eliminarTareaEmpresa(n,t,i,r){Swal.fire({title:`¿Estás seguro de que deseas eliminar la empresa ${r}?`,icon:"warning",showCancelButton:!0,customClass:{confirmButton:"btn btn-lg btn-primary",cancelButton:"btn btn-lg btn-outline-secondary"},confirmButtonText:"Sí, continuar",cancelButtonText:"No, cancelar"}).then(r=>{r.isConfirmed&&$.ajax({url:AppConfig.urls.EliminarTareaEmpresa,type:"POST",data:{idTarea:n,idEmpresa:t,anio:i},success:function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);$("#modalEditar").modal("hide");let n=$("#table").DataTable();n.ajax.reload(null,!1)}else mostrarToast("No se puede eliminar. La empresa/año esta asociada a un concepto",TipoToast.Warning)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})})}function guardarEmpresa(){let r=AppConfig.IdTarea,u=$("#empresa").val(),f=$("#aprobador").val(),e=$("#anio").val(),i=$("#presupuestoUnidades").val(),o=$("#tipo").val(),s=$("#modoEdicion").val(),n=[];if(validarCampo("#empresa","empresa",n),validarCampo("#aprobador","Aprobador",n),validarCampo("#anio","Año",n),validarCampo("#presupuestoUnidades","Presupuesto / Cantidad",n),n.length>0){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}let t={idTarea:r,idEmpresa:u,anio:e,idAprobador:f};o===Tipo.CANTIDAD_FIJA?(t.unidades=1,t.presupuesto=i):(t.unidades=i,t.presupuesto=0);$.ajax({url:AppConfig.urls.CrearTareaEmpresa,type:"POST",data:t,dataType:"json",success:function(n){if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);$("#modalEditar").modal("hide");let n=$("#table").DataTable();n.ajax.reload(function(){s==="editar"&&resaltarFilaPorId(sessionStorage.getItem("ultimaFilaEditada"))},!1)}else{const t=n.message||"Error en la operación";mostrarToast(t,TipoToast.Warning)}},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}const urlParams=new URLSearchParams(window.location.search),mode=urlParams.get("mode");document.addEventListener("DOMContentLoaded",function(){mode==="view"&&(document.querySelectorAll("input, textarea, select").forEach(n=>{n.setAttribute("disabled","disabled")}),$("#btnGuardar").hide(),$("#btnNuevaEmpresa").hide())});$(document).ready(function(){function t(){return cargarComboGenerico(AppConfig.urls.ObtenerComboSecciones,"#seccion","SEC_Id","SEC_Nombre",!0)}function i(){return cargarComboGenerico(AppConfig.urls.ObtenerComboTipos,"#tipo","TTA_Id","TTA_Nombre",!0)}function r(){return cargarComboGenerico(AppConfig.urls.ObtenerComboUnidades,"#unidad","UTI_UTA_Id","UTI_Nombre",!0)}function u(){return $.ajax({url:AppConfig.urls.ObtenerComboProductosD365,type:"GET",dataType:"json",success:function(n){rellenarCombo("#producto",n,"PR3_Id","PR3_Nombre")},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}function f(){const n="combo_item_number",t=sessionStorage.getItem(n);if(t){const n=JSON.parse(t);return rellenarCombo("#itemNumber",n,"IN3_Id","IN3_Nombre"),Promise.resolve()}return $.ajax({url:AppConfig.urls.ObtenerComboItemNumber,type:"GET",dataType:"json",success:function(t){sessionStorage.setItem(n,JSON.stringify(t));rellenarCombo("#itemNumber",t,"IN3_Id","IN3_Nombre")},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}function e(){return cargarComboGenerico(AppConfig.urls.ObtenerComboEmpresas,"#empresa","EMP_Id","EMP_Nombre",!0)}function o(){return new Promise(t=>{$.ajax({url:AppConfig.urls.CargarConfiguracionAnio,type:"GET",dataType:"json",success:function(i){$("#anio").val(i);n=i;t()},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})})}async function s(n){$.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:AppConfig.urls.ObtenerTareaDetalle,data:{idTarea:n},dataType:"json",success:function(n){$("#nombre").val(n.TAR_Nombre);$("#seccion").val(n.TAR_SEC_Id);$("#tipo").val(n.TAR_TTA_Id);$("#iva").val(n.TAR_TipoIva);$("#importeUnitario").val(n.TAR_ImporteUnitario);String(n.TAR_TTA_Id)===Tipo.POR_HORAS?($(".campo-importeUnitario").show(),$(".campo-unidad").hide(),$("#labelPresupuesto").text("Unidades *")):String(n.TAR_TTA_Id)===Tipo.POR_UNIDADES?($(".campo-importeUnitario").show(),$(".campo-unidad").show(),$("#labelPresupuesto").text("Unidades *")):String(n.TAR_TTA_Id)===Tipo.CANTIDAD_FIJA&&($(".campo-importeUnitario").hide(),$(".campo-unidad").hide(),$("#labelPresupuesto").text("Presupuesto *"));let t=n.TAR_UTA_Id,i=$("#unidad");i.find('option[value="'+t+'"]').length>0&&i.val(t);let r=n.TAR_PR3_Id,u=$("#producto");u.find('option[value="'+r+'"]').length>0&&u.val(r);let f=n.TAR_IN3_Id,e=$("#itemNumber");e.find('option[value="'+f+'"]').length>0&&e.val(f);let o=$("#visible");o.prop("checked",n.TAR_Activo)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}function h(t){let i=!1,u=JSON.parse(sessionStorage.getItem("permisos"))||[],r=u.find(n=>n.SPO_SOP_Id===OpcionMenu.Tareas);r&&r.SPO_Escritura===!0&&(i=!0);i||$("#btnNuevaEmpresa").hide();let f=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.ObtenerTareaEmpresas,type:"GET",dataSrc:"",data:{idTarea:t},dataType:"json"},rowId:function(n){return`fila-${n.TEM_TAR_Id}-${n.TEM_EMP_Id}-${n.TEM_Anyo}`},columns:[{data:"EmpresaNombre",title:"Empresa"},{data:"TEM_Anyo",title:"Año"},{data:"TEM_Elementos",title:"Unidades"},{data:"TEM_Presupuesto",title:"Presupuesto",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',orderable:!1,render:function(t,r,u){return u.TEM_Anyo==n&&i?`
                                <button type="button" class="btn btn-icon btn-editar btn-outline-secondary"
                                    onclick="editarVerTareaEmpresa(${u.TEM_TAR_Id}, ${u.TEM_EMP_Id}, ${u.TEM_Anyo}, 'editar')">
                                    <i class="bi bi-pencil-square" title="Editar"></i>
                                </button>
                                <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
                                    onclick="eliminarTareaEmpresa(${u.TEM_TAR_Id}, ${u.TEM_EMP_Id}, ${u.TEM_Anyo}, '${u.EmpresaNombre}')">
                                    <i class="bi bi-trash" title="Eliminar"></i>
                                </button>`:`
                                <button type="button" class="btn btn-icon btn-detalle btn-outline-secondary"
                                    onclick="editarVerTareaEmpresa(${u.TEM_TAR_Id}, ${u.TEM_EMP_Id}, ${u.TEM_Anyo}, 'ver')">
                                    <i class="bi bi-eye-fill" title="Ver"></i>
                                </button>`}}]},[],"export_tarea_empresas");$(window).on("resize",function(){f.columns.adjust().responsive.recalc()})}let n;tienePermiso(OpcionMenu.EdicionPresupuestos)?$("#btnNuevaEmpresa").show():$("#btnNuevaEmpresa").hide();VerificarSesionActiva(OpcionMenu.Tareas).then(()=>{Promise.all([t(),i(),r(),u(),f(),e(),o()]).then(async()=>{let n=AppConfig.IdTarea;await s(n);h(n);ocultarDivCargando()}).catch(n=>{mostrarToast(n,TipoToast.Error)})});$("#empresa").change(function(){let n=$(this).val();CargarComboAprobadores(n)});$("#tipo").change(function(){let n=$(this).val();n===Tipo.POR_HORAS?($(".campo-importeUnitario").show(),$(".campo-unidad").hide(),$("#labelPresupuesto").text("Unidades *")):n===Tipo.POR_UNIDADES?($(".campo-importeUnitario").show(),$(".campo-unidad").show(),$("#labelPresupuesto").text("Unidades *")):n===Tipo.CANTIDAD_FIJA&&($(".campo-importeUnitario").hide(),$(".campo-unidad").hide(),$("#labelPresupuesto").text("Presupuesto *"))});$("#btnGuardar").on("click",function(n){n.preventDefault();let t={TAR_Id:AppConfig.IdTarea,TAR_Nombre:$("#nombre").val(),TAR_SEC_Id:$("#seccion").val(),TAR_TTA_Id:$("#tipo").val(),TAR_TipoIva:$("#iva").val(),TAR_ImporteUnitario:$("#importeUnitario").val(),TAR_UTA_Id:$("#unidad").val(),TAR_PR3_Id:$("#producto").val(),TAR_IN3_Id:$("#itemNumber").val(),TAR_Activo:$("#visible").is(":checked")};$.ajax({url:AppConfig.urls.GuardarTarea,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(t),success:function(n){n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),window.location.href=AppConfig.urls.BusquedaTareas):mostrarToast("Error en la operacion",TipoToast.Error)},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})});$("#btnCancelar").on("click",function(n){n.preventDefault();window.location.href=AppConfig.urls.BusquedaTareas});$("#btnNuevaEmpresa").on("click",function(){$("#modalEditarLabel").text("Alta de empresa");$("#empresa").val("").prop("disabled",!1);$("#presupuestoUnidades").val("").prop("disabled",!1);$("#aprobador").val("").prop("disabled",!1);$("#btnGuardarEmpresa").show();$("#modalEditar").modal("show")})});