const urlParams=new URLSearchParams(window.location.search),mode=urlParams.get("mode"),TIPO_CANTIDAD_FIJA=3;document.addEventListener("DOMContentLoaded",function(){mode==="view"&&(document.querySelectorAll("input, textarea, select").forEach(n=>{n.setAttribute("disabled","disabled")}),$("#datosSolicitud").show(),$("#btnGuardar").hide())});$(document).ready(function(){function t(){return new Promise((n,t)=>{$.ajax({url:AppConfig.urls.ObtenerComboTareaEmpresa,type:"GET",data:{verTodas:!0},dataType:"json",success:function(t){let i=$("#tareaEmpresa");i.empty();i.append(`<option value=""></option>`);$.each(t,function(n,t){i.append(`<option value="${t.TEM_TAR_Id}|${t.TEM_EMP_Id}|${t.TEM_Anyo}">${t.EmpresaNombre}</option>`)});n()},error:function(n,i,r){const u=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,u);t(r)}})})}function i(n){return new Promise((t,i)=>{$.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:AppConfig.urls.ObtenerConceptoDetalle,data:{idConcepto:n},dataType:"json",success:function(n){$("#anioConcepto").val(n.TLE_Anyo);$("#mesConcepto").val(n.TLE_Mes);$("#presupuesto").val(formatNumber(n.TEM_Presupuesto));$("#presupuestoConsumido").val(formatNumber(n.TEM_PresupuestoConsumido));$("#cantidad").val(formatNumber(n.TLE_Cantidad));$("#importeUnitario").val(formatNumber(n.TAR_ImporteUnitario));$("#descripcion").val(n.TLE_Descripcion);$("#inversion").prop("checked",n.TLE_Inversion);$("#estado").val(n.EstadoNombre);$("#fechaAprobacion").val(n.TLE_FechaAprobacion);$("#comentarios").val(n.TLE_ComentarioAprobacion);$("#aprobador").val(n.PersonaAprobador);let e=n.TLE_TAR_Id,o=n.TLE_EMP_Id,s=n.TLE_Anyo,i=e+"|"+o+"|"+s,h=n.TLE_ESO_Id;h==EstadosSolicitud.SinSolicitar&&$("#btnSolicitar").show();let r=$("#tareaEmpresa");r.find('option[value="'+i+'"]').length>0?r.val(i):console.warn("El valor de la tarea empresa no está en el combo. Asegúrate de que esté cargado.");let u=parseFloat(n.TLE_Cantidad)||0,c=parseFloat(n.TAR_ImporteUnitario)||0,f;f=n.TAR_TTA_Id===TIPO_CANTIDAD_FIJA?u:u*c;$("#importeTotal").val(formatNumber(f));t(n)},error:function(n,t,r){const u=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,u);i(r)}})})}function r(n){n===TIPO_CANTIDAD_FIJA?$(".filaImporteYCantidad").hide():$(".filaImporteYCantidad").show()}function u(){let t=$("#tareaEmpresa").val(),r=$("#anioConcepto").val(),u=$("#mesConcepto").val(),i=$("#cantidad").val(),n=[];return(t&&t.length!==0?$(".select2-selection__placeholder").css("color","black"):($(".select2-selection__placeholder").css("color","red"),n.push("tareaEmpresa")),$(".filaImporteYCantidad").is(":visible")&&(i?$("#cantidad").removeClass("is-invalid"):($("#cantidad").addClass("is-invalid"),n.push("cantidad"))),n.length>0)?(mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning),!1):!0}function n(n){if(u()){mostrarDivCargando();let t=$("#tareaEmpresa").val().split("|"),i=t[0],r=t[1],f=t[2],e=$(".filaImporteYCantidad").is(":visible")?$("#cantidad").val():1,h=$(".filaImporteYCantidad").is(":visible")?$("#importeUnitario").val():0,o=window.IdConcepto,s={TLE_Id:o,TLE_TAR_Id:i,TLE_EMP_Id:r,TLE_Anyo:f,TLE_Mes:$("#mesConcepto").val(),TLE_Cantidad:e,TLE_Descripcion:$("#descripcion").val(),TLE_Inversion:$("#inversion").prop("checked"),TLE_ESO_Id:n};$.ajax({url:AppConfig.urls.GuardarConcepto,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(s),success:function(n){n.success?(n.ok_email||(sessionStorage.setItem("toastMensaje",n.mensaje_email),sessionStorage.setItem("toastTipo","error"),sessionStorage.setItem("errorEmail",!0)),window.location.href=AppConfig.urls.BusquedaConceptos):registrarErrorjQuery("",n.message)},error:function(n,t,i){const r=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,r);registrarErrorjQuery(t,i)}})}}function f(n){const t=inicializarDataTable("#tableLicenciasMS",{ajax:{url:AppConfig.urls.ObtenerLicenciasMs,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"Licencia",title:"Licencia"},{data:"Entidad",title:"Entidad"},{data:"Importe",title:"Importe",className:"text-end",render:formatNumber}]},[],"export_licencias_ms");t.on("xhr",function(){const i=t.ajax.json()||[];if(i.length>0){$("#divLicenciasMS").show();$("#btnExportarLicenciasMS").off("click").on("click",function(){const t=AppConfig.urls.ExportarLicenciasMS+"?idConcepto="+encodeURIComponent(n);window.location.href=t})}else $("#divLicenciasMS").hide()})}function e(n){const t=inicializarDataTable("#tableTickets",{ajax:{url:AppConfig.urls.ObtenerTicketsConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"TicketId",title:"Ticket GLPI"},{data:"DescripcionTicket",title:"Título ticket"},{data:"Entidad",title:"Entidad"},{data:"TKC_Duracion",title:"Duración (min)",className:"text-end",render:n=>n??""},{data:"Importe",title:"Importe",className:"text-end",render:formatNumber},{data:null,title:"Acción",orderable:!1,className:"text-center",render:function(n){const t=$("<div/>").text(JSON.stringify(n)).html();return`
                      <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        data-ticket='${t}'
                        onclick="verDetalleTicketConcepto(this)">
                        <i class="bi bi-eye-fill"></i>
                      </button>`}}]},[],"export_tickets_concepto");t.on("xhr",function(){const i=t.ajax.json()||[];if(i.length>0){$("#divTickets").show();$("#btnExportarTickets").off("click").on("click",function(){const t=AppConfig.urls.ExportarTicketsConcepto+"?idConcepto="+encodeURIComponent(n);window.location.href=t})}else $("#divTickets").hide()})}function o(n){const t=inicializarDataTable("#tablePartes",{ajax:{url:AppConfig.urls.ObtenerPartesConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"PPA_PEP_Anyo",title:"Año"},{data:"PPA_PEP_Mes",title:"Mes"},{data:"ProyectoNombre",title:"Proyecto"},{data:"Actividad",title:"Actividad"},{data:"Persona",title:"Persona"},{data:"TCP_Fecha",title:"Fecha",render:function(n,t){if(!n)return"";var i=moment(n);return t==="sort"||t==="type"?i.valueOf():i.format("DD/MM/YYYY")}},{data:"TCP_Horas",title:"Horas",className:"text-end",render:formatNumber}]},[],"export_partes_concepto");t.on("xhr",function(){const n=t.ajax.json()||[];n.length>0?$("#divPartes").show():$("#divPartes").hide()})}function s(n){const t=inicializarDataTable("#tableAplicaciones",{ajax:{url:AppConfig.urls.ObtenerAplicacionesPorConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"NombreAplicacion",title:"Aplicación"},{data:"NombreEntidad",title:"Entidad"},{data:"TCA_Importe",title:"Importe",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}}]},[],"export_aplicaciones_concepto");t.on("xhr",function(){const n=t.ajax.json()||[];n.length?$("#divAplicaciones").show():$("#divAplicaciones").hide()})}function h(n){const t=inicializarDataTable("#tableModulos",{ajax:{url:AppConfig.urls.ObtenerModulosPorConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"NombreModulo",title:"Módulo"},{data:"TCM_Importe",title:"Importe",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}}]},[],"export_modulos_concepto");t.on("xhr",function(){const n=t.ajax.json()||[];n.length?$("#divModulos").show():$("#divModulos").hide()})}function c(n){const t=inicializarDataTable("#tableModulosReparto",{ajax:{url:AppConfig.urls.ObtenerModulosRepartoPorConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"NombreModulo",title:"Módulo"},{data:"TCR_ImporteTotal",title:"Importe a repartir",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{data:"TCR_Porcentaje",title:"Porcentaje",className:"text-end",render:n=>formatPorcentaje(n)},{data:"TCR_Importe",title:"Importe",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}}]},[],"export_modulos_reparto_concepto");t.on("xhr",function(){const n=t.ajax.json()||[];n.length?$("#divModulosReparto").show():$("#divModulosReparto").hide()})}function l(n){const t=inicializarDataTable("#tableProveedoresAsuntos",{ajax:{url:AppConfig.urls.ObtenerProveedoresAsuntosPorConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"NombreAsunto",title:"Asunto"},{data:"NombreContrato",title:"Contrato Proveedor",className:"dt-body-right dt-head-right"},{data:"Entidad",title:"Entidad",className:"dt-body-right dt-head-right"},{data:"Departamento",title:"Departamento",className:"dt-body-right dt-head-right"},{data:"TCA_Horas",title:"Horas",className:"dt-body-right dt-head-right",type:"string"},{data:"TCA_Importe",title:"Importe",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}}]},[],"export_prov_asuntos_concepto");t.on("xhr",function(){const i=t.ajax.json()||[];if(i.length>0){$("#divProveedoresAsuntos").show();$("#btnExportarAsuntos").off("click").on("click",function(){const t=AppConfig.urls.ExportarAsuntosConcepto+"?idConcepto="+encodeURIComponent(n);window.location.href=t})}else $("#divProveedoresAsuntos").hide()})}function a(n){const t=inicializarDataTable("#tableLicenciasAnuales",{ajax:{url:AppConfig.urls.ObtenerLicenciasAnualesPorConcepto,type:"GET",data:{idConcepto:n},dataSrc:""},paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",columns:[{data:"NombreLicenciaAnual",title:"Licencia Anual"},{data:"NombreEntidad",title:"Entidad"},{data:"TCL_Importe",title:"Importe",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}}]},[],"export_lic_anuales_concepto");t.on("xhr",function(){const n=t.ajax.json()||[];n.length?$("#divLicenciasAnuales").show():$("#divLicenciasAnuales").hide()})}VerificarSesionActiva(OpcionMenu.Conceptos).then(()=>t()).then(()=>{let n=window.IdConcepto;return i(n).then(t=>{f(n),e(n),o(n),s(n),h(n),c(n),l(n),a(n),r(t.TAR_TTA_Id,t.TLE_Cantidad,t.TAR_ImporteUnitario)})}).then(()=>{ocultarDivCargando()}).catch(n=>{console.error("Error al cargar los datos:",n),ocultarDivCargando()});$("#btnGuardar").on("click",function(t){t.preventDefault();n(EstadosSolicitud.SinSolicitar)});$("#btnSolicitar").on("click",function(t){t.preventDefault();n(EstadosSolicitud.PendienteAprobacion)});$("#btnCancelar").on("click",function(n){n.preventDefault();window.location.href=AppConfig.urls.BusquedaConceptos})});window.verDetalleTicketConcepto=function(n){const t=JSON.parse(n.getAttribute("data-ticket")),r=n=>n?moment(n).format("DD/MM/YYYY"):"",i=n=>(n??"")+"";$("#v_TKC_Id_GLPI").text(i(t.TKC_Id_GLPI));$("#v_TKC_Titulo").text(i(t.TKC_Titulo));$("#v_TKC_GrupoAsignado").text(i(t.TKC_GrupoAsignado));$("#v_TKC_Categoria").text(i(t.TKC_Categoria));$("#v_TKC_CTK_Id").text(i(t.TKC_CTK_Id));$("#v_TKC_Ubicacion").text(i(t.TKC_Ubicacion));$("#v_TKC_Duracion").text(i(t.TKC_Duracion));$("#v_TKC_Descripcion").text(i(t.TKC_Descripcion));$("#v_TKC_ETK_Id").text(i(t.TKC_ETK_Id));$("#v_TKC_TTK_Id").text(i(t.TKC_TTK_Id));$("#v_TKC_OTK_Id").text(i(t.TKC_OTK_Id));$("#v_TKC_VTK_Id").text(i(t.TKC_VTK_Id));$("#v_TKC_ENT_Id_Solicitante").text(i(t.TKC_ENT_Id_Solicitante));$("#v_TKC_ProveedorAsignado").text(i(t.TKC_ProveedorAsignado));$("#v_TKC_GrupoCargo").text(i(t.TKC_GrupoCargo));$("#v_TKC_FechaApertura").text(r(t.TKC_FechaApertura));$("#v_TKC_FechaResolucion").text(r(t.TKC_FechaResolucion));$("#modalTicketDetalle").modal("show")};