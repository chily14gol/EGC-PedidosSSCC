function verTarea(n){let t=JSON.parse(n.getAttribute("data-tarea"));window.location.href=`TareaDetalle/${t.TAR_Id}?mode=view`}function editarTarea(n){let t=JSON.parse(n.getAttribute("data-tarea"));window.location.href=`TareaDetalle/${t.TAR_Id}?mode=edit`}async function eliminarTarea(n){const t=JSON.parse(n.getAttribute("data-tarea"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar la tarea '${t.TAR_Nombre}'?`,onConfirmar:async function(){try{const n=await $.ajax({url:AppConfig.urls.EliminarTarea,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idTarea:t.TAR_Id}),dataType:"json"});if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);const n=$("#tablaTareas").DataTable();n.ajax.reload(null,!1)}else mostrarToast("No se puede eliminar la tarea ya que tiene empresas asociadas.",TipoToast.Warning)}catch(n){registrarErrorjQuery(n.status||"error",n.message||n)}}})}function generarBotonesPedido(n,t){const i=`data-tarea="${JSON.stringify(n).replace(/"/g,"&quot;")}"`;return t?`
    <button type="button" class="btn btn-icon btn-editar btn-outline-secondary"
        ${i}
        onclick="editarTarea(this)">
        <i class="bi bi-pencil-square" title="Editar"></i>
    </button>
    <button type="button" class="btn btn-icon btn-eliminar btn-outline-secondary"
        ${i}
        onclick="eliminarTarea(this)">
        <i class="bi bi-trash" title="Eliminar"></i>
    </button>`:`
    <button type="button" class="btn btn-icon btn-detalle btn-outline-secondary"
        ${i}
        onclick="verTarea(this)">
        <i class="bi bi-eye-fill" title="Ver"></i>
    </button>`}function guardarFiltros(){let n=$("#formBuscar").val(),t=$("#ddlAño").val(),i=$("#filterTarea").val(),r=$("#filterSeccion").val(),u=$("#filterTipo").val(),f=$("#filterImporte").val(),e=$("#filterProducto").val(),o=$("#filterItemNumber").val(),s={general:n,anio:t,tarea:i,seccion:r,tipo:u,importe:f,producto:e,itemNumber:o};localStorage.setItem(storageKey,JSON.stringify(s))}async function ObtenerTareas(){let t=!1,r=JSON.parse(sessionStorage.getItem("permisos"))||[],i=r.find(n=>n.SPO_SOP_Id===OpcionMenu.Tareas);i&&i.SPO_Escritura===!0&&(t=!0);let n=inicializarDataTable("#tablaTareas",{ajax:{url:AppConfig.urls.ObtenerTareas,type:"GET",dataSrc:"",dataType:"json"},columns:[{data:"Anios",title:"Anios",visible:!1},{data:"TAR_Nombre",title:"Tarea"},{data:"TAR_Seccion",title:"Sección"},{data:"TAR_Tipo",title:"Tipo"},{data:"TAR_ImporteUnitario",title:"Importe Unitario",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{data:"PR3_Nombre",title:"Producto (D365)"},{data:"IN3_Nombre",title:"Item number (D365)"},{className:"dt-center ico-status",data:null,title:"Visible",orderable:!1,render:function(n,t,i,r){return`
    <input type="checkbox" class="form-check-input"
        id="checkbox-${r.row}"
        data-index="${r.row}"
        data-id="${i.TAR_Id}" disabled
        ${i.TAR_Activo?"checked":""} />
    `}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,i,r){return generarBotonesPedido(r,t)}}]},[],"export_tareas");$(window).resize(function(){n.columns.adjust().draw()});$("#formBuscar").on("keyup input",function(){n.search(this.value,!1,!1).draw();n.responsive.rebuild();n.responsive.recalc();n.columns.adjust();n.draw(!1);guardarFiltros()})}let storageKey=Filtros.Tareas;$(document).ready(async function(){async function t(){let n=localStorage.getItem(storageKey),t=!1;if(n){n=JSON.parse(n);$("#formBuscar").val(n.general);$("#ddlAño").val(n.anio);$("#filterTarea").val(n.tarea||"");$("#filterSeccion").val(n.seccion||"");$("#filterTipo").val(n.tipo||"");$("#filterImporte").val(n.importe||"");$("#filterProducto").val(n.producto||"");$("#filterItemNumber").val(n.itemNumber||"");let{...otrosFiltros}=n;t=Object.values(otrosFiltros).some(n=>n!==""&&n!==null&&n!==undefined)}await ObtenerTareas();setTimeout(function(){let t=$("#tablaTareas").DataTable();n?.general&&t.search(n.general,!1,!1).draw()},200);t&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}async function i(){return new Promise(n=>{$("#mensajeCargando").text("PROCESANDO..."),$("#divCargando").show(),setTimeout(n,200)})}function n(){$("#mensajeCargando").text("CARGANDO...");$("#divCargando").hide()}await VerificarSesionActiva(OpcionMenu.Tareas);await t();$("#ddlAño").on("change",function(){let n=$(this).val(),t=$("#tablaTareas").DataTable();n?t.column(0).search(n).draw():t.column(0).search("").draw();guardarFiltros()});$("#btnNuevo").on("click",function(){window.location.href=AppConfig.urls.TareaNueva});$("#btnDescargarPlantilla").click(function(){window.location.href=AppConfig.urls.DescargarPlantillaTareasEmpresas});$("#btnImportarExcel").on("click",function(){$("#archivoExcel").val("");$("#archivoExcel").replaceWith($("#archivoExcel").clone());$("#modalImportar").modal("show")});$("#btnSubirProcesar").click(async function(t){t.preventDefault();let r=new FormData,u=$("#archivoExcel")[0].files[0];if(!u){mostrarToast("Por favor, seleccione un archivo.",TipoToast.Error);return}r.append("archivoExcel",u);$("#modalImportar").modal("hide");await i();$.ajax({url:AppConfig.urls.ImportarExcelTareas,type:"POST",data:r,processData:!1,contentType:!1,success:function(t){if(t.success)n(),mostrarToast("Archivo importado correctamente.",TipoToast.Success),setTimeout(function(){mostrarDivCargando();$("#tablaTareas").DataTable().destroy();ObtenerTareas()},200);else if(t.excelErroneo)n(),mostrarToast(t.mensajeExcelErroneo,TipoToast.Error);else{n();t.erroresExcel===null&&registrarErrorjQuery("",t.message);let i=t.erroresExcel.map(n=>n.Errores).join("\n");if(Swal.fire({title:"Error al importar",text:"La importación se ha realizado con algunos errores. Consulte el fichero generado.",icon:"error",confirmButtonText:"Cerrar",confirmButtonColor:"#d33"}).then(n=>{n.isConfirmed&&setTimeout(function(){mostrarDivCargando();$("#tablaTareas").DataTable().destroy();ObtenerTareas()},200)}),t.fileUrl){let n=document.createElement("a");n.href=t.fileUrl;n.download="Errores_Importacion.xlsx";document.body.appendChild(n);n.click();document.body.removeChild(n)}}},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})});$("#btnBuscar").on("click",function(){let t=$("#filterTarea").val(),i=$("#filterSeccion").val(),r=$("#filterTipo").val(),u=$("#filterImporte").val(),f=$("#filterProducto").val(),e=$("#filterItemNumber").val(),n=$("#tablaTareas").DataTable();n.columns(1).search(t).draw();n.columns(2).search(i).draw();n.columns(3).search(r).draw();n.columns(4).search(u).draw();n.columns(5).search(f).draw();n.columns(6).search(e).draw();guardarFiltros()})});