async function cargarCombosTelefonia(){try{const i=await $.getJSON(AppConfig.urls.ObtenerComboEmpresas),n=$("#TFN_EMP_Id");n.empty().append('<option value="">-- Seleccione --<\/option>');i.forEach(t=>{n.append(`<option value="${t.EMP_Id}">${t.EMP_Nombre}</option>`)});const r=await $.getJSON(AppConfig.urls.ObtenerComboEmpresas),t=$("#TFN_Planta_EMP_Id");t.empty().append('<option value="">-- Seleccione --<\/option>');r.forEach(n=>{t.append(`<option value="${n.EMP_Id}">${n.EMP_Nombre}</option>`)})}catch(n){console.error("Error cargando combos:",n)}}async function ObtenerTelefonia(){tablaDatos=inicializarDataTable("#tablaTelefonia",{serverSide:!0,processing:!0,ajax:{url:AppConfig.urls.ObtenerTelefonias,type:"POST",dataType:"json",cache:!1,dataSrc:function(n){return console.log("Datos recibidos del servidor:",n),n.data}},columns:[{data:"TFN_Anyo"},{data:"TFN_Mes"},{data:"TipoNombre"},{data:"EmpresaNombre"},{data:"TFN_Planta_EMP_Id"},{data:"TFN_Planta_Departamento"},{data:"TFN_Planta_Sede"},{data:"TFN_Planta_Uso"},{data:"TFN_Ciclo"},{data:"TFN_NumFactura"},{data:"TFN_NumCuenta"},{data:"TFN_Categoria"},{data:"TFN_Telefono"},{data:"TFN_Extension"},{data:"TFN_TipoCuota"},{data:"TFN_Bytes"},{data:"TFN_Importe",render:n=>n!=null?parseFloat(n).toFixed(2):""},{data:"TFN_FechaInicio",title:"Fecha Inicio",type:"date",render:function(n){if(!n)return"";let t=moment(n);return(t.isValid()||(t=moment(n,"DD/MM/YYYY HH:mm:ss")),!t.isValid())?n:`<span data-order="${t.unix()}">${t.format("DD/MM/YYYY")}</span>`}},{data:"TFN_FechaFin",title:"Fecha Inicio",type:"date",render:function(n){if(!n)return"";let t=moment(n);return(t.isValid()||(t=moment(n,"DD/MM/YYYY HH:mm:ss")),!t.isValid())?n:`<span data-order="${t.unix()}">${t.format("DD/MM/YYYY")}</span>`}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`
                        <button class="btn btn-icon btn-outline-secondary"
                                onclick="abrirModalTelefonia(this)"
                                data-record="${r}">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-icon btn-outline-danger"
                                onclick="eliminarTelefonia(this)"
                                data-record="${r}">
                          <i class="bi bi-trash"></i>
                        </button>`}}]},[],"export_vodafone");$("#tablaTelefonia").on("processing.dt",function(n,t,i){i?mostrarDivCargando():ocultarDivCargando()});$(window).resize(()=>tablaDatos.columns.adjust().draw());$("#formBuscar").on("keyup input",function(){tablaDatos.search(this.value,!1,!1).draw()});return tablaDatos}function abrirModalTelefonia(n){const t=JSON.parse(n.getAttribute("data-record")),i=moment(t.TFN_FechaInicio).format("YYYY-MM-DD"),r=moment(t.TFN_FechaFin).format("YYYY-MM-DD");$("#TFN_FechaInicio").val(i);$("#TFN_FechaFin").val(r);Object.keys(t).forEach(n=>{const i=document.getElementById(n);if(i)if((n==="TFN_FechaInicio"||n==="TFN_FechaFin")&&t[n]){const i=new Date(t[n])}else i.value=t[n]??""});$("#modalTelefoniaLabel").text("Edición Telefónica");$("#modalTelefonia").modal("show")}function eliminarTelefonia(n){const t=JSON.parse(n.getAttribute("data-record"));mostrarAlertaConfirmacion({titulo:`Eliminar registro TFN_Id ${t.TFN_Id}?`,onConfirmar:async()=>{try{const n=await $.ajax({url:AppConfig.urls.EliminarTelefonia,method:"POST",contentType:"application/json",data:JSON.stringify({idTelefonia:t.TFN_Id})});n.success?($("#tablaTelefonia").DataTable().ajax.reload(null,!1),mostrarToast("Eliminado con éxito",TipoToast.Success)):mostrarToast(n.message||"No se pudo eliminar",TipoToast.Warning)}catch{mostrarToast("Error de conexión",TipoToast.Error)}}})}$(document).ready(async function(){await VerificarSesionActiva(OpcionMenu.TelefoniaDatos);await cargarCombosTelefonia();await ObtenerTelefonia();ocultarDivCargando();$("#btnNuevo").click(()=>{$("#formTelefonia")[0].reset(),$("#TFN_Id").val(""),$("#modalTelefoniaLabel").text("Alta Telefónica"),$("#modalTelefonia").modal("show")});$("#btnImportarExcel").on("click",function(){$("#archivoExcel").val("");$("#modalImportar").modal("show")});$("#btnSubirProcesar").click(async function(n){n.preventDefault();let r=$("#archivoExcel")[0].files[0],u=$('input[name="tipoImportacion"]:checked').val(),t=new FormData;t.append("archivoExcel",r);$("#modalImportar").modal("hide");mostrarDivCargando();try{let e=u==="roaming"?AppConfig.urls.ImportarExcelTelefoniaRoaming:AppConfig.urls.ImportarExcelTelefonia;const n=await $.ajax({url:e,type:"POST",data:t,processData:!1,contentType:!1});if(ocultarDivCargando(),n.success){const t=n.rowsInserted??n.count??null;mostrarToast(t!=null?`Archivo importado correctamente (${t} registros).`:"Archivo importado correctamente.",TipoToast.Success);return}const{excelErroneo:r,message:f,fileUrl:i}=n,o=r?"La importación NO se ha realizado por un error interno. Consulte el log.":"La importación NO se ha realizado. Puede descargar el Excel de errores.",s=[`<p>${o}</p>`,f?`<p class="text-start"><small>${f}</small></p>`:""].join("");Swal.fire({title:"Error al importar",html:s,icon:"error",confirmButtonText:"Cerrar",confirmButtonColor:"#d33",showDenyButton:!!i&&!r,denyButtonText:"Descargar errores"}).then(n=>{if(n.isDenied&&i)try{window.open(i,"_blank")}catch{location.href=i}});$("#tablaTelefonia").DataTable().ajax.reload(null,!1)}catch(i){registrarErrorjQuery(i.status,obtenerMensajeErrorAjax(i))}});$("#btnGuardarTelefonia").click(async()=>{let n=[];if(["#TFN_Anyo","#TFN_Mes","#TFN_Tipo","#TFN_FechaInicio","#TFN_FechaFin"].forEach(t=>{const i=$(t);i.val()?i.removeClass("campo-invalido"):(i.addClass("campo-invalido"),n.push(t))}),n.length>0){mostrarToast("Por favor, completa los campos obligatorios.",TipoToast.Warning);return}const i={TFN_Id:$("#TFN_Id").val()||0,TFN_Anyo:+$("#TFN_Anyo").val(),TFN_Mes:+$("#TFN_Mes").val(),TFN_Tipo:+$("#TFN_Tipo").val(),TFN_EMP_Id:+$("#TFN_EMP_Id").val(),TFN_Planta_EMP_Id:+$("#TFN_Planta_EMP_Id").val(),TFN_Planta_Departamento:$("#TFN_Planta_Departamento").val(),TFN_Planta_Sede:$("#TFN_Planta_Sede").val(),TFN_Planta_Uso:$("#TFN_Planta_Uso").val(),TFN_Ciclo:$("#TFN_Ciclo").val(),TFN_NumFactura:$("#TFN_NumFactura").val(),TFN_NumCuenta:$("#TFN_NumCuenta").val(),TFN_Categoria:$("#TFN_Categoria").val(),TFN_Telefono:$("#TFN_Telefono").val(),TFN_Extension:$("#TFN_Extension").val(),TFN_TipoCuota:$("#TFN_TipoCuota").val(),TFN_Bytes:+$("#TFN_Bytes").val()||0,TFN_Importe:+$("#TFN_Importe").val()||0,TFN_FechaInicio:$("#TFN_FechaInicio").val(),TFN_FechaFin:$("#TFN_FechaFin").val()};try{const n=await $.ajax({url:AppConfig.urls.GuardarTelefonia,method:"POST",contentType:"application/json",data:JSON.stringify(i)});n.success?($("#modalTelefonia").modal("hide"),tablaDatos.ajax.reload(null,!1),mostrarToast("Guardado con éxito",TipoToast.Success)):mostrarToast(n.message||"Error al guardar",TipoToast.Error)}catch(t){registrarErrorjQuery(t.status,obtenerMensajeErrorAjax(t))}})});$(document).on("input change","#TFN_Anyo, #TFN_Mes, #TFN_Tipo, #TFN_FechaInicio, #TFN_FechaFin",function(){$(this).val()&&$(this).removeClass("campo-invalido")});let tablaDatos;