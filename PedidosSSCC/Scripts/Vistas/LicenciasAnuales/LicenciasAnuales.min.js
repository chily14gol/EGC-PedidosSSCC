$(document).ready(function(){async function i(){try{await VerificarSesionActiva(OpcionMenu.LicenciasAnuales);await r();ocultarDivCargando();u();f()}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}async function r(){return new Promise(n=>{const t=inicializarDataTable("#tableLicencias",{ajax:{url:AppConfig.urls.ObtenerLicenciasAnuales,type:"GET",dataSrc:"",error:function(t,i,r){console.error("Error al cargar licencias anuales:",i,r);console.dir(t.responseJSON||t.responseText);n()},complete:function(){n()}},columns:[{data:"LAN_Nombre",title:"Nombre"},{data:"NombreProveedor",title:"Proveedor"},{data:"NombreTarea",title:"Tarea"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',orderable:!1,render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`<div class="btn-group" role="group">
                                <button class="btn btn-icon btn-editar me-2" data-row="${r}" onclick="editarLicencia(this)">
                                  <i class="bi bi-pencil-square" title="Editar"></i>
                                </button>
                                <button class="btn btn-icon btn-eliminar" data-row="${r}" onclick="delLicencia(this)">
                                  <i class="bi bi-trash" title="Eliminar"></i>
                                </button>
                            </div>`}}]},[],"export_licencias_anuales");$(window).resize(()=>t.columns.adjust().draw())})}function n(){const n=$("#tiposEnte");n.length&&(n.hasClass("select2-hidden-accessible")&&n.select2("destroy"),n.select2({placeholder:"",allowClear:!0,multiple:!0,dropdownParent:$("#modalEditar"),width:"100%"}))}async function t(n){try{const i=await fetch(`${AppConfig.urls.ObtenerTiposEntePorLicenciaAnual}?idLicencia=${n}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),r=await i.json(),t=$("#tiposEnte");t.empty();r.forEach(n=>{const i=new Option(n.text,n.id,n.selected,n.selected);t.append(i)});t.trigger("change")}catch(t){registrarErrorjQuery("fetch",t.message)}}async function u(){try{const n=await $.ajax({url:AppConfig.urls.ObtenerComboProveedores,type:"GET",dataType:"json"}),t=$("#lanProv").empty().append('<option value="">Seleccione Proveedor<\/option>');n.forEach(n=>{t.append(`<option value="${n.PRV_Id}">${n.PRV_Nombre}</option>`)})}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}async function f(){try{const n=[Tipo.CANTIDAD_FIJA];$.ajax({url:AppConfig.urls.ObtenerComboTareas,type:"GET",dataType:"json",data:{listaTiposTarea:n},traditional:!0,success:function(n){["#tarea"].forEach(t=>{const i=$(t).empty().append('<option value="">Seleccione Tarea<\/option>');n.forEach(n=>{i.append(`<option value="${n.TAR_Id}">${n.TAR_Nombre}</option>`)})})},error:function(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status,t)}})}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}i();$("#btnNuevo").click(function(){$("#lanId").val(-1);$("#lanNombre, #lanProv").val("");$("#modalLabel").text("Nueva Licencia Anual");$("#modalEditar").modal("show");t(-1).then(()=>{$("#tiposEnte").hasClass("select2-hidden-accessible")?$("#tiposEnte").trigger("change"):n()})});window.editarLicencia=function(i){const r=JSON.parse(i.getAttribute("data-row"));$("#lanId").val(r.LAN_Id);$("#lanProv").val(r.LAN_PRV_Id);$("#tarea").val(r.LAN_TAR_Id);$("#lanNombre").val(r.LAN_Nombre);$("#modalLabel").text("Editar Licencia Anual");$("#modalEditar").modal("show");t(r.LAN_Id).then(()=>{$("#tiposEnte").hasClass("select2-hidden-accessible")?$("#tiposEnte").trigger("change"):n()})};window.delLicencia=n=>{const t=JSON.parse(n.getAttribute("data-row"));mostrarAlertaConfirmacion({titulo:`¿Eliminar licencia '${t.LAN_Nombre}'?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarLicenciaAnual,type:"POST",contentType:"application/json",data:JSON.stringify({idLicencia:t.LAN_Id}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableLicencias").DataTable().ajax.reload(null,!1)):mostrarToast(n.message,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})};window.guardarLicencia=async()=>{const e=parseInt($("#lanId").val(),10),t=$("#lanNombre").val().trim(),i=$("#lanProv").val().trim(),r=$("#tarea").val().trim();let n=[];if(i?$("#lanProv").removeClass("is-invalid"):($("#lanProv").addClass("is-invalid"),n.push("Proveedor")),t?$("#lanNombre").removeClass("is-invalid"):($("#lanNombre").addClass("is-invalid"),n.push("Nombre")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}const u={LAN_Id:e,LAN_PRV_Id:i,LAN_Nombre:t,TiposEnte:$("#tiposEnte").val()};r!=null&&(u.LAN_TAR_Id=r);const f=await $.ajax({url:AppConfig.urls.GuardarLicenciaAnual,type:"POST",contentType:"application/json",data:JSON.stringify(u),dataType:"json"});f.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalEditar").modal("hide"),$("#tableLicencias").DataTable().ajax.reload(null,!1)):mostrarToast(f.message||"Error al guardar.",TipoToast.Warning)}});