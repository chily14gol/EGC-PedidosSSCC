function generarResumenPorLicenciaAnual(n){if(!Array.isArray(n)||n.length===0)return"<p>No se ha generado ningún concepto.<\/p>";const i=new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"});let t='<ul class="text-start">';return n.forEach(n=>{const i=String(n.Mes).padStart(2,"0"),r=n.Anyo,u=formatMoney(n.TotalImporte);if(t+=`
            <li>
                <strong>${n.NombreEmpresa}</strong>
                — Periodo: ${i}/${r}
                — Total: <em>${u}</em>
        `,n.ListaErrores&&n.ListaErrores.length&&(t+=`
        <div class="alert alert-warning">
          <ul class="mb-2" style="margin-bottom: 0px !important;">
            ${n.ListaErrores.map(n=>`<li>${n}</li>`).join("")}
          </ul>
        </div>`),Array.isArray(n.ListaDetalle)&&n.ListaDetalle.length){const i={};n.ListaDetalle.forEach(n=>{const t=n.IdLicencia;i[t]||(i[t]={NombreLicencia:n.NombreLicencia,Cantidad:0,Importe:0});i[t].Cantidad+=1;i[t].Importe+=n.Importe});t+="<ul>";Object.values(i).forEach(n=>{const i=formatMoney(n.Importe);t+=`<li>${n.NombreLicencia} (x${n.Cantidad}): <em>${i}</em></li>`});t+="<\/ul>"}t+="<\/li>"}),t+="<\/ul>"}async function generarConceptosLicenciasAnuales(){mostrarDivCargando();try{const n=await $.ajax({url:AppConfig.urls.GenerarConceptosLicenciasAnuales,type:"POST",contentType:"application/json; charset=utf-8",dataType:"json"});if(ocultarDivCargando(),n.success){let t="";if(Array.isArray(n.resultados)&&n.resultados.length){const i=n.resultados.reduce((n,t)=>n+(t.ConceptosCreados||0),0);t+=`
                    <p><strong>Total conceptos generados:</strong> ${i}</p>
                    <ul class="text-start">
                        ${n.resultados.map(n=>`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s)</li>`).join("")}
                    </ul>
                `}else t="<p>Conceptos generados correctamente.<\/p>";await Swal.fire({title:"Conceptos generados",html:t,icon:"success",confirmButtonText:"Aceptar",width:"50%"});$("#tableAsuntos").DataTable().ajax.reload(null,!1)}else{const t=n.mensaje||n.message||"Error al generar conceptos.";mostrarToast(t,TipoToast.Error)}}catch(n){ocultarDivCargando();const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status||"",t)}}$(function(){async function f(){await VerificarSesionActiva(OpcionMenu.ContratosLicenciasAnuales);await e();ocultarDivCargando();await s();await h()}async function e(){return new Promise(n=>{const t=inicializarDataTable("#tableContratos",{ajax:{url:AppConfig.urls.ObtenerContratos,type:"GET",dataSrc:""},columns:[{data:"ProveedorNombre",title:"Proveedor"},{data:"CLA_FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"CLA_FechaFin",title:"Fecha Fin",render:formatDateToDDMMYYYY},{className:"td-btn",orderable:!1,data:null,render:(n,t,i)=>{const r=JSON.stringify(i).replace(/"/g,"&quot;");return`
                            <div class="btn-group" role="group">
                                <button class="btn btn-icon me-2" onclick="verTarifasContrato(this)" data-row="${r}">
                                  <i class="bi bi-currency-dollar" title="Tarifas"></i>
                                </button>
                                <button class="btn btn-icon btn-entes me-2" data-row="${r}" onclick="viewEntesLicencia(this)">
                                    <i class="bi bi-people" title="Entidades"></i>
                                </button>
                                <button class="btn btn-icon me-2" onclick="eliminarContrato(this)" data-row="${r}">
                                  <i class="bi bi-trash" title="Eliminar"></i>
                                </button>
                              </div>`}}]},[],"export_contratos");$("#btnNuevoContrato").click(()=>{$("#claId, #claProv, #claInicio, #claFin").val(""),$("#modalContratoLabel").text("Nuevo Contrato"),$("#modalContrato").modal("show")});$(window).resize(()=>t.columns.adjust().draw());n()})}function t(){$("#btnNuevaTarifa").show();$("#btnCancelarTarifa").hide();$("#btnGuardarTarifa").hide();$("#formTarifaContrato").slideUp()}function i(n){const t=inicializarDataTable("#tableTarifasContrato",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerTarifasContrato,type:"GET",data:{idContrato:n},dataSrc:""},columns:[{data:"LicenciaNombre",title:"Licencia",className:"text-end"},{data:"CLT_ImporteAnual",title:"Importe Anual",className:"text-center",render:n=>formatMoney(n)},{className:"td-btn",orderable:!1,data:null,render:(n,t,i)=>{const r=JSON.stringify(i).replace(/"/g,"&quot;");return`
                        <button class="btn btn-icon btn-editar me-2" data-row="${r}" onclick="editarTarifaContrato(this)">
                          <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-icon" onclick="eliminarTarifaContrato(this)" data-row="${r}">
                          <i class="bi bi-trash"></i>
                        </button>`}}]});$(window).resize(()=>t.columns.adjust().draw())}function r(n){const t=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0");return`${t}-${i}-${r}`}function u(){$("#elaEntId").val(null).trigger("change");$("#btnNuevaEnte").show();$("#btnCancelarEnte").hide();$("#btnGuardarEnte").hide();$("#formEntes").slideUp()}function o(n){const t=inicializarDataTable("#tableEntes",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerEntesPorLicenciaAnual,type:"GET",data:{idContrato:n},dataSrc:""},columns:[{data:"NombreEntidad",title:"Entidad"},{data:"NombreLicencia",title:"Licencia"},{data:"ELA_FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"ELA_FechaFin",title:"Fecha Fin",render:formatDateToDDMMYYYY},{className:"td-btn",data:null,orderable:!1,responsivePriority:1,render:(n,t,i)=>{const r=JSON.stringify(i).replace(/"/g,"&quot;"),f=`
                          <button class="btn btn-icon btn-editar me-2"
                                  data-row="${r}"
                                  onclick="editEnteLicencia(this)">
                            <i class="bi bi-pencil-square" title="Editar"></i>
                          </button>`;let u;return u=i.ELA_Facturada?`
                                <button class="btn btn-icon btn-eliminar" disabled
                                        title="No se puede eliminar: ya facturada">
                                  <i class="bi bi-trash"></i>
                                </button>`:`
                                <button class="btn btn-icon btn-eliminar"
                                        data-row="${r}"
                                        onclick="delEnteLicencia(this)">
                                  <i class="bi bi-trash" title="Eliminar"></i>
                                </button>`,f+u}}]},[],"entes");$(window).resize(()=>t.columns.adjust().draw())}function n(n){return new Date(n.getFullYear(),n.getMonth(),n.getDate())}async function s(){try{const t=await $.ajax({url:AppConfig.urls.ObtenerEntes,type:"GET",dataType:"json"}),n=$("#elaEntId").empty().append('<option value="">Seleccione entidad<\/option>');t.forEach(t=>n.append(`<option value="${t.ENT_Id}">${t.ENT_Nombre}</option>`));n.hasClass("select2-hidden-accessible")&&n.select2("destroy");n.select2({placeholder:"Seleccione entidad",allowClear:!0,width:"100%",dropdownParent:$("#modalEntes")})}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}async function h(){try{const n=await $.getJSON(AppConfig.urls.ObtenerProveedores),t=$("#claProv").empty().append('<option value="">Seleccione<\/option>');n.forEach(n=>t.append(`<option value="${n.PRV_Id}">${n.PRV_Nombre}</option>`))}catch(n){registrarErrorjQuery(n.status,n.message)}}async function c(n){try{const t=await $.getJSON(AppConfig.urls.ObtenerLicenciasProveedor,{idProveedor:n}),i=$("#selectLicencia").empty().append('<option value="">Seleccione Licencia<\/option>');t.forEach(n=>i.append(`<option value="${n.LAN_Id}">${n.LAN_Nombre}</option>`))}catch(t){registrarErrorjQuery(t.status,t.message)}}async function l(n){try{const t=await $.getJSON(AppConfig.urls.ObtenerLicenciasProveedor,{idProveedor:n}),i=$("#elaLicencias").empty().append('<option value="">Seleccione Licencia<\/option>');t.forEach(n=>i.append(`<option value="${n.LAN_Id}">${n.LAN_Nombre}</option>`))}catch(t){registrarErrorjQuery(t.status,t.message)}}f();window.editarContrato=n=>{const t=JSON.parse(n.getAttribute("data-row"));$("#claId").val(t.CLA_Id);$("#claProv").val(t.CLA_PRV_Id);$("#claInicio").val(formatDateInputForDateField(t.CLA_FechaInicio));$("#claFin").val(t.CLA_FechaFin?formatDateInputForDateField(t.CLA_FechaFin):"");$("#modalContratoLabel").text("Editar Contrato");$("#modalContrato").modal("show")};window.eliminarContrato=n=>{const t=JSON.parse(n.getAttribute("data-row"));mostrarAlertaConfirmacion({titulo:`¿Eliminar contrato con proveedor '${t.ProveedorNombre}'?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarContrato,type:"POST",contentType:"application/json",data:JSON.stringify({idContrato:t.CLA_Id}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableContratos").DataTable().ajax.reload(null,!1)):mostrarToast(n.message,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})};window.guardarContrato=async()=>{const f=parseInt($("#claId").val(),10),r=$("#claProv").val().trim(),i=$("#claInicio").val().trim(),t=$("#claFin").val().trim();let n=[];if(r?$("#claProv").removeClass("is-invalid"):($("#claProv").addClass("is-invalid"),n.push("Proveedor")),i?$("#claInicio").removeClass("is-invalid"):($("#claInicio").addClass("is-invalid"),n.push("Fecha Inicio")),t?$("#claFin").removeClass("is-invalid"):($("#claFin").addClass("is-invalid"),n.push("Fecha Fin")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}if(t&&new Date(t)<new Date(i)){$("#claFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#claFin").removeClass("is-invalid");const e={CLA_Id:f,CLA_PRV_Id:r,CLA_FechaInicio:i,CLA_FechaFin:t},u=await $.ajax({url:AppConfig.urls.GuardarContrato,type:"POST",contentType:"application/json",data:JSON.stringify(e),dataType:"json"});u.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalContrato").modal("hide"),$("#tableContratos").DataTable().ajax.reload()):mostrarToast(u.message||"Error al guardar.",TipoToast.Warning)};$("#btnNuevaTarifa").click(()=>{$("#selectLicencia, #cltImporte").val(""),$("#btnNuevaTarifa").hide(),$("#btnCancelarTarifa").show(),$("#btnGuardarTarifa").show(),$("#formTarifaContrato").slideDown()});$("#btnCancelarTarifa").on("click",function(){t()});window.verTarifasContrato=n=>{const t=JSON.parse(n.getAttribute("data-row"));$("#cltClaId").val(t.CLA_Id);$("#cltImporte, #cltNumLic").val("");c(t.CLA_PRV_Id);i(t.CLA_Id);$("#formTarifaContrato").hide();$("#btnNuevaTarifa").show();$("#btnGuardarTarifa").hide();$("#modalTarifasContrato").modal("show")};window.editarTarifaContrato=function(n){const t=JSON.parse(n.getAttribute("data-row"));$("#selectLicencia").val(t.CLT_LAN_Id);$("#cltImporte").val(t.CLT_ImporteAnual);$("#btnNuevaTarifa").hide();$("#btnCancelarTarifa").show();$("#btnGuardarTarifa").show();$("#formTarifaContrato").slideDown()};window.eliminarTarifaContrato=n=>{const t=JSON.parse(n.getAttribute("data-row"));mostrarAlertaConfirmacion({titulo:`¿Eliminar tarifa ${formatMoney(t.CLT_ImporteAnual)}?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarTarifaContrato,type:"POST",contentType:"application/json",data:JSON.stringify({idContrato:t.CLT_CLA_Id,idLicencia:t.CLT_LAN_Id}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableTarifasContrato").DataTable().ajax.reload(null,!1)):mostrarToast(n.message,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})};window.guardarTarifaContrato=async()=>{const u=$("#selectLicencia").val().trim(),f=$("#cltImporte").val().trim();let n=[];if(u?$("#selectLicencia").removeClass("is-invalid"):($("#selectLicencia").addClass("is-invalid"),n.push("Licencia")),f?$("#cltImporte").removeClass("is-invalid"):($("#cltImporte").addClass("is-invalid"),n.push("Importe")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}const r={CLT_CLA_Id:parseInt($("#cltClaId").val(),10),CLT_LAN_Id:parseInt($("#selectLicencia").val()),CLT_ImporteAnual:parseFloat($("#cltImporte").val())},e=await $.ajax({url:AppConfig.urls.GuardarTarifaContrato,type:"POST",contentType:"application/json",data:JSON.stringify(r),dataType:"json"});e.success&&(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),t(),i(r.CLT_CLA_Id))};$("#btnNuevaEnte").click(()=>{const o=$("#btnNuevaEnte").data("inicioContrato"),f=$("#btnNuevaEnte").data("finContrato"),e=new Date(o),n=f?new Date(f):null,i=new Date;let t,u;n&&i>n?(t=n,u=n):(t=i>e?i:e,u=n||t);$("#elaFechaInicio").val(r(t));$("#elaFechaFin").val(r(u));$("#elaEntId").val(null).trigger("change");$("#elaLicencias").val("");$("#btnNuevaEnte").hide();$("#btnCancelarEnte").show();$("#btnGuardarEnte").show();$("#formEntes").slideDown()});$("#btnCancelarEnte").on("click",function(){u()});window.viewEntesLicencia=function(n){const t=JSON.parse(n.getAttribute("data-row"));$("#contratoId").val(t.CLA_Id);$("#btnNuevaEnte").data("inicioContrato",t.CLA_FechaInicio).data("finContrato",t.CLA_FechaFin);$("#elaEntId, #elaFechaInicio, #elaFechaFin").val("");l(t.CLA_PRV_Id);o(t.CLA_Id);$("#formEntes").hide();$("#btnNuevaEnte").show();$("#btnGuardarEnte").hide();$("#modalEntes").modal("show")};window.editEnteLicencia=function(n){const t=JSON.parse(n.getAttribute("data-row"));if($('#elaEntId option[value="'+t.ELA_ENT_Id+'"]').length===0){const n=new Option(t.NombreEntidad,t.ELA_ENT_Id,!0,!0);$("#elaEntId").append(n)}$("#elaEntId").val(t.ELA_ENT_Id).trigger("change");$("#elaLicencias").val(t.ELA_LAN_Id);$("#elaFechaInicio").val(formatDateInputForDateField(t.ELA_FechaInicio));$("#elaFechaFin").val(t.ELA_FechaFin?formatDateInputForDateField(t.ELA_FechaFin):"");$("#btnNuevaEnte").hide();$("#btnCancelarEnte").show();$("#btnGuardarEnte").show();$("#formEntes").slideDown();$("#modalEntes").modal("show")};window.delEnteLicencia=function(n){const t=JSON.parse(n.getAttribute("data-row"));mostrarAlertaConfirmacion({titulo:`¿Eliminar entidad '${t.NombreEntidad}'?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarEnteLicenciaAnual,type:"POST",contentType:"application/json",data:JSON.stringify({idEntidad:t.ELA_ENT_Id,idLicenciaAnual:t.ELA_LAN_Id,idContrato:t.ELA_CLA_Id}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableEntes").DataTable().ajax.reload(null,!1)):mostrarToast(n.message,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})};window.guardarEnteLicencia=async()=>{const y=parseInt($("#contratoId").val(),10),s=parseInt($("#elaEntId").val(),10),h=parseInt($("#elaLicencias").val(),10),f=$("#elaFechaInicio").val(),r=$("#elaFechaFin").val(),o=$("#btnNuevaEnte").data("inicioContrato"),t=$("#btnNuevaEnte").data("finContrato"),c=n(new Date(o)),e=t?n(new Date(t)):null,l=n(new Date(f)),a=n(new Date(r));if(l<c||e&&l>e){$("#elaFechaInicio").addClass("is-invalid");mostrarToast(`La Fecha Inicio debe estar entre ${formatDateToDDMMYYYY(o)} `+(t?`y ${formatDateToDDMMYYYY(t)}.`:`en adelante.`),TipoToast.Warning);return}if($("#elaFechaInicio").removeClass("is-invalid"),a<c||e&&a>e){$("#elaFechaFin").addClass("is-invalid");mostrarToast(`La Fecha Fin debe estar entre ${formatDateToDDMMYYYY(o)} `+(t?`y ${formatDateToDDMMYYYY(t)}.`:`en adelante.`),TipoToast.Warning);return}$("#elaFechaFin").removeClass("is-invalid");let i=[];if(s?$("#elaEntId").removeClass("is-invalid"):($("#elaEntId").addClass("is-invalid"),i.push("Entidad")),h?$("#elaLicencias").removeClass("is-invalid"):($("#elaLicencias").addClass("is-invalid"),i.push("Licencia")),f?$("#elaFechaInicio").removeClass("is-invalid"):($("#elaFechaInicio").addClass("is-invalid"),i.push("Fecha Inicio")),r?$("#elaFechaFin").removeClass("is-invalid"):($("#elaFechaFin").addClass("is-invalid"),i.push("Fecha Fin")),i.length){mostrarToast(AppConfig.mensajes.camposObligatorios+i.join(", "),TipoToast.Warning);return}if(r&&new Date(r)<new Date(f)){$("#elaFechaFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#elaFechaFin").removeClass("is-invalid");const p={ELA_ENT_Id:s,ELA_LAN_Id:h,ELA_CLA_Id:y,ELA_FechaInicio:formatDateToDDMMYYYY(f),ELA_FechaFin:formatDateToDDMMYYYY(r)},v=await $.ajax({url:AppConfig.urls.GuardarEnteLicenciaAnual,type:"POST",contentType:"application/json",data:JSON.stringify(p),dataType:"json"});v.success?(u(),mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableEntes").DataTable().ajax.reload(null,!1)):mostrarToast(v.message,TipoToast.Warning)};$("#btnPrevisulizarConceptosLicenciasAnuales").click(async()=>{mostrarDivCargando();try{const r=await $.ajax({url:window.AppConfig.urls.PrevisualizarConceptosLicenciasAnuales,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8"});if(ocultarDivCargando(),!r.success){await Swal.fire({icon:"error",title:"Error al previsualizar",html:`<div class="text-start">${r.mensaje}</div>`,confirmButtonText:"Entendido"});return}const{partesPreview:n,partesErrors:t}=r;if((!n||n.length===0)&&(!t||t.length)){await Swal.fire({title:"Nada que Previsualizar",html:`<p>No hay conceptos de licencias anuales pendientes.</p>`,icon:"info",confirmButtonText:"Entendido",width:500});return}let i="";t&&t.length&&(i=`
                  <div class="alert alert-warning">
                    <ul>
                      ${t.map(n=>`<li>${n}</li>`).join("")}
                    </ul>
                  </div>
                `);n&&n.length!==0?i+=generarResumenPorLicenciaAnual(n):i=`<p>No hay licencias anuales validas para previsualizar.</p>`;const{isConfirmed:u}=await Swal.fire({title:"Previsualizar Conceptos de Licencias Anuales",html:`<div class="small text-start">
                         ${i}
                       </div>`,width:"80%",showCancelButton:!0,cancelButtonText:"Cerrar",confirmButtonText:"Generar Conceptos",icon:"info"});u&&await generarConceptosLicenciasAnuales()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}})});