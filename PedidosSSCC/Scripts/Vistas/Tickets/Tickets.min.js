async function eliminarTicket(n){const t=JSON.parse(n.getAttribute("data-ticket"));mostrarAlertaConfirmacion({titulo:`¿Estás seguro de que deseas eliminar el ticket '${t.TKC_Titulo}'?`,onConfirmar:async function(){try{const n=await $.ajax({url:AppConfig.urls.EliminarTicket,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({idTicket:t.TKC_Id}),dataType:"json"});if(n.success){mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success);const n=$("#tablaTickets").DataTable();n.ajax.reload(null,!1)}else mostrarToast("No se puede eliminar el ticket.",TipoToast.Warning)}catch(n){registrarErrorjQuery(n.status||"error",n.message||n)}}})}function generarBotonesTicket(n){let i=JSON.stringify(n),t=i.replace(/"/g,"&quot;");return`
        <button type="button"
                class="btn btn-icon btn-editar btn-outline-secondary"
                data-ticket="${t}"
                onclick="abrirModalTicket(this)">
            <i class="bi bi-eye-fill" title="Ver"></i>
        </button>
        <button type="button"
                class="btn btn-icon btn-eliminar btn-outline-secondary"
                data-ticket="${t}"
                onclick="eliminarTicket(this)">
            <i class="bi bi-trash" title="Eliminar"></i>
        </button>`}function abrirModalTicket(n){const t=JSON.parse(n.getAttribute("data-ticket"));$("#TKC_Id").val(t.TKC_Id);$("#TKC_Id_GLPI").val(t.TKC_Id_GLPI||"");$("#TKC_Titulo").val(t.TKC_Titulo);$("#TKC_GrupoAsignado").val(t.TKC_GrupoAsignado);$("#TKC_Categoria").val(t.TKC_Categoria);$("#TKC_CTK_Id").val(t.TKC_CTK_Id||"");$("#TKC_Ubicacion").val(t.TKC_Ubicacion);$("#TKC_Duracion").val(t.TKC_Duracion);$("#TKC_Descripcion").val(t.TKC_Descripcion);$("#TKC_ETK_Id").val(t.TKC_ETK_Id||"");$("#TKC_TTK_Id").val(t.TKC_TTK_Id||"");$("#TKC_OTK_Id").val(t.TKC_OTK_Id||"");const i=$("#TKC_ENT_Id_Solicitante");i.val(t.TKC_ENT_Id_Solicitante||"");i.trigger("change");$("#TKC_ProveedorAsignado").val(t.TKC_ProveedorAsignado||"");$("#TKC_GrupoCargo").val(t.TKC_GrupoCargo||"");$("#TKC_VTK_Id").val(t.TKC_VTK_Id||"");const r=moment(t.TKC_FechaApertura).format("YYYY-MM-DD"),u=moment(t.TKC_FechaResolucion).format("YYYY-MM-DD");$("#TKC_FechaApertura").val(r);$("#TKC_FechaResolucion").val(u);$("#modalTicketLabel").text("Modificación de Ticket");$("#modalTicket").modal("show")}function limpiarModalTicket(){$("#formTicket")[0].reset();$("#TKC_Id").val("")}function guardarFiltros(){let n=$("#formBuscar").val(),t=$("#filterTitulo").val(),i=$("#filterGrupoAsignado").val(),r=$("#filterCategoria").val(),u=$("#filterUbicacion").val(),f=$("#filterEmpresa").val(),e=$("#filterSinEmpresa").is(":checked"),o={general:n,titulo:t,grupoAsignado:i,categoria:r,ubicacion:u,empresa:f,sinEmpresa:e};localStorage.setItem(storageKey,JSON.stringify(o))}async function ObtenerTickets(){tablaDatos=inicializarDataTable("#tablaTickets",{ajax:{url:AppConfig.urls.ObtenerTickets,type:"GET",dataSrc:"",dataType:"json"},columns:[{data:"TKC_Titulo",title:"Título"},{data:"TKC_Id_GLPI",title:"GLPI"},{data:"TKC_GrupoAsignado",title:"Grupo Asignado"},{data:"TKC_Categoria",title:"Categoría"},{data:"TKC_Ubicacion",title:"Ubicación"},{data:"TKC_Duracion",title:"Duración",render:function(n){if(!n||isNaN(n))return"";let t=parseInt(n,10);const i=Math.floor(t/60),r=t%60;return i>0?`${i}h ${r}m`:`${r}m`}},{data:"EMP_Nombre",title:"Empresa",render:n=>n??""},{data:"TKC_FechaApertura",title:"Fecha Apertura",render:function(n){return n?moment(n).format("DD/MM/YYYY HH:mm"):""}},{data:"TKC_FechaResolucion",title:"Fecha Resolución",render:function(n){return n?moment(n).format("DD/MM/YYYY HH:mm"):""}},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',responsivePriority:2,orderable:!1,render:function(n){return generarBotonesTicket(n)}}]},[],"export_tickets");$(window).resize(()=>tablaDatos.columns.adjust().draw());$("#formBuscar").on("keyup input",function(){tablaDatos.search(this.value,!1,!1).draw();guardarFiltros()});return tablaDatos}async function poblarSelect(n,t,i,r){try{const f=await $.getJSON(t),u=$("#"+n);u.empty();u.append(`<option value="">-- Selecciona --</option>`);f.forEach(n=>{u.append(`<option value="${n[i]}">${n[r]}</option>`)})}catch(u){console.error(`Error al cargar ${n}`,u)}}function renderSoporteSection(n,t=[],i=[]){let r="";return i.length&&(r+=`<div class="alert alert-danger">
      <strong>Errores bloqueantes</strong>
      <ul>${i.map(n=>`<li>${n}</li>`).join("")}</ul>
    </div>`),t.length&&(r+=`<div class="alert alert-warning">
      <ul>${t.map(n=>`<li>${n}</li>`).join("")}</ul>
    </div>`),r+(n&&n.length?generarResumenConceptosSoportePrev(n):`<p>No hay conceptos de soporte pendientes.</p>`)}function generarResumenConceptosSoportePrev(n){if(!n||!n.length)return"<p>No hay conceptos de soporte pendientes.<\/p>";let t="<div class='small text-start'>";return n.forEach(n=>{t+=`
      <div style="
        border:1px solid #e0e0e0;
        border-radius:8px;
        padding:10px;
        margin-bottom:12px;">
        <div class="fw-semibold mb-2" style="color:#001f3f;">
          Categoría: ${n.CategoriaNombre}
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:0.9em">
          <thead>
            <tr style="background:#f0f0f0">
              <th style="padding:6px;border:1px solid #ddd;text-align:left">Empresa</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:center">Periodo</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:right">Importe</th>
            </tr>
          </thead>
          <tbody>
    `,n.Filas.forEach(n=>{t+=`
        <tr>
          <td style="padding:6px;border:1px solid #eee">${n.EmpresaNombre}</td>
          <td style="padding:6px;border:1px solid #eee;text-align:center">${n.Mes}/${n.Anyo}</td>
          <td style="padding:6px;border:1px solid #eee;text-align:right">${formatMoney(n.ImporteTotal)}</td>
        </tr>
      `}),t+=`
          </tbody>
        </table>
      </div>
    `}),t+="<\/div>"}async function ejecutarGeneracionConceptos(){mostrarDivCargando();try{const n=await $.ajax({url:AppConfig.urls.GenerarTodosConceptos,type:"POST",dataType:"json"});if(ocultarDivCargando(),n.soporteBlockingErrors?.length){await Swal.fire({icon:"error",title:"Errores bloqueantes",html:`<ul style="text-align:left">
                  ${n.soporteBlockingErrors.map(n=>`<li>${n}</li>`).join("")}
                </ul>`,confirmButtonText:"Aceptar",allowOutsideClick:!1,allowEscapeKey:!1});return}if(n.errors?.length){await Swal.fire({icon:"error",title:"Errores generando conceptos",html:`<ul style="text-align:left">
                 ${n.errors.map(n=>`<li>${n}</li>`).join("")}
               </ul>`,confirmButtonText:"Entendido"});return}if(!n.success){mostrarErrorPedidos();return}const t=`
      <div style="text-align:left">
        <h5>Conceptos de Soporte</h5>
        ${generarResumenConceptosSoporteFin(n.soporte)}
      </div>
    `;await Swal.fire({title:"Proceso Completado",html:t,icon:"success",confirmButtonText:"Aceptar"});const i=$("#table").DataTable();i.destroy();mostrarDivCargando();$("#table tbody").empty();await ObtenerTickets();ocultarDivCargando()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}}function generarResumenConceptosSoporteFin(n){if(!n||n.length===0)return"<ul><li><strong>No se ha generado ningún concepto de soporte<\/strong><\/li><\/ul>";let t="<ul style='text-align: left;'>";return n.forEach(n=>{t+=`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s) generados</li>`}),t+="<\/ul>"}let storageKey=Filtros.Tickets;$.fn.dataTable.ext.search.push(function(n,t){if(!n.nTable.id||n.nTable.id!=="tablaTickets")return!0;const i=$("#filterFechaDesde").val(),r=$("#filterFechaHasta").val(),u=t[7];if(!u)return!0;const f=moment(u,"DD/MM/YYYY HH:mm").toDate();let e=!0,o=!0;if(i){const n=new Date(i);e=f>=n}if(r){const n=new Date(r);n.setHours(23,59,59,999);o=f<=n}return e&&o});let tablaDatos;$(document).ready(async function(){async function t(){let n=localStorage.getItem(storageKey),t=!1;if(n){n=JSON.parse(n);$("#formBuscar").val(n.general);$("#filterTitulo").val(n.titulo||"");$("#filterGrupoAsignado").val(n.grupoAsignado||"");$("#filterCategoria").val(n.categoria||"");$("#filterUbicacion").val(n.ubicacion||"");$("#filterEmpresa").val(n.empresa||"");$("#filterSinEmpresa").prop("checked",!!n.sinEmpresa);$("#filterEmpresa").prop("disabled",!!n.sinEmpresa);let{...otrosFiltros}=n;t=Object.values(otrosFiltros).some(n=>n!==""&&n!==null&&n!==undefined)}await ObtenerTickets();setTimeout(()=>{let t=$("#tablaTickets").DataTable();n?.general&&t.search(n.general,!1,!1).draw()},200);t&&($("#btnLimpiar").show(),$(".table-filter").addClass("advance"),$("#btnAvanzado").html(`Ocultar Filtros`))}function i(){let n=[];return([{id:"TKC_Titulo",label:"Título"},{id:"TKC_GrupoAsignado",label:"Grupo Asignado"},{id:"TKC_ETK_Id",label:"Estado"},{id:"TKC_TTK_Id",label:"Tipo"},{id:"TKC_OTK_Id",label:"Origen"},{id:"TKC_VTK_Id",label:"Validación"},{id:"TKC_CTK_Id",label:"Categoría Calculada"}].forEach(t=>{const i=$(`#${t.id}`),r=i.val();r&&r.toString().trim()!==""?i.removeClass("is-invalid"):(i.addClass("is-invalid"),n.push(t.label))}),n.length>0)?(mostrarToast(AppConfig.mensajes.camposObligatorios+`${n.join(", ")}`,TipoToast.Warning),!1):!0}await VerificarSesionActiva(OpcionMenu.Tickets);await t();await poblarSelect("TKC_ETK_Id",AppConfig.urls.ObtenerEstadosTicket,"ETK_Id","ETK_Nombre");await poblarSelect("TKC_TTK_Id",AppConfig.urls.ObtenerTiposTicket,"TTK_Id","TTK_Nombre");await poblarSelect("TKC_OTK_Id",AppConfig.urls.ObtenerOrigenesTicket,"OTK_Id","OTK_Nombre");await poblarSelect("TKC_VTK_Id",AppConfig.urls.ObtenerValidacionesTicket,"VTK_Id","VTK_Nombre");await poblarSelect("TKC_ENT_Id_Solicitante",AppConfig.urls.ObtenerEntes,"ENT_Id","ENT_Nombre");await poblarSelect("filterEmpresa",AppConfig.urls.ObtenerComboEmpresas,"EMP_Id","EMP_Nombre");const n=$("#TKC_ENT_Id_Solicitante");n.hasClass("select2-hidden-accessible")&&n.select2("destroy");n.select2({placeholder:"Seleccione solicitante",allowClear:!0,width:"100%",dropdownParent:$("#modalTicket")});await poblarSelect("TKC_CTK_Id",AppConfig.urls.ObtenerCategoriasTicket,"CTK_Id","CTK_Nombre");$("#btnBuscar").on("click",function(){const r=$("#filterTitulo").val(),u=$("#filterGrupoAsignado").val(),f=$("#filterCategoria").val(),e=$("#filterUbicacion").val(),i=$("#filterEmpresa option:selected"),t=i.length?i.text().trim():"",o=$("#filterSinEmpresa").is(":checked"),n=$("#tablaTickets").DataTable();if(n.column(0).search(r),n.column(2).search(u),n.column(3).search(f),n.column(4).search(e),o)n.column(6).search("^\\s*$",!0,!1);else if(t&&t!=="-- Selecciona --"){const i="^"+$.fn.dataTable.util.escapeRegex(t)+"$";n.column(6).search(i,!0,!1)}else n.column(6).search("");n.draw();guardarFiltros()});$("#filterFechaDesde, #filterFechaHasta, #filterEmpresa").on("change",function(){$("#tablaTickets").DataTable().draw()});$("#btnGuardarTicket").click(async()=>{if(i()){const t={TKC_Id:$("#TKC_Id").val(),TKC_Id_GLPI:$("#TKC_Id_GLPI").val(),TKC_Titulo:$("#TKC_Titulo").val(),TKC_GrupoAsignado:$("#TKC_GrupoAsignado").val(),TKC_Categoria:$("#TKC_Categoria").val(),TKC_Ubicacion:$("#TKC_Ubicacion").val(),TKC_Duracion:$("#TKC_Duracion").val(),TKC_Descripcion:$("#TKC_Descripcion").val(),TKC_ETK_Id:$("#TKC_ETK_Id").val(),TKC_TTK_Id:$("#TKC_TTK_Id").val(),TKC_OTK_Id:$("#TKC_OTK_Id").val(),TKC_ENT_Id_Solicitante:$("#TKC_ENT_Id_Solicitante").val(),TKC_ProveedorAsignado:$("#TKC_ProveedorAsignado").val(),TKC_GrupoCargo:$("#TKC_GrupoCargo").val(),TKC_VTK_Id:$("#TKC_VTK_Id").val(),TKC_FechaApertura:$("#TKC_FechaApertura").val(),TKC_FechaResolucion:$("#TKC_FechaResolucion").val(),TKC_CTK_Id:$("#TKC_CTK_Id").val()};try{const n=await $.ajax({url:AppConfig.urls.GuardarTicket,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(t),dataType:"json"});if(n.success){$("#modalTicket").modal("hide");const n=await ObtenerTickets();n.ajax.reload(null,!1);mostrarToast("Guardado con éxito",TipoToast.Success)}else mostrarToast(n.message||"Error al guardar",TipoToast.Error)}catch(n){const t=obtenerMensajeErrorAjax(n);registrarErrorjQuery(n.status||"",t);mostrarToast("Error al conectar con el servidor",TipoToast.Error)}}});$("#btnNuevo").on("click",function(){limpiarModalTicket();$("#modalTicketLabel").text("Alta de Ticket");$("#modalTicket").modal("show")});$("#btnDescargarPlantilla").click(function(){window.location.href=AppConfig.urls.DescargarPlantillaTickets});$("#btnImportarExcel").on("click",function(){$("#archivoExcel").val("");$("#modalImportar").modal("show")});$("#btnSubirProcesar").click(async function(n){n.preventDefault();let t=$("#archivoExcel")[0].files[0];if(!t){mostrarToast("Por favor, seleccione un archivo.",TipoToast.Error);return}let i=new FormData;i.append("archivoExcel",t);$("#modalImportar").modal("hide");mostrarDivCargando();try{const n=await $.ajax({url:AppConfig.urls.ImportarExcelTickets,type:"POST",data:i,processData:!1,contentType:!1});if(n.success)ocultarDivCargando(),mostrarToast("Archivo importado correctamente.",TipoToast.Success),$("#tablaTickets").DataTable().ajax.reload(null,!1);else{if(ocultarDivCargando(),mostrarToast(n.message||"Error durante la importación.",TipoToast.Error),n.fileUrl){let t=document.createElement("a");t.href=n.fileUrl;t.download="Errores_Importacion.xlsx";document.body.appendChild(t);t.click();document.body.removeChild(t)}$("#tablaTickets").DataTable().ajax.reload(null,!1)}}catch(r){const n=obtenerMensajeErrorAjax(r);registrarErrorjQuery(r.status||"",n)}});$("#modalTicket").modal({backdrop:"static",keyboard:!1});$("#filterSinEmpresa").on("change",function(){const n=$(this).is(":checked");$("#filterEmpresa").prop("disabled",n);n&&$("#filterEmpresa").val("")});$("#btnPrevisulizarConceptos").click(async()=>{mostrarDivCargando();try{const n=await $.ajax({url:AppConfig.urls.PrevisualizarConceptos,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8"});if(ocultarDivCargando(),!n.success){await Swal.fire({icon:"error",title:"Error",text:"Se produjo un error procesando la previsualización."});return}const i=n.soporte??[],f=n.soporteErrors??[],r=n.soporteBlockingErrors??[],u=`
          <div class="small text-start">
            <h5>Soporte CAU</h5>
            ${renderSoporteSection(i,f,r)}
          </div>`,t=i.length>0,e=r.length>0;if(e)await Swal.fire({title:"Errores bloqueantes",html:u,width:"70%",icon:"error",confirmButtonText:"Aceptar"});else{const{isConfirmed:n}=await Swal.fire({title:"¿Deseas generar los conceptos?",html:u,width:"70%",showCancelButton:t,cancelButtonText:t?"No, cancelar":"Cerrar",showConfirmButton:t,confirmButtonText:"Sí, generar"});n&&await ejecutarGeneracionConceptos()}}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}})});