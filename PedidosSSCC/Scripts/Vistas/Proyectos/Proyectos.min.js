function inicializarDataTable(){$("#tblProyectos").DataTable({columns:[{data:"PRY_Id"},{data:"PRY_Nombre"},{data:"TareaNombre"},{className:"dt-center ico-status",data:null,title:"Imputable",orderable:!1,render:function(n,t,i){return`<input type="checkbox" class="form-check-input"
                            data-id="${i.PRY_Id}" disabled
                            ${i.PRY_Imputable?"checked":""} />`}},{className:"dt-center ico-status",data:null,title:"Activo",orderable:!1,render:function(n,t,i){return`<input type="checkbox" class="form-check-input"
                            data-id="${i.PRY_Id}" disabled
                            ${i.PRY_Activo?"checked":""} />`}},{data:null,orderable:!1,searchable:!1,render:function(n,t,i){return`
                        <button class="btn btn-icon btn-editar btn-outline-secondary" data-id="${i.PRY_Id}" title="Editar">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-icon btn-eliminar btn-outline-secondary" data-id="${i.PRY_Id}" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>`}}],language:{url:AppConfig.urls.DataTablesLang}});$("#tblProyectos tbody").on("click",".btn-editar",function(){let n=$(this).data("id");editarProyecto(n)});$("#tblProyectos tbody").on("click",".btn-eliminar",function(){let n=$(this).data("id");eliminarProyecto(n)})}function cargarTablaProyectos(){return new Promise(n=>{$.ajax({url:AppConfig.urls.GetProyectos,type:"GET",success:function(t){if(t&&t.length>=0){let i=$("#tblProyectos").DataTable();i.clear();i.rows.add(t);i.draw();setTimeout(()=>{n()},0)}else n()},error:function(t,i,r){console.error("Error al cargar proyectos:",r);alert("No se pudieron cargar los proyectos.");n()}})})}function cargarComboTareas(){const n=[Tipo.POR_HORAS];$.ajax({url:AppConfig.urls.ObtenerTareasCombo,type:"GET",data:{listaTiposTarea:n},traditional:!0,success:function(n){let t='<option value="">Seleccione Tarea<\/option>';n.forEach(n=>{t+=`<option value="${n.TAR_Id}">${n.TAR_Nombre}</option>`});$("#PRY_TAR_Id").html(t)},error:function(){alert("Error al cargar las tareas.")}})}async function cargarSelectDepartamentos(){try{const t=await fetch(`${AppConfig.urls.GetDepartamentos}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),i=await t.json(),n=$("#PRY_Departamentos");n.empty();i.forEach(t=>{const i=new Option(t.DEP_Nombre,t.DEP_Id,t.selected,t.selected);n.append(i)});n.trigger("change")}catch(n){registrarErrorjQuery("fetch",n.message)}}function InicializarSelectDepartamentos(){if(!$.fn.select2){console.error("Select2 no está disponible");return}let n=$("#PRY_Departamentos");if(n.length===0){console.error("El select #PRY_Departamentos no está en el DOM");return}n.select2({placeholder:"",allowClear:!0,multiple:!0,dropdownParent:$("#modalProyecto"),width:"100%"})}function cargarComboEmpresas(){$.ajax({url:AppConfig.urls.GetEmpresas,type:"GET",success:function(n){listaEmpresasGlobal=n},error:function(){alert("Error al cargar las empresas.")}})}function agregarFilaEmpresa(n=null,t=""){let r=$("<tr><\/tr>"),i='<select class="form-select selectEmpresa" required>';i+='<option value="">-- Seleccionar --<\/option>';listaEmpresasGlobal.forEach(t=>{i+=n!==null&&n==t.EMP_Id?`<option value="${t.EMP_Id}" selected>${t.EMP_Nombre}</option>`:`<option value="${t.EMP_Id}">${t.EMP_Nombre}</option>`});i+="<\/select>";r.append(`<td>${i}</td>`);let u=t!==""?t:100;r.append(`<td><input type="number" class="form-control inputPorcentaje" min="0" max="100" step="0.01" value="${u}" required></td>`);r.append(`<td><button type="button" class="btn btn-icon btnEliminarEmpresa btn-danger">
        <i class="bi bi-trash" title="Eliminar"></i>
        </button></td>`);$("#tblEmpresasProyecto tbody").append(r)}function limpiarFormulario(){$("#PRY_Id").val(0);$("#PRY_Nombre").val("");$("#PRY_TAR_Id").val("");$("#PRY_Imputable").prop("checked",!0);$("#PRY_Activo").prop("checked",!0);$("#PRY_Departamentos").val(null).trigger("change");$("#tblEmpresasProyecto tbody").empty()}function editarProyecto(n){$.ajax({url:AppConfig.urls.GetProyecto,data:{id:n},type:"GET",success:function(n){if(n&&n.success){let t=n.proyecto;$("#modalProyectoLabel").text("Editar Proyecto");$("#PRY_Id").val(t.PRY_Id);$("#PRY_Nombre").val(t.PRY_Nombre);$("#PRY_TAR_Id").val(t.PRY_TAR_Id);$("#PRY_Imputable").prop("checked",t.PRY_Imputable);$("#PRY_Activo").prop("checked",t.PRY_Activo);$("#PRY_Departamentos").val(t.Departamentos).trigger("change");$("#tblEmpresasProyecto tbody").empty();t.Empresas.forEach(function(n){agregarFilaEmpresa(n.PRE_EMP_Id,n.PRE_Porcentaje)});$("#modalProyecto").modal("show")}else alert("No se encontró el proyecto solicitado.")},error:function(){alert("Error al cargar los datos del proyecto.")}})}function eliminarProyecto(n){confirm("¿Estás seguro de eliminar este proyecto? Esta acción no se puede deshacer.")&&$.ajax({url:AppConfig.urls.DeleteProyecto,data:{id:n},type:"POST",success:function(n){n&&n.success?cargarTablaProyectos():alert("No se pudo eliminar el proyecto.")},error:function(){alert("Error al eliminar el proyecto.")}})}function guardarProyecto(){if(!$("#formProyecto")[0].checkValidity()){$("#formProyecto")[0].reportValidity();return}let t={PRY_Id:parseInt($("#PRY_Id").val())||0,PRY_Nombre:$("#PRY_Nombre").val(),PRY_TAR_Id:parseInt($("#PRY_TAR_Id").val()),PRY_Imputable:$("#PRY_Imputable").is(":checked"),PRY_Activo:$("#PRY_Activo").is(":checked"),Departamentos:[],Empresas:[]},i=$("#PRY_Departamentos").val();i&&i.length>0&&i.forEach(function(n){let i=parseInt(n);isNaN(i)||t.Departamentos.push(i)});$("#tblEmpresasProyecto tbody tr").each(function(){let n=parseInt($(this).find(".selectEmpresa").val()),i=parseFloat($(this).find(".inputPorcentaje").val());isNaN(n)||isNaN(i)||t.Empresas.push({PRE_PRY_Id:parseInt($("#PRY_Id").val()),PRE_EMP_Id:n,PRE_Porcentaje:i})});let n=0;if($("#tblEmpresasProyecto tbody tr").each(function(){const t=parseFloat($(this).find(".inputPorcentaje").val())||0;n+=t}),n=Math.round(n*100)/100,n!==100){alert("La suma de los porcentajes de empresas debe ser exactamente 100.");return}$.ajax({url:AppConfig.urls.SaveProyecto,contentType:"application/json; charset=utf-8",type:"POST",data:JSON.stringify(t),success:function(n){n&&n.success?($("#modalProyecto").modal("hide"),cargarTablaProyectos()):alert("No se pudo guardar el proyecto. Verifica los datos e inténtalo de nuevo.")},error:function(n,t,i){console.error(i);alert("Error al guardar el proyecto.")}})}$(document).ready(async function(){await VerificarSesionActiva(OpcionMenu.Proyectos);inicializarDataTable();cargarComboTareas();InicializarSelectDepartamentos();cargarSelectDepartamentos();cargarComboEmpresas();$("#btnNuevoProyecto").click(function(){limpiarFormulario();$("#modalProyectoLabel").text("Nuevo Proyecto");$("#modalProyecto").modal("show")});$("#formProyecto").submit(function(n){n.preventDefault();guardarProyecto()});$("#btnAgregarEmpresa").click(function(){agregarFilaEmpresa(null,100)});await cargarTablaProyectos();ocultarDivCargando()});let listaEmpresasGlobal=[];$(document).on("click",".btnEliminarEmpresa",function(){$(this).closest("tr").remove()});