function initFilters(){const n=$("#ddlYear"),t=new Date;for(let i=t.getFullYear()-1;i<=t.getFullYear()+1;i++)n.append($("<option>").val(i).text(i));n.val(t.getFullYear());n.change(async()=>{await loadPeriodos(),await loadUsersDept(),await loadPartes()});$("#ddlPeriodo").change(async function(){await loadUsersDept();await loadPartes()});$("#ddlUser").change(async function(){mostrarDivCargando();await loadProjectsDept();await loadPartes();ocultarDivCargando()})}function bindEvents(){$("#btnAddLinea").click(()=>{$("#PPA_Id").val(0),$("#PPA_PRY_Id").val(""),$("#PPA_Descripcion").val(""),$("#modalLineaParteLabel").text("Nueva Línea de Parte"),$("#modalLineaParte").modal("show")});$("#formLineaParte").submit(async function(n){n.preventDefault();await saveParteLinea()});$(document).on("click",".btnEditParte",async function(){const t=$(this).closest("tr"),i=t.data("ppa_id"),n=globalPartes.find(n=>n.PPA_Id===i);n&&(n.PPA_Validado||($("#PPA_Id").val(n.PPA_Id),$("#PPA_PRY_Id").val(n.PPA_PRY_Id),$("#PPA_Descripcion").val(n.PPA_Descripcion),$("#modalLineaParteLabel").text("Editar Línea de Parte"),$("#modalLineaParte").modal("show")))});$(document).on("click",".btnDeleteParte",function(){const n=$(this).data("id");confirm("¿Eliminar esta línea de parte?")&&$.post(window.AppConfig.urls.deleteParte,{PPA_Id:n},async n=>{n.success?await loadPartes():alert(n.message||"No se pudo eliminar la línea de parte.")})});$(document).on("focus",".hour-input:not(.weekend):not(.validated)",function(){const n=$(this);n.val()||(n.data("autoMidnight",!0),n.val("00:00"))});$(document).on("blur",".hour-input:not(.weekend):not(.validated)",function(){const n=$(this);n.data("autoMidnight")&&n.val()==="00:00"&&(n.val(""),n.removeData("autoMidnight"))});$(document).on("change",".hour-input:not(.weekend):not(.validated)",function(){const n=$(this);n.data("autoMidnight")&&n.removeData("autoMidnight");const t=n.val(),i=n.data("date"),u=n.closest("tr").data("ppa_id");let r=0;if(t){const[n,i]=t.split(":").map(n=>parseInt(n,10));r=n+i/60}$.post(window.AppConfig.urls.saveHoraParte,{PPA_Id:u,Fecha:i,Horas:r.toFixed(2).toString().replace(".",",")},t=>{t.success?(n.addClass("bg-success text-white"),setTimeout(()=>{n.removeClass("bg-success text-white"),calcularTotales()},600)):(alert("Error guardando horas para "+i),n.val(""))})});$("#btnValidate").click(function(){$("#modalConfirmValidate").modal("show")});$("#btnConfirmValidate").click(async function(){$("#modalConfirmValidate").modal("hide");const n=$("#btnValidate").prop("disabled",!0).text("Validando…"),t=globalPartes.map(n=>n.PPA_Id);await Promise.all(t.map(n=>$.post(window.AppConfig.urls.validateParte,{PPA_Id:n})));await loadPartes();n.prop("disabled",!1);$("#btnValidate").text("Anular Validaciones")});$("#btnConfirmUnvalidate").click(async function(){$("#modalConfirmValidate").modal("hide");const n=$("#btnValidate").prop("disabled",!0).text("Anulando…"),t=globalPartes.map(n=>n.PPA_Id);await Promise.all(t.map(n=>$.post(window.AppConfig.urls.unvalidateParte,{PPA_Id:n})));await loadPartes();n.prop("disabled",!1);$("#btnValidate").text("Validar")});$(document).on("click",".btnValidateParteIndividual",async function(){if(confirm("¿Confirmas que deseas validar esta línea de parte?")){const n=$(this).data("id");await $.post(window.AppConfig.urls.validateParte,{PPA_Id:n});await loadPartes()}});$(document).on("click",".btnUnvalidateParteIndividual",async function(){if(confirm("¿Confirmas que deseas anular la validación de esta línea?")){const n=$(this).data("id");await $.post(window.AppConfig.urls.unvalidateParte,{PPA_Id:n});await loadPartes()}});$("#btnPrevisualizarConceptosHoras").click(async()=>{const n=+$("#ddlYear").val(),t=+$("#ddlPeriodo").val();if(!n||!t){await Swal.fire({title:"Seleccione Año y Periodo",html:`<p>Debe elegir un año y un periodo válidos antes de previsualizar.</p>`,icon:"warning",confirmButtonText:"Entendido"});return}mostrarDivCargando();try{const o=+($("#ddlUser").val()||0),e=window.isResponsable?null:o||null,f=await $.ajax({url:window.AppConfig.urls.previsualizarConceptosHoras,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify({anio:n,mes:t,userId:e})});if(ocultarDivCargando(),!f.success){await Swal.fire({icon:"error",title:"Error al previsualizar",html:`<div class="text-start">${f.mensaje}</div>`,confirmButtonText:"Entendido"});return}const{partesPreview:i,partesErrors:r}=f;if((!i||i.length===0)&&(!r||r.length)){await Swal.fire({title:"Nada que Previsualizar",html:`<p>No hay conceptos de horas pendientes.</p>`,icon:"info",confirmButtonText:"Entendido",width:500});return}let u="";r&&r.length&&(u=`
                  <div class="alert alert-warning">
                    <ul>
                      ${r.map(n=>`<li>${n}</li>`).join("")}
                    </ul>
                  </div>
                `);i&&i.length!==0?u+=generarResumenPorConcepto(i):u=`<p>No hay horas validadas para previsualizar.</p>`;const{isConfirmed:s}=await Swal.fire({title:"Previsualizar Conceptos Horas",html:`<div class="small text-start">
                         <h5>Partes de Horas</h5>
                         ${u}
                       </div>`,width:"80%",showCancelButton:!0,cancelButtonText:"Cerrar",confirmButtonText:"Generar Conceptos",icon:"info"});s&&await generarConceptosHoras(n,t,e)}catch(i){ocultarDivCargando();registrarErrorjQuery(i.status,i.message)}})}async function loadInitialData(){await loadPeriodos();await loadUsersDept();await loadProjectsDept();await loadPartes()}async function loadPeriodos(){const n=+$("#ddlYear").val();return new Promise(t=>{$.get(window.AppConfig.urls.getPeriodos,{anyo:n},n=>{globalPeriodos=n;const i=$("#ddlPeriodo").empty();if(i.append($("<option>").val("").text("-- Seleccionar --")),globalPeriodos.forEach(n=>{const f=n.PEP_Mes,u=new Date(n.PEP_Anyo,f-1).toLocaleString("default",{month:"long"}),e=u.charAt(0).toUpperCase()+u.slice(1),t=new Date(n.PEP_FechaInicio),o=t.getDate().toString().padStart(2,"0"),s=(t.getMonth()+1).toString().padStart(2,"0"),h=t.getFullYear(),c=`${o}/${s}/${h}`,r=new Date(n.PEP_FechaFin),l=r.getDate().toString().padStart(2,"0"),a=(r.getMonth()+1).toString().padStart(2,"0"),v=r.getFullYear(),y=`${l}/${a}/${v}`,p=`${e} (${c} → ${y})`;i.append($("<option>").val(n.PEP_Mes).text(p))}),globalPeriodos.length>0){const n=globalPeriodos[globalPeriodos.length-1].PEP_Mes;i.val(n)}t()})})}async function loadProjectsDept(){const n=+($("#ddlUser").val()||0);return new Promise(t=>{$.get(window.AppConfig.urls.getProjectsDept,{userId:n||null},n=>{globalProjects=n;const i=$("#PPA_PRY_Id").empty();i.append($("<option>").val("").text("-- Seleccionar --"));globalProjects.forEach(n=>{i.append($("<option>").val(n.PRY_Id).text(n.PRY_Nombre))});t()})})}async function loadPartes(){const t=+$("#ddlYear").val(),n=+$("#ddlPeriodo").val(),i=+($("#ddlUser").val()||0);if(!n){$("#tblParte thead tr").empty();$("#tblParte tbody").empty();return}return new Promise(r=>{$.get(window.AppConfig.urls.getPartes,{anyo:t,mes:n,userId:i||null},async t=>{globalPartes=t,await renderTable(globalPeriodos.find(t=>t.PEP_Mes===n)),toggleValidateAndAddButtons(),r()})})}function toggleValidateAndAddButtons(){const t=globalPartes.length>0&&globalPartes.every(n=>n.PPA_Validado),r=globalPartes.some(n=>n.ConceptoGenerado);$("#btnAddLinea").toggle(!t);const n=$("#btnValidate"),i=$("#ddlUser"),u=+i.val()||null,f=i.find("option:selected").data("dep");u!==window.currentUserId||window.responsableDeps.includes(f)?t?(n.prop("disabled",r),n.text("Anular Validaciones").off("click").on("click",()=>{$("#modalConfirmTexto").text("¿Anular validación de todas las líneas?"),$("#btnConfirmValidate").addClass("d-none"),$("#btnConfirmUnvalidate").removeClass("d-none"),$("#modalConfirmValidate").modal("show")}).show()):(n.prop("disabled",!1),n.text("Validar").off("click").on("click",()=>{$("#modalConfirmTexto").text("¿Validar todas las líneas?"),$("#btnConfirmUnvalidate").addClass("d-none"),$("#btnConfirmValidate").removeClass("d-none"),$("#modalConfirmValidate").modal("show")}).show()):n.hide()}async function renderTable(n){if(n){const f=new Date(n.PEP_FechaInicio),e=new Date(n.PEP_FechaFin),i=[];for(let n=new Date(f);n<=e;n.setDate(n.getDate()+1))i.push(new Date(n));const r=$("#tblParte"),t=r.find("thead tr").empty(),o=r.find("tbody").empty();t.append('<th style="min-width:50px; width:50px;"><\/th>');t.append('<th style="min-width:200px; max-width:200px;">Proyecto<\/th>');t.append('<th style="min-width:150px; max-width:150px; padding-left:35px!important;">Actividad<\/th>');i.forEach(n=>{const i=n.getDay(),r=["D","L","M","X","J","V","S"][i],u=n.getDate(),f=i===0||i===6?"weekend":"";t.append(`<th class="${f} text-center" style="min-width:60px;">${r}–${u}</th>`)});t.append('<th class="text-center" style="min-width:75px;">Total<\/th>');const u=[];globalPartes.forEach(n=>{const t=$("<tr>").attr("data-ppa_id",n.PPA_Id);let r;const e=n.UserDeptId,f=window.responsableDeps.includes(e),s=n.ConceptoGenerado,h=n.PPA_Validado;r=h?!s&&f?`
                  <button class="btn-action btn btn-outline-secondary btnUnvalidateParteIndividual"
                          data-id="${n.PPA_Id}" title="Anular Validación">
                    <i class="bi bi-x-circle"></i>
                  </button>`:`<i class="bi bi-check-circle-fill text-success"></i>`:f?`
                  <button class="btn-action btn btn-outline-success btnValidateParteIndividual"
                          data-id="${n.PPA_Id}" title="Validar">
                    <i class="bi bi-check-circle"></i>
                  </button>
                  <button class="btn-action btn btn-outline-primary btnEditParte"
                          data-id="${n.PPA_Id}" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn-action btn btn-outline-danger btnDeleteParte"
                          data-id="${n.PPA_Id}" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>`:`
                  <button class="btn-action btn btn-outline-primary btnEditParte"
                          data-id="${n.PPA_Id}" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn-action btn btn-outline-danger btnDeleteParte"
                          data-id="${n.PPA_Id}" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>`;t.append(`<td class="p-1 text-center">${r}</td>`);const c=globalProjects.find(t=>t.PRY_Id===n.PPA_PRY_Id)||{},l=c.PRY_Nombre||"";t.append(`<td class="proj-name align-middle p-1">${l}</td>`);t.append(`<td class="align-middle p-1" 
                 style="padding-left:35px!important;" 
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top" 
                 title="${n.PPA_Descripcion}">
                 ${n.PPA_Descripcion}
            </td>`);i.forEach(i=>{const o=i.toISOString().substring(0,10),u=i.getDay(),r=u===0||u===6;let f=r?"hour-input weekend":"hour-input",e=r?"disabled":"";n.PPA_Validado&&(f="hour-input validated",e="disabled");t.append(`
                <td class="${r?"weekend":""} p-1 text-center">
                    <input type="time"
                        class="form-control form-control-sm ${f}"
                        data-date="${o}"
                        value=""
                        ${e} />
                </td>`)});t.append(`<td class="row-total align-middle text-center">00:00</td>`);o.append(t);u.push(loadHorasPorParte(n.PPA_Id,i,n.PPA_Validado))});await Promise.all(u);calcularTotales()}}function loadHorasPorParte(n,t,i){return new Promise(t=>{$.get(window.AppConfig.urls.getHorasParte,{PPA_Id:n},r=>{r.forEach(t=>{const r=parseFloat(t.PPH_Horas),u=Math.floor(r),e=Math.round((r-u)*60),o=u.toString().padStart(2,"0"),s=e.toString().padStart(2,"0"),h=`${o}:${s}`,c=`tr[data-ppa_id="${n}"] input[data-date="${t.Fecha}"]`,f=$(c);f.val(h);i&&f.addClass("validated")}),t()})})}async function saveParteLinea(){const n={PPA_Id:parseInt($("#PPA_Id").val(),10),PPA_PEP_Anyo:+$("#ddlYear").val(),PPA_PEP_Mes:+$("#ddlPeriodo").val(),PPA_PRY_Id:+$("#PPA_PRY_Id").val(),PPA_PER_Id:+$("#ddlUser").val(),PPA_Descripcion:$("#PPA_Descripcion").val().trim(),PPA_Validado:!1};if(!n.PPA_PRY_Id||!n.PPA_Descripcion){alert("Debe indicar proyecto y descripción.");return}$.post(window.AppConfig.urls.saveParte,n,async n=>{n.success?($("#modalLineaParte").modal("hide"),await loadPartes()):alert(n.message||"Error al guardar la línea de parte.")})}function calcularTotales(){const n=$("#tblParte");n.find("tbody tr").each(function(){let n=0;$(this).find("input.hour-input").each(function(){const t=$(this).val();if(t){const[i,r]=t.split(":").map(n=>parseInt(n,10));n+=i*60+r}});const t=Math.floor(n/60),i=n%60,r=t.toString().padStart(2,"0"),u=i.toString().padStart(2,"0");$(this).find("td.row-total").html(`<strong>${r}:${u}</strong>`)});n.find("tfoot").remove();const r=$("<tfoot><\/tfoot>"),t=$("<tr><\/tr>");t.append(`
        <td colspan="3" class="text-end pe-2">
            <strong>Totales:</strong>
        </td>`);const u=n.find("thead th").length,f=u-4;let i=0;for(let r=0;r<f;r++){let u=0;n.find("tbody tr").each(function(){const n=$(this).find("td").eq(3+r).find("input.hour-input");if(n.length&&n.val()){const[t,i]=n.val().split(":").map(n=>parseInt(n,10));u+=t*60+i}});i+=u;const f=Math.floor(u/60),e=u%60,o=f.toString().padStart(2,"0"),s=e.toString().padStart(2,"0");t.append(`<td class="text-center"><strong>${o}:${s}</strong></td>`)}const e=Math.floor(i/60),o=i%60,s=e.toString().padStart(2,"0"),h=o.toString().padStart(2,"0");t.append(`<td class="text-center"><strong>${s}:${h}</strong></td>`);r.append(t);n.append(r)}async function generarConceptosHoras(n,t,i){mostrarDivCargando();try{const r=await $.ajax({url:window.AppConfig.urls.generarConceptosHoras,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify({anio:n,mes:t,userId:i})});if(ocultarDivCargando(),r.errors&&r.errors.length){await Swal.fire({icon:"error",title:"Errores generando conceptos horas",html:`<ul style="text-align:left">
                         ${r.errors.map(n=>`<li>${n}</li>`).join("")}
                       </ul>`,confirmButtonText:"Entendido"});return}if(!r.success){mostrarErrorPedidos();return}const u=`
          <div style="text-align:left">
            <h5>Conceptos de Partes de Horas</h5>
            ${generarResumenConceptosPartesFin(r.resultado)}
          </div>`;await Swal.fire({title:"Proceso Completado",html:u,icon:"success"})}catch(r){ocultarDivCargando();registrarErrorjQuery(r.status,r.message)}}function generarResumenPorConcepto(n){const t={};n.forEach(n=>{const i=`${n.TAR_Nombre}|${n.EmpresaNombre}|${n.DepartamentoNombre}`;t[i]||(t[i]={TAR_Nombre:n.TAR_Nombre,EmpresaNombre:n.EmpresaNombre,DepartamentoNombre:n.DepartamentoNombre,TarifaHora:n.TarifaHora,PorcentajeEmpresa:n.PorcentajeEmpresa,Detalles:[]});n.Detalles.forEach(n=>t[i].Detalles.push(n))});let i="";return Object.values(t).forEach(n=>{i+=`
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="background-color: #0092ff !important">
            <span><strong>${n.TAR_Nombre} - ${n.EmpresaNombre} — ${n.DepartamentoNombre}</strong></span>
          </div>
          <div class="card-body p-2">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Persona</th>
                  <th>Proyecto</th>
                  <th>Actividad</th>
                  <th class="text-end">Horas</th>
                  <th class="text-end">Tarifa Tarea</th>
                  <th class="text-end">% Empresa</th>
                  <th class="text-end">Importe</th>
                </tr>
              </thead>
              <tbody>`,n.Detalles.forEach(t=>{i+=`
                <tr>
                  <td>${t.NombreEmpleado}</td>
                  <td>${t.ProyectoNombre}</td>
                  <td>${t.Actividad}</td>
                  <td class="text-end fw-bold">${t.Horas.toFixed(2)}</td>
                  <td class="text-end text-muted">${formatMoney(n.TarifaHora)}</td>
                  <td class="text-end"><span class="badge bg-secondary">${n.PorcentajeEmpresa}%</span></td>
                  <td class="text-end text-success fw-semibold">${formatMoney(t.ImporteParte)}</td>
                </tr>`}),i+=`
              </tbody>
            </table>
          </div>
        </div>`}),i}function formatMoney(n){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(n)}function generarResumenConceptosPartesFin(n){if(!n||!n.length)return"<ul><li><strong>No se ha generado ningún concepto de horas<\/strong><\/li><\/ul>";let t="<ul style='text-align: left;'>";return n.forEach(n=>{t+=`<li><strong>${n.EmpresaNombre}</strong>: ${n.ConceptosCreados} concepto(s) generados</li>`}),t+="<\/ul>"}function formatUserOption(n){if(!n.id)return n.text;const t=parseInt(n.id,10),i=t===window.currentUserId,r=i?'<i class="bi bi-person-badge-fill text-primary me-1"><\/i>':'<i class="bi bi-person-fill me-1"><\/i>';return`${r}${n.text}`}function initUserDropdown(){$("#ddlUser").select2({placeholder:"-- Todos --",width:"300px",templateResult:formatUserOption,templateSelection:formatUserOption,escapeMarkup:n=>n})}async function loadUsersDept(){if($("#ddlUser").length!==0){const i=+$("#ddlYear").val(),t=+$("#ddlPeriodo").val();if(!t){$("#ddlUser").empty().append($("<option>").val("").text("-- Todos --"));$("#ddlUser").trigger("change");return}const r=await $.get(window.AppConfig.urls.getUsuariosDept,{anyo:i,mes:t});globalUsers=r;const n=$("#ddlUser").empty().append($("<option>").val("").text("-- Todos --"));globalUsers.forEach(t=>{n.append($("<option>").val(t.PER_Id).text(t.Nombre).data("dep",t.DepartamentoId))});window.currentUserId&&n.val(window.currentUserId.toString());n.trigger("change")}}$(document).ready(async function(){await VerificarSesionActiva(OpcionMenu.ParteHoras);initFilters();bindEvents();await loadInitialData();initUserDropdown();ocultarDivCargando()});let globalPeriodos=[],globalUsers=[],globalProjects=[],globalPartes=[];