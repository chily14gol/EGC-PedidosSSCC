function disableSubTabs(){$("#tab-empresas, #tab-tarifas, #tab-reparto").addClass("disabled").removeAttr("data-bs-toggle").attr("aria-disabled","true")}function enableSubTabs(){$("#tab-empresas, #tab-tarifas").removeClass("disabled").attr("data-bs-toggle","tab").removeAttr("aria-disabled")}$(document).ready(function(){async function s(){try{await VerificarSesionActiva(OpcionMenu.Aplicaciones);await h();ocultarDivCargando();v();y();disableSubTabs();$("#modalModulos").on("show.bs.modal",function(){const n=$(this);n.find("#modulosTab").hide();n.find(".tab-pane").removeClass("show active");n.find("#content-general").addClass("show active")});$("#table").on("click",".btn-modulos",function(){const n=JSON.parse(this.getAttribute("data-app"));$("#modalModulosLabel").text(`Módulos de '${n.APP_Nombre}'`);window.currentAppId=n.APP_Id;o();disableSubTabs();l(n.APP_Id);w();$("#modalModulos").modal("show")})}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}async function h(){return new Promise(n=>{let t=inicializarDataTable("#table",{ajax:{url:AppConfig.urls.ObtenerAplicaciones,type:"GET",dataSrc:"",complete:function(){n()}},columns:[{data:"APP_Nombre",title:"Nombre"},{data:"NombreTarea",title:"Tarea",render:n=>n||"-"},{className:"td-btn",data:null,title:'<span class="sReader">Acción<\/span>',orderable:!1,render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`<div class="btn-group" role="group">
                                <button class="btn btn-icon btn-editar me-2" data-app="${r}" onclick="editarAplicacion(this)">
                                    <i class="bi bi-pencil-square" title="Editar"></i>
                                </button>
                                <button class="btn btn-icon btn-tarifas me-2" data-app="${r}" onclick="verTarifas(this)">
                                    <i class="bi bi-currency-dollar" title="Tarifas"></i>
                                </button>
                                <button class="btn btn-icon btn-modulos me-2" data-app="${r}">
                                    <i class="bi bi-folder" title="Módulos"></i>
                                </button>
                                <button class="btn btn-icon btn-entes me-2" data-app="${r}" onclick="verEntesAplicacion(this)">
                                    <i class="bi bi-people" title="Entidades"></i>
                                </button>
                                <button class="btn btn-icon btn-eliminar me-2" data-app="${r}" onclick="eliminarAplicacion(this)">
                                    <i class="bi bi-trash" title="Eliminar"></i>
                                </button>
                             </div>`}}]},[],"export_aplicaciones");$(window).resize(()=>t.columns.adjust().draw())})}function r(){if(!$.fn.select2){console.error("Select2 no está disponible");return}let n=$("#tiposEnte");if(n.length===0){console.error("El select #tiposEnte no está en el DOM");return}n.select2({placeholder:"",allowClear:!0,multiple:!0,dropdownParent:$("#modalEditar"),width:"100%"})}function u(n=false){const t=$("#tiposEnte");n&&t.find("option").remove().end().append('<option value=""><\/option>');t.val(null).trigger("change")}async function c(n){try{const i=await fetch(`${AppConfig.urls.ObtenerTiposEntePorAplicacion}?idAplicacion=${n}`,{method:"GET",headers:{"Content-Type":"application/json; charset=utf-8"}}),r=await i.json(),t=$("#tiposEnte");t.empty();r.forEach(n=>{const i=new Option(n.text,n.id,n.selected,n.selected);t.append(i)});t.trigger("change")}catch(t){registrarErrorjQuery("fetch",t.message)}}function f(n){let t=inicializarDataTable("#tableTarifas",{paging:!1,searching:!1,info:!1,ordering:!1,dom:"t",ajax:{url:AppConfig.urls.ObtenerAplicacionesTarifas,type:"GET",data:{idAplicacion:n},dataSrc:""},columns:[{data:"APT_FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"APT_FechaFin",title:"Fecha Fin",render:formatDateToDDMMYYYY},{data:"APT_PrecioUnitario",title:"Importe Unitario",className:"dt-type-numeric-with-decimal",render:function(n){return formatMoney(n)}},{className:"td-btn",data:null,title:"",orderable:!1,render:(n,t,i)=>{const r=JSON.stringify(i).replace(/"/g,"&quot;");return`
                            <button class="btn btn-icon btn-sm me-1" onclick="editTarifa(${r})">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-icon btn-sm" data-tarifa="${r}" onclick="eliminarTarifa(this)">
                              <i class="bi bi-trash" title="Eliminar"></i>
                            </button>`}}]});$(window).resize(()=>t.columns.adjust().draw())}function n(){$("#tarifaFechaInicio, #tarifaFechaFin").val("").prop("disabled",!1);$("#tarifaPrecio").val("");$("#formTarifas").hide();$("#btnGuardarTarifa").hide()}function e(){$("#btnNuevaTarifa").show();$("#btnCancelarTarifa").hide();$("#btnGuardarTarifa").hide();$("#formTarifas").hide()}function o(){$("#idModulo, #moduloNombre, #tareaModulo").val("");$("#formModEmpresas")[0].reset();$("#formModTarifas")[0].reset()}function l(n){$.fn.dataTable.isDataTable("#tableModulos")&&$("#tableModulos").DataTable().destroy();$("#tableModulos").DataTable({ajax:{url:AppConfig.urls.ObtenerAplicacionesModulos,data:{idAplicacion:n},dataSrc:""},columns:[{data:"APM_Nombre",title:"Módulo"},{data:"TareaNombre",title:"Tarea"},{data:null,orderable:!1,className:"td-btn",render:(n,t,i)=>`<div class="btn-group" role="group">
                            <button type="button" class="btn btn-icon me-2" onclick="editModulo(${i.APM_Id},'${i.APM_Nombre.replace(/'/g,"\\'")}', ${i.APM_TAR_Id})">
                                <i class="bi bi-pencil-square"></i>
                             </button>
                             <button type="button" class="btn btn-icon me-2" onclick="delModulo(${i.APM_Id})">
                                <i class="bi bi-trash"></i>
                             </button>
                         </div>`}],paging:!1,searching:!1,info:!1,dom:"t"})}function t(n){$.fn.dataTable.isDataTable("#tableEmpresas")&&$("#tableEmpresas").DataTable().destroy();$("#tableEmpresas").DataTable({ajax:{url:AppConfig.urls.ObtenerModulosEmpresas,data:{idModulo:n},dataSrc:""},columns:[{data:"EmpresaNombre",title:"Empresa"},{data:"AME_FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"AME_FechaFin",title:"Fecha Fin",render:formatDateToDDMMYYYY},{data:"AME_ImporteMensual",title:"Imp. Mensual",render:n=>formatMoney(n)},{data:"AME_PorcentajeReparto",title:"% Reparto",render:n=>formatPorcentaje(n)},{data:"AME_DescripcionConcepto",title:"Concepto"},{data:null,orderable:!1,className:"td-btn",responsivePriority:2,render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`<button class="btn btn-icon btn-sm me-1" onclick="editEmpresa(${r})"><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-icon btn-sm" onclick="delEmpresa(${i.AME_Id})"><i class="bi bi-trash"></i></button>`}}],paging:!1,searching:!1,info:!1,dom:"t"})}function i(n){$.fn.dataTable.isDataTable("#tableTarifasModulos")&&$("#tableTarifasModulos").DataTable().destroy();$("#tableTarifasModulos").DataTable({ajax:{url:AppConfig.urls.ObtenerModulosTarifas,data:{idModulo:n},dataSrc:""},columns:[{data:"AMT_FechaInicio",title:"Fecha Inicio",render:formatDateToDDMMYYYY},{data:"AMT_FechaFin",title:"Fecha Fin",render:formatDateToDDMMYYYY},{data:"AMT_ImporteMensualReparto",title:"Importe reparto equitativo",render:n=>formatMoney(n)},{data:"AMT_ImporteMensualRepartoPorcentajes",title:"Importe reparto porcentajes",render:n=>formatMoney(n)},{data:null,orderable:!1,className:"td-btn",render:function(n,t,i){const r=JSON.stringify(i).replace(/"/g,"&quot;");return`<button class="btn btn-icon btn-sm me-1" onclick="editTarifaModulo(${r})"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-icon btn-sm" onclick="delTarifaModulo(${i.AMT_Id})"><i class="bi bi-trash"></i></button>`}}],paging:!1,searching:!1,info:!1,dom:"t"})}function a(n){$.fn.dataTable.isDataTable("#tableEntesAplicacion")&&$("#tableEntesAplicacion").DataTable().destroy();const t=$("#tableEntesAplicacion").DataTable({ajax:{url:AppConfig.urls.ObtenerEntesAplicaciones,type:"GET",data:{idAplicacion:n},dataSrc:""},rowId:n=>`fila-ente-${n.ENL_ENT_Id}`,columns:[{data:"NombreEntidad",title:"Entidad"},{data:"EMP_Nombre",title:"Empresa"},{data:"ENL_FechaInicio",render:formatDateToDDMMYYYY,title:"Fecha Inicio"},{data:"ENL_FechaFin",render:formatDateToDDMMYYYY,title:"Fecha Fin"},{className:"td-btn",data:null,title:"",orderable:!1,render:(n,t,i)=>{const r=JSON.stringify(i).replace(/"/g,"&quot;");return`
                      <button class="btn btn-icon btn-eliminar" data-ente="${r}" onclick="eliminarAplicacionEnte(this)">
                        <i class="bi bi-trash" title="Eliminar"></i>
                      </button>`}}],paging:!1,searching:!0,info:!1,ordering:!1,dom:"frtipB",buttons:[{extend:"excelHtml5",text:"Exportar a Excel",titleAttr:"Exportar a Excel",className:"btn btn-sm btn-success",title:`EntesAplicacion_${(new Date).toISOString().slice(0,10)}`,exportOptions:{columns:[0,1,2]}}]});t.buttons().container().appendTo("#toolbarEntesButtons");$("#filtroTrabajador").off("keyup change").on("keyup change",function(){t.column(0).search(this.value).draw()});$(window).off("resize.dtEntes").on("resize.dtEntes",()=>t.columns.adjust().draw())}async function v(){try{const n=[Tipo.CANTIDAD_FIJA];$.ajax({url:AppConfig.urls.ObtenerComboTareas,type:"GET",dataType:"json",data:{listaTiposTarea:n},traditional:!0,success:function(n){["#tarea","#tareaModulo"].forEach(t=>{const i=$(t).empty().append('<option value="">Seleccione Tarea<\/option>');n.forEach(n=>{i.append(`<option value="${n.TAR_Id}">${n.TAR_Nombre}</option>`)})})},error:function(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}})}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}async function y(){try{const n=await $.ajax({url:AppConfig.urls.ObtenerComboTiposEnte,type:"GET",dataType:"json"}),t=$("#tiposEnte").empty();n.forEach(n=>t.append(`<option value="${n.TEN_Id}">${n.TEN_Nombre}</option>`))}catch(n){registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n))}}async function p(n){try{const i=await $.ajax({url:AppConfig.urls.ObtenerTiposEntePorAplicacion,type:"GET",dataType:"json",data:{idAplicacion:n}}),t=(i||[]).filter(n=>n.selected).map(n=>n.id),r=$("#entidades").empty().append('<option value="">Seleccione entidad<\/option>');if(!t.length){$("#entidades").select2({placeholder:"Sin tipos permitidos",allowClear:!0,dropdownParent:$("#modalEntesAplicacion"),width:"100%"});return}const u=await $.ajax({url:AppConfig.urls.ObtenerEntidadesComboPorTipo,type:"GET",dataType:"json",data:{idTiposEntidad:t},traditional:!0});u.forEach(n=>r.append(`<option value="${n.ENT_Id}">${n.Text}</option>`));$("#entidades").select2({placeholder:"Seleccione entidad",allowClear:!0,dropdownParent:$("#modalEntesAplicacion"),width:"100%"})}catch(t){registrarErrorjQuery(t.status,obtenerMensajeErrorAjax(t))}}function w(){$.getJSON(AppConfig.urls.ObtenerComboEmpresas,n=>{const t=$("#empresas").empty().append('<option value="">Seleccione<\/option>');n.forEach(n=>t.append(`<option value="${n.EMP_Id}">${n.EMP_Nombre}</option>`))})}function b(n){let t="";return n.forEach(n=>{t+=`
<div class="card mb-4 shadow-sm">
  <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #0092ff">
    <div>
      <strong>${n.NombreEmpresa} – ${n.NombreTarea}</strong>
      <small class="text-light ms-3">${n.Anyo}/${n.Mes.toString().padStart(2,"0")}</small>
    </div>
    <div>
      <span class="badge bg-light text-dark fs-6">Importe: ${formatMoney(n.ImporteTotal)}</span>
    </div>
  </div>
  <div class="card-body p-2">`,Array.isArray(n.ListaErrores)&&n.ListaErrores.length>0&&(t+=`
                    <div class="alert alert-warning">
                      <h6>Errores en esta tarea:</h6>
                      <ul>`,n.ListaErrores.forEach(n=>{t+=`<li>${n}</li>`}),t+=`
                      </ul>
                    </div>`),Array.isArray(n.ListaDetallesLicencia)&&n.ListaDetallesLicencia.length&&(t+=`
        <h6>Licencias</h6>
        <table class="table table-sm mb-3">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th>Aplicación</th>
              <th class="text-end">Importe</th>
            </tr>
          </thead>
          <tbody>`,n.ListaDetallesLicencia.forEach(n=>{t+=`
            <tr>
              <td>${n.Origen}</td>
              <td>${n.Aplicacion}</td>
              <td class="text-end text-success fw-semibold">${formatMoney(n.Importe)}</td>
            </tr>`}),t+=`
          </tbody>
        </table>`),Array.isArray(n.ListaDetallesImporteFijo)&&n.ListaDetallesImporteFijo.length&&(t+=`
        <h6>Importe Fijo</h6>
        <table class="table table-sm mb-3">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th class="text-end">Importe</th>
            </tr>
          </thead>
          <tbody>`,n.ListaDetallesImporteFijo.forEach(n=>{t+=`
            <tr>
              <td>${n.Origen}</td>
              <td class="text-end text-success fw-semibold">${formatMoney(n.Importe)}</td>
            </tr>`}),t+=`
          </tbody>
        </table>`),Array.isArray(n.ListaDetallesImporteReparto)&&n.ListaDetallesImporteReparto.length&&(t+=`
        <h6>Importe Reparto</h6>
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th class="text-end">%</th>
              <th class="text-end">Importe</th>
            </tr>
          </thead>
          <tbody>`,n.ListaDetallesImporteReparto.forEach(n=>{t+=`
            <tr>
              <td>${n.Origen}</td>
              <td class="text-end">${(n.Porcentaje*100).toFixed(2)}%</td>
              <td class="text-end text-success fw-semibold">${formatMoney(n.Importe)}</td>
            </tr>`}),t+=`
          </tbody>
        </table>`),t+=`
  </div>
</div>`}),t}async function k(){mostrarDivCargando();try{const n=await $.ajax({url:window.AppConfig.urls.GenerarConceptosAplicaciones,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8"});if(ocultarDivCargando(),!n.success){await Swal.fire({icon:"error",title:"Error generando conceptos",text:n.mensaje,confirmButtonText:"Entendido"});return}const{lineasCreadas:t}=n;await Swal.fire({icon:"success",title:"Conceptos Generados",html:`
        <p>Se han generado <strong>${t}</strong> conceptos.</p>
      `,confirmButtonText:"Cerrar"})}catch(n){ocultarDivCargando();await Swal.fire({icon:"error",title:"Error inesperado",text:n.statusText||n.message,confirmButtonText:"Entendido"})}}s();r();$("#btnNuevo").click(function(){$("#idAplicacion").val(-1);$("#nombre, #tarea").val("");u();$("#modalEditarLabel").text("Nueva Aplicación");$("#modalEditar").modal("show")});$("#modalEntesAplicacion").on("shown.bs.modal",()=>{$("#entidades").focus()});$("#modalEntesAplicacion").on("keydown",n=>{(n.ctrlKey||n.metaKey)&&n.key==="Enter"&&guardarAplicacionEnte()});window.editarAplicacion=function(n){const t=JSON.parse(n.getAttribute("data-app"));r();u();c(t.APP_Id);$("#idAplicacion").val(t.APP_Id);$("#nombre").val(t.APP_Nombre);$("#tarea").val(t.APP_TAR_Id);$("#modalEditarLabel").text("Editar Aplicación");$("#modalEditar").modal("show")};window.eliminarAplicacion=function(n){const t=JSON.parse(n.getAttribute("data-app"));mostrarAlertaConfirmacion({titulo:`¿Eliminar aplicación '${t.APP_Nombre}'?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarAplicacion,type:"POST",contentType:"application/json",data:JSON.stringify({idAplicacion:t.APP_Id}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#table").DataTable().ajax.reload(null,!1)):mostrarToast(n.mensaje,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})};window.guardarAplicacion=async function(){const u=$("#idAplicacion").val(),t=$("#nombre").val(),i=$("#tarea").val();let n=[];if(t?$("#nombre").removeClass("is-invalid"):($("#nombre").addClass("is-invalid"),n.push("Nombre")),i?$("#tarea").removeClass("is-invalid"):($("#tarea").addClass("is-invalid"),n.push("Tarea")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}const f={APP_Id:u,APP_Nombre:t,APP_TAR_Id:i||null,TiposEnte:$("#tiposEnte").val()};try{const n=await $.ajax({url:AppConfig.urls.GuardarAplicacion,type:"POST",contentType:"application/json",data:JSON.stringify(f),dataType:"json"});n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#modalEditar").modal("hide"),$("#table").DataTable().ajax.reload(null,!1)):mostrarToast(n.message||"Error al guardar.",TipoToast.Warning)}catch(r){registrarErrorjQuery(r.status,obtenerMensajeErrorAjax(r))}};$("#btnNuevaTarifa").on("click",function(){n();$("#btnNuevaTarifa").hide();$("#btnCancelarTarifa").show();$("#btnGuardarTarifa").show();$("#formTarifas").slideDown()});$("#btnCancelarTarifa").on("click",function(){e()});window.verTarifas=function(t){const i=JSON.parse(t.getAttribute("data-app"));$("#idAplicacionTarifas").val(i.APP_Id);$("#fechaInicioOriginal, #tarifaFechaInicio, #tarifaFechaFin, #tarifaPrecio").val("");f(i.APP_Id);n();$("#formTarifas").hide();$("#btnNuevaTarifa").show();$("#modalTarifas").modal("show")};window.editTarifa=function(n){$("#fechaInicioOriginal").val(formatDateInputForDateField(n.APT_FechaInicio));$("#tarifaFechaInicio").val(formatDateInputForDateField(n.APT_FechaInicio));$("#tarifaFechaFin").val(n.AMT_FechaFin?formatDateInputForDateField(n.APT_FechaFin):"");$("#tarifaPrecio").val(n.APT_PrecioUnitario);$("#btnNuevaTarifa").hide();$("#btnGuardarTarifa").show();$("#btnCancelarTarifa").show();$("#formTarifas").slideDown()};window.eliminarTarifa=function(n){setTimeout(()=>{const t=JSON.parse(n.getAttribute("data-tarifa"));mostrarAlertaConfirmacion({titulo:`¿Eliminar tarifa con fecha de inicio ${formatDateToDDMMYYYY(t.APT_FechaInicio)}?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarAplicacionTarifa,type:"POST",contentType:"application/json",data:JSON.stringify({idAplicacion:t.APT_APP_Id,fechaInicio:toISODate(t.APT_FechaInicio)}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableTarifas").DataTable().ajax.reload(null,!1)):mostrarToast(n.message,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})},300)};window.guardarTarifa=async function(){const u=parseInt($("#idAplicacionTarifas").val(),10),o=$("#fechaInicioOriginal").val(),r=$("#tarifaFechaInicio").val(),t=$("#tarifaFechaFin").val(),s=$("#tarifaPrecio").val();let i=[];if(r?$("#tarifaFechaInicio").removeClass("is-invalid"):($("#tarifaFechaInicio").addClass("is-invalid"),i.push("Fecha Inicio")),s?$("#tarifaPrecio").removeClass("is-invalid"):($("#tarifaPrecio").addClass("is-invalid"),i.push("Precio")),i.length){mostrarToast(AppConfig.mensajes.camposObligatorios+i.join(", "),TipoToast.Warning);return}if(t&&new Date(t)<new Date(r)){$("#tarifaFechaFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#tarifaFechaFin").removeClass("is-invalid");const h={APT_APP_Id:u,APT_FechaInicio:formatDateToDDMMYYYY(r),APT_FechaFin:t?formatDateToDDMMYYYY(t):null,APT_PrecioUnitario:parseFloat(s)};o&&(h.APT_FechaInicioOriginal=formatDateToDDMMYYYY(o));try{const t=await $.ajax({url:AppConfig.urls.GuardarAplicacionTarifa,type:"POST",contentType:"application/json",data:JSON.stringify(h),dataType:"json"});t.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),n(),e(),f(u),$("#fechaInicioOriginal, #tarifaFechaInicio, #tarifaFechaFin, #tarifaPrecio").val("")):mostrarToast(t.message||"Error al guardar.",TipoToast.Warning)}catch(c){registrarErrorjQuery(c.status,obtenerMensajeErrorAjax(c))}};$("#modalModulos").on("hidden.bs.modal",()=>{$("#btnCancelarModulo").hide(),$("#btnGuardarModulo").hide(),$("#btnNuevoModulo").show(),$("#formModulo").hide(),$("#modulosTab").hide(),$("#lblModuloActual").text(""),disableSubTabs()});window.editModulo=function(n,r,u){enableSubTabs();$("#lblModuloActual").html(`<i class="bi bi-pencil-fill me-1"></i> ${r}`).text(`Editando: ${r}`).show();o();$("#idModulo").val(n);$("#moduloNombre").val(r);$("#tareaModulo").val(u);$("#formModulo").slideDown();$("#modulosTab").slideDown();$("#btnCancelarModulo").show();$("#btnGuardarModulo").show();$("#btnNuevoModulo").hide();$("#tab-general").trigger("click");$("#idModuloEmpresas").val(n);$("#idModuloTarifas").val(n);t(n);i(n)};window.delModulo=function(n){mostrarAlertaConfirmacion({titulo:`¿Eliminar módulo?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarAplicacionModulo,type:"POST",contentType:"application/json",data:JSON.stringify({id:n}),dataType:"json"}).done(n=>{n.success&&$("#tableModulos").DataTable().ajax.reload(null,!1)})}})};window.guardarModulo=function(){const t={APM_Id:parseInt($("#idModulo").val()||0),APM_APP_Id:window.currentAppId,APM_Nombre:$("#moduloNombre").val(),APM_TAR_Id:$("#tareaModulo").val()};let n=[];if(t.APM_Nombre?$("#moduloNombre").removeClass("is-invalid"):($("#moduloNombre").addClass("is-invalid"),n.push("Nombre")),t.APM_TAR_Id?$("#tareaModulo").removeClass("is-invalid"):($("#tareaModulo").addClass("is-invalid"),n.push("Tarea")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}$.ajax({url:AppConfig.urls.GuardarAplicacionModulo,method:"POST",contentType:"application/json",data:JSON.stringify(t),dataType:"json"}).done(n=>{n.success&&($("#formModulo").slideUp(),$("#modulosTab").slideUp(),$("#idModulo").val(""),$("#moduloNombre").val(""),$("#tareaModulo").val(""),$("#btnCancelarModulo").hide(),$("#btnGuardarModulo").hide(),$("#btnNuevoModulo").show(),$("#lblModuloActual").hide(),disableSubTabs(),$("#tableModulos").DataTable().ajax.reload(null,!1))})};$("#btnNuevoModulo").on("click",function(){$("#idModulo, #moduloNombre, #tareaModulo").val("");$("#formModulo .is-invalid").removeClass("is-invalid");$("#modulosTab .is-invalid").removeClass("is-invalid");$("#formModulo").slideDown();$("#modulosTab").slideDown();$("#btnCancelarModulo").show();$("#btnGuardarModulo").show();$("#btnNuevoModulo").hide();disableSubTabs();t(0);i(0)});$("#btnCancelarModulo").on("click",function(){$("#formModulo").slideUp();$("#modulosTab").slideUp();$("#btnCancelarModulo").hide();$("#btnGuardarModulo").hide();$("#btnNuevoModulo").show();$("#lblModuloActual").hide();disableSubTabs();t(0);i(0)});$(function(){function n(){$("#formModEmpresas")[0].reset();$("#idEmpresaOriginal").val("");$("#formModEmpresas .is-invalid").removeClass("is-invalid")}function t(){$("#contenedorFormEmpresas").slideUp(function(){$("#btnNuevaEmpresa").show();$("#btnCancelarEmpresa").hide()})}$("#contenedorFormEmpresas").hide();$("#btnCancelarEmpresa").hide();$("#btnNuevaEmpresa").on("click",function(){n();$(this).hide();$("#btnCancelarEmpresa").show();$("#contenedorFormEmpresas").slideDown()});$("#btnCancelarEmpresa").on("click",function(){t()});window.editEmpresa=function(n){$("#idEmpresaOriginal").val(n.AME_Id);$("#empresas").val(n.AME_EMP_Id);$("#empresaFechaInicio").val(formatDateInputForDateField(n.AME_FechaInicio));$("#empresaFechaFin").val(n.AME_FechaFin?formatDateInputForDateField(n.AME_FechaFin):"");$("#empresaImporte").val(n.AME_ImporteMensual);$("#porcentajeReparto").val(n.AME_PorcentajeReparto??"");$("#empresaDescripcion").val(n.AME_DescripcionConcepto||"");$("#btnNuevaEmpresa").hide();$("#btnCancelarEmpresa").show();$("#contenedorFormEmpresas").slideDown()}});window.delEmpresa=function(n){mostrarAlertaConfirmacion({titulo:"¿Eliminar empresa?",onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarModuloEmpresa,type:"POST",contentType:"application/json",data:JSON.stringify({id:n}),dataType:"json"}).done(n=>{n.success&&$("#tableEmpresas").DataTable().ajax.reload(null,!1)})}})};window.guardarEmpresaModulo=async function(){const f=parseInt($("#empresas").val(),10),i=$("#empresaFechaInicio").val(),t=$("#empresaFechaFin").val(),e=$("#empresaImporte").val(),r=e===""?null:parseFloat(e),o=$("#porcentajeReparto").val(),u=o===""?null:parseFloat(o),h=$("#empresaDescripcion").val();let n=[];if(f?$("#empresas").removeClass("is-invalid"):($("#empresas").addClass("is-invalid"),n.push("Empresa")),i?$("#empresaFechaInicio").removeClass("is-invalid"):($("#empresaFechaInicio").addClass("is-invalid"),n.push("Fecha Inicio")),r===null||isNaN(r)?($("#empresaImporte").addClass("is-invalid"),n.push("Importe Mensual")):$("#empresaImporte").removeClass("is-invalid"),u===null||isNaN(u)?($("#porcentajeReparto").addClass("is-invalid"),n.push("Porcentaje Reparto")):$("#porcentajeReparto").removeClass("is-invalid"),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}if(t&&new Date(t)<new Date(i)){$("#empresaFechaFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#empresaFechaFin").removeClass("is-invalid");const c={AME_Id:parseInt($("#idEmpresaOriginal").val(),10),AME_APM_Id:parseInt($("#idModuloEmpresas").val(),10),AME_EMP_Id:f,AME_FechaInicio:formatDateToDDMMYYYY(i),AME_FechaFin:t?formatDateToDDMMYYYY(t):null,AME_ImporteMensual:r,AME_DescripcionConcepto:h,AME_PorcentajeReparto:u},s=await $.ajax({url:AppConfig.urls.GuardarModuloEmpresa,type:"POST",contentType:"application/json",data:JSON.stringify(c),dataType:"json"});s.success?($("#contenedorFormEmpresas").hide(),$("#btnCancelarEmpresa").hide(),$("#btnNuevaEmpresa").show(),$("#tableEmpresas").DataTable().ajax.reload(null,!1)):mostrarToast(s.message,TipoToast.Warning)};$(function(){function n(){$("#formModTarifas")[0].reset();$("#idTarifaOriginal").val("");$("#formModTarifas .is-invalid").removeClass("is-invalid")}function t(){$("#contenedorFormTarifas").slideUp(function(){$("#btnNuevaTarifaModal").show();$("#btnCancelarTarifaModal").hide()})}$("#contenedorFormTarifas").hide();$("#btnCancelarTarifaModal").hide();$("#btnNuevaTarifaModal").on("click",function(){n();$(this).hide();$("#btnCancelarTarifaModal").show();$("#contenedorFormTarifas").slideDown()});$("#btnCancelarTarifaModal").on("click",function(){t()});window.editTarifaModulo=function(n){$("#idTarifaOriginal").val(n.AMT_Id);$("#tarifaFechaInicioModulo").val(formatDateInputForDateField(n.AMT_FechaInicio));$("#tarifaFechaFinModulo").val(n.AMT_FechaFin?formatDateInputForDateField(n.AMT_FechaFin):"");$("#tarifaImporteReparto").val(n.AMT_ImporteMensualReparto);$("#tarifaImportePorc").val(n.AMT_ImporteMensualRepartoPorcentajes);$("#btnNuevaTarifaModal").hide();$("#btnCancelarTarifaModal").show();$("#contenedorFormTarifas").slideDown()}});window.delTarifaModulo=function(n){mostrarAlertaConfirmacion({titulo:"¿Eliminar tarifa?",onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarModuloTarifa,type:"POST",contentType:"application/json",data:JSON.stringify({id:n}),dataType:"json"}).done(n=>{n.success&&$("#tableTarifasModulos").DataTable().ajax.reload(null,!1)})}})};window.guardarTarifaModulo=function(){const i=$("#tarifaFechaInicioModulo").val(),t=$("#tarifaFechaFinModulo").val(),r=$("#tarifaImporteReparto").val(),u=$("#tarifaImportePorc").val();let n=[];if(i?$("#tarifaFechaInicioModulo").removeClass("is-invalid"):($("#tarifaFechaInicioModulo").addClass("is-invalid"),n.push("Fecha Inicio")),r?$("#tarifaImporteReparto").removeClass("is-invalid"):($("#tarifaImporteReparto").addClass("is-invalid"),n.push("Importe")),u?$("#tarifaImportePorc").removeClass("is-invalid"):($("#tarifaImportePorc").addClass("is-invalid"),n.push("Reparto")),n.length){mostrarToast(AppConfig.mensajes.camposObligatorios+n.join(", "),TipoToast.Warning);return}if(t&&new Date(t)<new Date(i)){$("#tarifaFechaFinModulo").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#tarifaFechaFinModulo").removeClass("is-invalid");const f={AMT_Id:parseInt($("#idTarifaOriginal").val()||0),AMT_APM_Id:parseInt($("#idModuloTarifas").val(),10),AMT_FechaInicio:formatDateToDDMMYYYY(i),AMT_FechaFin:t?formatDateToDDMMYYYY(t):null,AMT_ImporteMensualReparto:parseFloat(r),AMT_ImporteMensualRepartoPorcentajes:parseFloat(u)};$.ajax({url:AppConfig.urls.GuardarModuloTarifa,method:"POST",contentType:"application/json",data:JSON.stringify(f),dataType:"json"}).done(n=>{n.success?($("#contenedorFormTarifas").hide(),$("#btnCancelarTarifaModal").hide(),$("#btnNuevaTarifaModal").show(),$("#tableTarifasModulos").DataTable().ajax.reload(null,!1)):mostrarToast(n.message||"Error al guardar.",TipoToast.Warning)})};window.verEntesAplicacion=function(n){const t=JSON.parse(n.getAttribute("data-app"));$("#idAplicacionEntes").val(t.APP_Id);$("#idEnteOriginal, #entidades, #fechaInicio, #fechaFin").val("");p(t.APP_Id);a(t.APP_Id);$("#modalEntesAplicacion").modal("show")};window.eliminarAplicacionEnte=function(n){setTimeout(()=>{const t=JSON.parse(n.getAttribute("data-ente"));mostrarAlertaConfirmacion({titulo:`¿Eliminar asignación de '${t.NombreEntidad}'?`,onConfirmar:()=>{$.ajax({url:AppConfig.urls.EliminarAplicacionEnte,type:"POST",contentType:"application/json",data:JSON.stringify({idAplicacion:t.ENL_APP_Id,idEnte:t.ENL_ENT_Id,fechaInicio:toISODate(t.ENL_FechaInicio)}),dataType:"json"}).done(n=>{n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#tableEntesAplicacion").DataTable().ajax.reload(null,!1)):mostrarToast(n.message,TipoToast.Warning)}).fail(n=>registrarErrorjQuery(n.status,obtenerMensajeErrorAjax(n)))}})},300)};window.guardarAplicacionEnte=async function(){const o=$("#idAplicacionEntes").val(),r=$("#idEnteOriginal").val(),u=$("#entidades").val(),t=$("#fechaInicio").val(),n=$("#fechaFin").val();let i=[];if(u?$("#entidades").removeClass("is-invalid"):($("#entidades").addClass("is-invalid"),i.push("Entidad")),t?$("#fechaInicio").removeClass("is-invalid"):($("#fechaInicio").addClass("is-invalid"),i.push("Fecha Inicio")),i.length){mostrarToast(AppConfig.mensajes.camposObligatorios,TipoToast.Warning);return}if(n&&new Date(n)<new Date(t)){$("#fechaFin").addClass("is-invalid");mostrarToast("Fecha Fin no puede ser anterior a Fecha Inicio.",TipoToast.Warning);return}$("#fechaFin").removeClass("is-invalid");const f={ENL_APP_Id:parseInt(o),ENL_ENT_Id:parseInt(u),ENL_FechaInicio:formatDateToDDMMYYYY(t),ENL_FechaFin:n?formatDateToDDMMYYYY(n):null};r&&(f.ENL_ENT_IdOriginal=parseInt(r));try{const n=await $.ajax({url:AppConfig.urls.GuardarAplicacionEnte,type:"POST",contentType:"application/json",data:JSON.stringify(f),dataType:"json"});n.success?(mostrarToast(AppConfig.mensajes.operacionOk,TipoToast.Success),$("#idEnteOriginal, #entidades, #fechaInicio, #fechaFin").val(""),$("#tableEntesAplicacion").DataTable().ajax.reload(null,!1)):await Swal.fire({icon:"warning",title:"No se ha guardado",text:n.message||"La entidad ya existe para esas fechas.",confirmButtonText:"Entendido"})}catch(e){registrarErrorjQuery(e.status,obtenerMensajeErrorAjax(e))}};$("#btnPrevisulizarConceptosAplicaciones").click(async()=>{mostrarDivCargando();try{const r=await $.ajax({url:window.AppConfig.urls.PrevisulizarConceptosAplicaciones,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8"});if(ocultarDivCargando(),!r.success){await Swal.fire({icon:"error",title:"Error al previsualizar",html:`<div class="text-start">${r.mensaje}</div>`,confirmButtonText:"Entendido"});return}const{partesPreview:n,partesErrors:t}=r;if((!n||n.length===0)&&(!t||t.length)){await Swal.fire({title:"Nada que Previsualizar",html:`<p>No hay conceptos de aplicaciones pendientes.</p>`,icon:"info",confirmButtonText:"Entendido",width:500});return}let i="";t&&t.length&&(i=`
                  <div class="alert alert-warning">
                    <ul>
                      ${t.map(n=>`<li>${n}</li>`).join("")}
                    </ul>
                  </div>
                `);n&&n.length!==0?i+=b(n):i=`<p>No hay aplicaciones válidas para previsualizar.</p>`;const{isConfirmed:u}=await Swal.fire({title:"Previsualizar Conceptos de Aplicaciones",html:`<div class="small text-start">
                         <h5>Aplicaciones</h5>
                         ${i}
                       </div>`,width:"80%",showCancelButton:!0,cancelButtonText:"Cerrar",confirmButtonText:"Generar Conceptos",icon:"info"});u&&await k()}catch(n){ocultarDivCargando();registrarErrorjQuery(n.status,n.message)}})});